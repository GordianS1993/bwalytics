<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BWA Insights - Smart Business Analytics</title>
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Supabase Client SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Supabase Konfiguration (wird nach Setup erstellt) -->
    <script src="supabase-config.js" onerror="console.log('‚ÑπÔ∏è supabase-config.js nicht gefunden - Gast-Modus aktiv')"></script>
    
    <!-- Stripe.js SDK f√ºr Zahlungsabwicklung -->
    <script src="https://js.stripe.com/v3/"></script>
    
    <!-- Stripe Konfiguration (wird nach Setup erstellt) -->
    <script src="stripe-config.js" onerror="console.log('‚ÑπÔ∏è stripe-config.js nicht gefunden - Zahlungen deaktiviert')"></script>
    
    <style>
        /* Professionelles Design System */
        :root {
            /* Haupt-Farbpalette */
            --color-primary: #1e40af;        /* Professionelles Dunkelblau */
            --color-primary-light: #3b82f6;   /* Helleres Blau */
            --color-primary-dark: #1e3a8a;    /* Dunkleres Blau */
            
            /* Sekund√§rfarben */
            --color-secondary: #64748b;       /* Ged√§mpftes Grau-Blau */
            --color-accent: #0ea5e9;          /* Akzent-Cyan */
            
            /* Neutrale Farben */
            --color-gray-50: #f8fafc;
            --color-gray-100: #f1f5f9;
            --color-gray-200: #e2e8f0;
            --color-gray-300: #cbd5e1;
            --color-gray-400: #94a3b8;
            --color-gray-500: #64748b;
            --color-gray-600: #475569;
            --color-gray-700: #334155;
            --color-gray-800: #1e293b;
            --color-gray-900: #0f172a;
            
            /* Status-Farben */
            --color-success: #059669;
            --color-warning: #d97706;
            --color-error: #dc2626;
            --color-info: #0284c7;
            
            /* Typografie */
            --font-family-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            --font-family-display: 'Inter', sans-serif;
            
            /* Schatten */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            
            /* Border Radius */
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* ============================================
           PREMIUM FEATURE-GATING STYLES
           ============================================ */
        
        .premium-locked {
            position: relative;
            pointer-events: none;
            user-select: none;
        }

        .premium-locked .content {
            filter: blur(8px);
            opacity: 0.4;
        }

        .premium-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(30, 64, 175, 0.95) 0%, rgba(59, 130, 246, 0.95) 100%);
            border-radius: 12px;
            padding: 40px;
            z-index: 10;
            pointer-events: all;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .premium-overlay:hover {
            background: linear-gradient(135deg, rgba(30, 64, 175, 0.98) 0%, rgba(59, 130, 246, 0.98) 100%);
            transform: scale(1.02);
        }

        .premium-badge {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: #78350f;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
            margin-bottom: 16px;
        }

        .premium-overlay h2 {
            color: white;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 12px;
            text-align: center;
        }

        .premium-overlay p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1rem;
            text-align: center;
            margin-bottom: 24px;
            line-height: 1.6;
        }

        .premium-features {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            width: 100%;
            max-width: 400px;
        }

        .premium-features ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .premium-features li {
            color: white;
            padding: 8px 0;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .premium-features li::before {
            content: "‚úì";
            display: inline-block;
            width: 24px;
            height: 24px;
            background: #10b981;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .premium-price {
            font-size: 2.5rem;
            font-weight: 700;
            color: white;
            margin-bottom: 24px;
        }

        .premium-price small {
            font-size: 1rem;
            font-weight: 400;
            opacity: 0.8;
        }

        .upgrade-button {
            background: white;
            color: #1e40af;
            padding: 16px 40px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(255, 255, 255, 0.3);
            transition: all 0.2s ease;
        }

        .upgrade-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(255, 255, 255, 0.4);
        }

        .login-prompt-button {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 16px 40px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
            transition: all 0.2s ease;
        }

        .login-prompt-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(16, 185, 129, 0.4);
        }

        body {
            font-family: var(--font-family-sans);
            background: var(--color-gray-50);
            display: flex;
            min-height: 100vh;
            color: var(--color-gray-900);
            font-size: 15px;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Sidebar - Professionell */
        .sidebar {
            width: 280px;
            background: var(--color-gray-900);
            color: white;
            position: fixed;
            height: 100vh;
            left: 0;
            top: 0;
            overflow-y: auto;
            z-index: 1000;
            border-right: 1px solid var(--color-gray-800);
        }

        .sidebar-header {
            padding: 36px 24px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-header h2 {
            font-size: 20px;
            font-weight: 700;
            color: white;
            letter-spacing: -0.5px;
            margin: 8px 0 4px 0;
        }

        .sidebar-header p {
            font-size: 13px;
            color: var(--color-gray-500);
            margin-top: 4px;
            font-weight: 400;
        }

        .user-profile {
            display: block;
            padding: 28px 24px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.03);
        }

        .user-avatar {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 20px;
            margin: 0 auto 16px;
            color: white;
            box-shadow: 0 4px 12px rgba(30, 64, 175, 0.3);
        }

        .user-info {
            text-align: center;
        }

        .user-info h4 {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 6px;
            color: white;
            line-height: 1.4;
        }

        .user-info p {
            font-size: 13px;
            color: var(--color-gray-400);
            margin-top: 4px;
        }

        .nav-menu {
            list-style: none;
            padding: 20px 16px;
        }

        .nav-item {
            margin-bottom: 6px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 14px 18px;
            color: var(--color-gray-300);
            text-decoration: none;
            transition: all 0.2s ease;
            cursor: pointer;
            border-radius: var(--radius-md);
            font-size: 14.5px;
            font-weight: 500;
        }

        .nav-link:hover {
            background: rgba(255,255,255,0.08);
            color: white;
        }

        .nav-link.active {
            background: var(--color-primary);
            color: white;
        }

        .nav-link i {
            margin-right: 12px;
            width: 20px;
            text-align: center;
            font-size: 16px;
        }

        /* Main Content */
        .main-content {
            margin-left: 280px;
            flex: 1;
            padding: 32px;
            background: var(--color-gray-50);
            min-height: 100vh;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-bottom: 1px solid var(--color-gray-200);
            padding: 32px 40px;
            margin-bottom: 32px;
            border-radius: var(--radius-xl);
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 8px;
            font-weight: 700;
            color: var(--color-gray-900);
            letter-spacing: -1px;
        }

        .header p {
            color: var(--color-gray-600);
            font-size: 15px;
        }

        .content {
            padding: 0;
        }

        .upload-section {
            margin-bottom: 32px;
        }

        .upload-zone {
            border: 2px dashed var(--color-gray-300);
            border-radius: var(--radius-xl);
            padding: 60px 40px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .upload-zone:hover {
            background: var(--color-gray-50);
            border-color: var(--color-primary);
        }

        .upload-zone.dragover {
            background: #eff6ff;
            border-color: var(--color-primary);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 20px;
            color: var(--color-gray-400);
        }

        .upload-text h2 {
            color: var(--color-gray-900);
            margin-bottom: 12px;
            font-size: 24px;
            font-weight: 600;
        }

        .upload-text p {
            color: var(--color-gray-600);
            font-size: 15px;
            margin-bottom: 24px;
        }

        .upload-info {
            display: flex;
            justify-content: center;
            gap: 32px;
            margin-top: 24px;
        }

        .upload-info div {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--color-gray-500);
            font-size: 14px;
        }

        .progress-container {
            display: none;
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: var(--radius-xl);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--color-gray-200);
            border-radius: 999px;
            overflow: hidden;
            margin: 24px 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--color-primary);
            width: 0%;
            transition: width 0.3s ease;
        }

        .success-container {
            display: none;
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: var(--radius-xl);
        }

        .dashboard {
            display: none;
            margin-top: 32px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .metric-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 24px;
            text-align: center;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--color-gray-200);
            transition: all 0.2s ease;
        }

        .metric-card:hover {
            box-shadow: var(--shadow-md);
        }

        .metric-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .metric-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .metric-label {
            color: var(--color-gray-600);
            font-size: 14px;
            font-weight: 500;
        }

        .chart-container {
            background: white;
            border-radius: var(--radius-xl);
            padding: 32px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 24px;
            border: 1px solid var(--color-gray-200);
        }

        .chart-container h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin-bottom: 20px;
        }

        .history-section {
            margin-top: 32px;
        }

        .history-section h2 {
            font-size: 20px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin-bottom: 16px;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--color-gray-200);
        }

        .history-table th,
        .history-table td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid var(--color-gray-200);
            font-size: 14px;
        }

        .history-table th {
            background: var(--color-gray-50);
            font-weight: 600;
            color: var(--color-gray-700);
        }

        .history-table tbody tr:last-child td {
            border-bottom: none;
        }

        .history-table tbody tr:hover {
            background: var(--color-gray-50);
        }

        .btn {
            padding: 10px 20px;
            border-radius: var(--radius-md);
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin: 0 4px;
            transition: all 0.2s ease;
            font-family: var(--font-family-sans);
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-primary-dark);
        }

        .btn-danger {
            background: var(--color-error);
            color: white;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .notification {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 16px 24px;
            border-radius: var(--radius-lg);
            color: white;
            font-weight: 500;
            font-size: 14px;
            box-shadow: var(--shadow-xl);
            z-index: 9999;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.success {
            background: var(--color-success);
        }

        .notification.error {
            background: var(--color-error);
        }

        .notification.warning {
            background: var(--color-warning);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .modal-dialog {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <!-- Professionelles BWA-Logo -->
            <svg width="48" height="48" viewBox="0 0 48 48" fill="none" style="margin-bottom: 12px;">
                <!-- √Ñu√üerer Kreis mit Gradient -->
                <circle cx="24" cy="24" r="22" fill="url(#logoGradient)"/>
                <!-- Stilisiertes Diagramm-Icon -->
                <path d="M14 28L14 32" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                <path d="M20 24L20 32" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                <path d="M26 20L26 32" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                <path d="M32 16L32 32" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                <!-- Aufw√§rtstrend-Linie -->
                <path d="M12 28L18 24L24 20L30 16" stroke="#60a5fa" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <!-- Pfeil oben rechts -->
                <path d="M30 13L33 16L30 19" stroke="#60a5fa" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <defs>
                    <linearGradient id="logoGradient" x1="0" y1="0" x2="48" y2="48">
                        <stop offset="0%" stop-color="#1e40af"/>
                        <stop offset="100%" stop-color="#3b82f6"/>
                    </linearGradient>
                </defs>
            </svg>
            <h2 style="font-size: 1.3rem; font-weight: 700; margin: 0;">BWA Insights</h2>
            <p style="font-size: 0.85rem; color: var(--color-gray-400); margin: 4px 0 0 0;">Smart Business Analytics</p>
        </div>
        
        <div class="user-profile" id="userProfile">
            <div class="user-avatar" id="userAvatar">
                <!-- Wird dynamisch ersetzt: Firmenlogo oder Initialen -->
                GS
            </div>
            <div class="user-info">
                <h4 id="userName">Gast-Modus</h4>
                <p id="userTier">
                    <span style="display: inline-block; width: 6px; height: 6px; border-radius: 50%; background: var(--color-gray-400); margin-right: 6px;"></span>
                    Free Version
                </p>
            </div>
            <!-- Login-Button f√ºr nicht eingeloggte User -->
            <button id="loginButton" onclick="showLoginModal()" style="margin-top: 16px; width: 100%; padding: 12px; background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(30, 64, 175, 0.3);">
                Jetzt anmelden
            </button>
        </div>
        
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="showSection('dashboard', event); return false;">
                    <i>‚óÜ</i>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link active" onclick="showSection('upload', event); return false;">
                    <i>‚Üë</i>
                    <span>BWA Upload</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="showSection('scoring', event); return false;">
                    <i>‚óá</i>
                    <span>Scoring</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="showSection('recommendations', event); return false;">
                    <i>‚òÖ</i>
                    <span>Empfehlungen</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="showSection('analytics', event); return false;">
                    <i>‚ñ≤</i>
                    <span>Analytics</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" data-view="history" onclick="showSection('history', event); return false;">
                    <i>üìä</i>
                    <span>Historie</span>
                </a>
            </li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Upload Section -->
        <div id="upload-section" class="section active">
            <div class="container">
                <div class="header">
                    <h1>BWA Upload</h1>
                    <p>Betriebswirtschaftliche Auswertung - Upload & Analyse</p>
                </div>

                <div class="content">
                    <!-- Upload Section -->
                    <div class="upload-section" id="uploadSection">
                        <div class="upload-zone" id="uploadZone">
                            <div class="upload-icon">
                                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="17 8 12 3 7 8"/>
                                    <line x1="12" y1="3" x2="12" y2="15"/>
                                </svg>
                            </div>
                            <div class="upload-text">
                                <h2>BWA-Datei hochladen</h2>
                                <p>Klicken Sie hier oder ziehen Sie eine PDF-Datei hierher</p>
                                <div class="upload-info">
                                    <div><span>‚Ä¢</span> Max. 50MB</div>
                                    <div><span>‚Ä¢</span> PDF Format</div>
                                    <div><span>‚Ä¢</span> Sicher verschl√ºsselt</div>
                                </div>
                            </div>
                            <input type="file" id="fileInput" accept=".pdf" style="display: none;">
                        </div>
                    </div>

                    <!-- Progress Section -->
                    <div class="progress-container" id="progressContainer">
                        <h2>üì§ Upload l√§uft...</h2>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <p id="progressText">0% - Datei wird verarbeitet...</p>
                    </div>

                    <!-- Success Section -->
                    <div class="success-container" id="successContainer">
                        <div style="font-size: 4rem; margin-bottom: 20px;">‚úÖ</div>
                        <h2>BWA-Analyse abgeschlossen!</h2>
                        <div id="successDetails"></div>
                        <button onclick="resetToUpload()" style="margin-top: 20px; padding: 12px 24px; background: #2196F3; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            Weitere BWA hochladen
                        </button>
                    </div>

                    <!-- Dashboard -->
                    <div class="dashboard" id="dashboard">
                        <h2>BWA-Auswertung</h2>
                        <div class="dashboard-grid" id="metricsGrid">
                            <!-- Wird dynamisch gef√ºllt -->
                        </div>
                        <div class="chart-container">
                            <canvas id="bwaChart" width="400" height="200"></canvas>
                        </div>
                    </div>

                    <!-- History Section -->
                    <div class="history-section">
                        <h2>Upload-Historie</h2>
                        <table class="history-table">
                            <thead>
                                <tr>
                                    <th>Datei</th>
                                    <th>Datum</th>
                                    <th>Umsatz</th>
                                    <th>Kosten</th>
                                    <th>Gewinn</th>
                                    <th>Analyse</th>
                                    <th>Aktionen</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <!-- Wird dynamisch gef√ºllt -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Dashboard Section -->
        <div id="dashboard-section" class="section">
            <div class="container">
                <div class="header">
                    <h1>Dashboard</h1>
                    <p>√úbersicht Ihrer Gesch√§ftskennzahlen</p>
                </div>
                <div class="content">
                    <p style="text-align: center; color: #666; font-size: 1.1rem; margin-top: 40px;">
                        Dashboard wird nach BWA-Upload angezeigt<br>
                        <small>Laden Sie eine BWA hoch, um detaillierte Kennzahlen zu sehen</small>
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Scoring Section -->
        <div id="scoring-section" class="section">
            <div class="container">
                <div class="header">
                    <h1>Scoring</h1>
                    <p>Unternehmens-Bewertung</p>
                </div>
                <div class="content">
                    <p style="text-align: center; color: #666; font-size: 1.1rem; margin-top: 40px;">
                        Scoring-Funktionen werden nach BWA-Upload verf√ºgbar<br>
                        <small>Automatische Bewertung Ihrer Unternehmenskennzahlen</small>
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Recommendations Section -->
        <div id="recommendations-section" class="section">
            <div class="container" id="recommendationsContainer">
                <div class="header">
                    <h1>Empfehlungen</h1>
                    <p>KI-basierte Gesch√§ftsempfehlungen</p>
                </div>
                <div class="content">
                    <p style="text-align: center; color: #666; font-size: 1.1rem; margin-top: 40px;">
                        Empfehlungen werden nach BWA-Analyse generiert<br>
                        <small>Intelligente Tipps zur Optimierung Ihres Unternehmens</small>
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Analytics Section -->
        <div id="analytics-section" class="section">
            <div class="container" id="analyticsContainer">
                <div class="header">
                    <h1>Analytics</h1>
                    <p>Detaillierte Unternehmensanalyse</p>
                </div>
                <div class="content">
                    <p style="text-align: center; color: #666; font-size: 1.1rem; margin-top: 40px;">
                        Analytics werden nach BWA-Upload verf√ºgbar<br>
                        <small>Tiefgehende Analyse Ihrer Gesch√§ftsdaten</small>
                    </p>
                </div>
            </div>
        </div>

        <!-- Historie Section -->
        <div id="history-section" class="section">
            <div class="container">
                <div class="header" style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; padding: 24px; border-radius: 12px; margin-bottom: 24px;">
                    <h1 style="margin: 0; font-size: 1.8rem;">üìä BWA-Historie</h1>
                    <p style="margin: 8px 0 0 0; opacity: 0.9;">Ihre gespeicherten BWA-Analysen im √úberblick</p>
                </div>
                
                <div id="historyContent">
                    <!-- Wird dynamisch gef√ºllt -->
                    <div style="text-align: center; padding: 60px 20px;">
                        <div style="font-size: 4rem; margin-bottom: 16px; opacity: 0.3;">üìä</div>
                        <h2 style="color: var(--color-gray-600); font-weight: 600; margin-bottom: 8px;">Noch keine BWAs gespeichert</h2>
                        <p style="color: var(--color-gray-500); margin-bottom: 24px;">
                            Laden Sie Ihre erste BWA hoch, um eine Historie aufzubauen
                        </p>
                        <button onclick="showSection('upload')" style="padding: 12px 24px; background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;">
                            Jetzt BWA hochladen
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // PDF.js Worker Setup
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Globale Variablen
        let uploadZone, fileInput, progressContainer, progressFill, progressText;
        let successContainer, successDetails, dashboard, metricsGrid, historyTableBody;
        let uploadHistory = [];
        let isUploading = false;
        let lastUploadedFile = null;

        // Navigation Functions
        function showSection(sectionName, event) {
            console.log('üîÑ showSection aufgerufen:', sectionName);
            
            // Pr√ºfe ob Feature verf√ºgbar ist
            if (sectionName === 'history' && !currentUser.isLoggedIn) {
                showNotification('‚ö†Ô∏è Bitte melden Sie sich an, um die Historie zu nutzen', 'warning');
                setTimeout(() => showLoginModal(), 500);
                return;
            }
            
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Show selected section
            const targetSection = document.getElementById(sectionName + '-section');
            if (targetSection) {
                targetSection.classList.add('active');
                console.log('‚úÖ Section aktiviert:', sectionName);
                
                // Lade Historie-Daten wenn Historie-Section ge√∂ffnet wird
                if (sectionName === 'history') {
                    loadBWAHistory();
                }
            } else {
                console.error('‚ùå Section nicht gefunden:', sectionName + '-section');
            }
            
            // Add active class to clicked nav link
            if (event && event.target) {
                const navLink = event.target.closest('.nav-link');
                if (navLink) {
                    navLink.classList.add('active');
                }
            }
        }

        // DOM Ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('‚úÖ BWA Dashboard geladen');

            // Elemente finden
            uploadZone = document.getElementById('uploadZone');
            fileInput = document.getElementById('fileInput');
            progressContainer = document.getElementById('progressContainer');
            progressFill = document.getElementById('progressFill');
            progressText = document.getElementById('progressText');
            successContainer = document.getElementById('successContainer');
            successDetails = document.getElementById('successDetails');
            dashboard = document.getElementById('dashboard');
            metricsGrid = document.getElementById('metricsGrid');
            historyTableBody = document.getElementById('historyTableBody');

            if (!uploadZone || !fileInput) {
                console.error('‚ùå Kritische Elemente fehlen!');
                return;
            }

            // Event Listeners
            setupEventListeners();
            loadHistory();
            displayHistory();

            console.log('‚úÖ System initialisiert');
        });

        function setupEventListeners() {
            // Upload Zone Click
            uploadZone.addEventListener('click', function() {
                console.log('üñ±Ô∏è Upload Zone geklickt');
                fileInput.click();
            });

            // File Input Change
            fileInput.addEventListener('change', function(event) {
                console.log('üìÅ File Input Change Event');
                const file = event.target.files[0];
                if (file) {
                    console.log('‚úÖ Datei ausgew√§hlt:', file.name);
                    handleFileUpload(file);
                } else {
                    console.log('‚ùå Keine Datei ausgew√§hlt');
                }
            });

            // Drag & Drop
            uploadZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });

            uploadZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
            });

            uploadZone.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    console.log('üìÅ Datei per Drag & Drop erhalten');
                    handleFileUpload(files[0]);
                }
            });
        }

        // Branchen-Benchmark-Daten
        const industryBenchmarks = {
            retail: {
                name: 'Einzelhandel',
                margin: 5.5,
                personalCost: 35,
                fixedCost: 45,
                description: 'Geringe Margen durch hohen Wettbewerb'
            },
            gastro: {
                name: 'Gastronomie',
                margin: 8.0,
                personalCost: 40,
                fixedCost: 50,
                description: 'Personalintensiv mit hohen Fixkosten'
            },
            it: {
                name: 'IT & Software',
                margin: 25.0,
                personalCost: 60,
                fixedCost: 30,
                description: 'Hohe Margen, personalintensiv'
            },
            consulting: {
                name: 'Beratung',
                margin: 22.0,
                personalCost: 65,
                fixedCost: 25,
                description: 'Sehr personalintensiv, niedrige Fixkosten'
            },
            craft: {
                name: 'Handwerk',
                margin: 12.0,
                personalCost: 45,
                fixedCost: 40,
                description: 'Materialkosten bedeutend'
            },
            ecommerce: {
                name: 'E-Commerce',
                margin: 15.0,
                personalCost: 25,
                fixedCost: 35,
                description: 'Skalierbar mit moderaten Margen'
            },
            healthcare: {
                name: 'Gesundheitswesen',
                margin: 18.0,
                personalCost: 55,
                fixedCost: 35,
                description: 'Reguliert mit stabilen Margen'
            }
        };

        let currentBenchmarkData = null;

        function updateBenchmark() {
            if (!window.currentBWAData) return;
            
            const industry = document.getElementById('industrySelect').value;
            const benchmark = industryBenchmarks[industry];
            currentBenchmarkData = benchmark;
            
            // Benchmark-Werte anzeigen
            document.getElementById('benchmarkMargin').textContent = benchmark.margin + '%';
            document.getElementById('benchmarkPersonal').textContent = benchmark.personalCost + '%';
            document.getElementById('benchmarkFixed').textContent = benchmark.fixedCost + '%';
            
            // Vergleich und Status
            const userMargin = window.currentBWAData.margin;
            const userPersonal = window.currentBWAData.personalCostRatio || 0;
            const userFixed = ((window.currentBWAData.fixedCosts || 0) / window.currentBWAData.revenue) * 100;
            
            // Gewinnmarge Status
            const marginElement = document.getElementById('marginStatus');
            if (userMargin > benchmark.margin * 1.2) {
                marginElement.textContent = 'üü¢ √úberdurchschnittlich';
                marginElement.style.background = '#dcfce7';
                marginElement.style.color = '#166534';
            } else if (userMargin > benchmark.margin * 0.8) {
                marginElement.textContent = 'üü° Im Durchschnitt';
                marginElement.style.background = '#fef3c7';
                marginElement.style.color = '#92400e';
            } else {
                marginElement.textContent = 'üî¥ Unter Durchschnitt';
                marginElement.style.background = '#fee2e2';
                marginElement.style.color = '#991b1b';
            }
            
            // Personalkosten Status
            const personalElement = document.getElementById('personalStatus');
            if (userPersonal < benchmark.personalCost * 0.9) {
                personalElement.textContent = 'üü¢ Effizient';
                personalElement.style.background = '#dcfce7';
                personalElement.style.color = '#166534';
            } else if (userPersonal < benchmark.personalCost * 1.1) {
                personalElement.textContent = 'üü° Normal';
                personalElement.style.background = '#fef3c7';
                personalElement.style.color = '#92400e';
            } else {
                personalElement.textContent = 'üî¥ Optimierung n√∂tig';
                personalElement.style.background = '#fee2e2';
                personalElement.style.color = '#991b1b';
            }
            
            // Fixkosten Status
            const fixedElement = document.getElementById('fixedStatus');
            if (userFixed < benchmark.fixedCost * 0.9) {
                fixedElement.textContent = 'üü¢ Niedrig';
                fixedElement.style.background = '#dcfce7';
                fixedElement.style.color = '#166534';
            } else if (userFixed < benchmark.fixedCost * 1.1) {
                fixedElement.textContent = 'üü° Normal';
                fixedElement.style.background = '#fef3c7';
                fixedElement.style.color = '#92400e';
            } else {
                fixedElement.textContent = 'üî¥ Zu hoch';
                fixedElement.style.background = '#fee2e2';
                fixedElement.style.color = '#991b1b';
            }
        }

        // Szenario-Funktionen
        let scenarioBaseData = null;

        function initializeScenario(bwaData) {
            scenarioBaseData = {
                revenue: bwaData.revenue,
                costs: bwaData.costs,
                profit: bwaData.profit
            };
        }

        function updateScenario() {
            if (!scenarioBaseData) return;
            
            const revenueChange = parseInt(document.getElementById('revenueSlider').value);
            const costChange = parseInt(document.getElementById('costSlider').value);
            
            // Neue Werte berechnen
            const newRevenue = Math.round(scenarioBaseData.revenue * (1 + revenueChange / 100));
            const newCosts = Math.round(scenarioBaseData.costs * (1 + costChange / 100));
            const newProfit = newRevenue - newCosts;
            const profitChange = ((newProfit - scenarioBaseData.profit) / scenarioBaseData.profit * 100).toFixed(1);
            
            // Anzeige aktualisieren
            document.getElementById('revenueChangeDisplay').textContent = (revenueChange > 0 ? '+' : '') + revenueChange + '%';
            document.getElementById('costChangeDisplay').textContent = (costChange > 0 ? '+' : '') + costChange + '%';
            
            document.getElementById('scenarioRevenue').textContent = newRevenue.toLocaleString() + '‚Ç¨';
            document.getElementById('scenarioCosts').textContent = newCosts.toLocaleString() + '‚Ç¨';
            document.getElementById('scenarioProfit').textContent = newProfit.toLocaleString() + '‚Ç¨';
            
            const changeElement = document.getElementById('scenarioProfitChange');
            const changeText = (profitChange > 0 ? '+' : '') + profitChange + '% zum Original';
            changeElement.textContent = changeText;
            changeElement.style.color = profitChange > 0 ? '#4ade80' : profitChange < 0 ? '#f87171' : 'white';
        }

        function resetScenario() {
            document.getElementById('revenueSlider').value = 0;
            document.getElementById('costSlider').value = 0;
            updateScenario();
        }

        // Demo-Daten laden f√ºr Tests
        function loadDemoData() {
            console.log('üéØ Demo-Daten werden geladen...');
            
            const demoFile = {
                name: 'Demo_BWA_Oktober_2025.pdf',
                size: 245000,
                type: 'application/pdf'
            };
            
            // Demo BWA-Daten generieren
            const demoBWAData = generateBWAData(demoFile.name);
            
            console.log('üìä Demo BWA-Daten generiert:', demoBWAData);
            
            // Upload-Prozess simulieren
            document.getElementById('uploadSection').style.display = 'none';
            progressContainer.style.display = 'block';
            
            let progress = 0;
            const interval = setInterval(() => {
                progress += 15;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                    progressFill.style.width = '100%';
                    progressText.textContent = '100% - Analyse abgeschlossen';
                    setTimeout(() => finishUpload(demoFile, demoBWAData), 500);
                } else {
                    progressFill.style.width = progress + '%';
                    progressText.textContent = progress + '% - Demo-Daten werden analysiert...';
                }
            }, 150);
        }

        function handleFileUpload(file) {
            console.log('üöÄ handleFileUpload:', file.name);

            if (isUploading) {
                showNotification('‚ö†Ô∏è Upload bereits in Bearbeitung...', 'warning');
                return;
            }

            // Validierung
            if (file.type !== 'application/pdf') {
                showNotification('‚ùå Nur PDF-Dateien sind erlaubt!', 'error');
                return;
            }

            if (file.size > 50 * 1024 * 1024) {
                showNotification('‚ùå Datei zu gro√ü! Max 50MB.', 'error');
                return;
            }

            startUpload(file);
        }

        function startUpload(file) {
            console.log('üöÄ startUpload:', file.name);
            isUploading = true;
            lastUploadedFile = file;

            // UI umschalten
            document.getElementById('uploadSection').style.display = 'none';
            progressContainer.style.display = 'block';
            successContainer.style.display = 'none';

            simulateUpload(file);
        }

        function simulateUpload(file) {
            console.log('üé¨ simulateUpload');

            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 10 + 5;

                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                    setTimeout(() => completeUpload(file), 1000);
                }

                progressFill.style.width = progress + '%';
                progressText.textContent = Math.round(progress) + '% - Verarbeitung l√§uft...';
            }, 200);
        }

        function completeUpload(file) {
            console.log('‚úÖ completeUpload - Starte echte PDF-Analyse');
            progressText.textContent = '100% - Analysiere BWA...';

            // Echte PDF-Analyse starten
            analyzeBWA(file);
        }

        async function analyzeBWA(file) {
            console.log('üìä analyzeBWA - Echte PDF-Analyse gestartet');

            try {
                // PDF.js verwenden f√ºr echte Analyse
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                
                console.log('üìÑ PDF geladen, Seiten:', pdf.numPages);
                
                let fullText = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + ' ';
                }
                
                console.log('üìù PDF-Text extrahiert (erste 500 Zeichen):', fullText.substring(0, 500));
                console.log('üìù Kompletter PDF-Text:', fullText);
                
                // Echte BWA-Daten extrahieren
                const bwaData = extractBWADataFromText(fullText, file.name);
                console.log('üíæ Finale BWA-Daten:', bwaData);
                finishUpload(file, bwaData);
                
            } catch (error) {
                console.error('‚ùå PDF-Analyse Fehler:', error);
                showNotification('‚ö†Ô∏è PDF konnte nicht analysiert werden. Verwende Demo-Daten.', 'warning');
                
                // Fallback auf fiktive Daten
                const bwaData = generateBWAData(file.name);
                finishUpload(file, bwaData);
            }
        }

        function extractBWADataFromText(text, filename) {
            console.log('üîç Extrahiere BWA-Daten aus Text...');
            console.log('üìÑ Text-L√§nge:', text.length, 'Zeichen');
            
            // Text normalisieren
            const normalizedText = text.replace(/\s+/g, ' ').toLowerCase();
            console.log('üìù Normalisierter Text (erste 300 Zeichen):', normalizedText.substring(0, 300));
            
            // BWA-spezifische Schl√ºsselw√∂rter suchen
            const isValidBWA = /umsatz|ertr√§ge|aufwand|kosten|gewinn|verlust|betriebsergebnis|jahres√ºberschuss/.test(normalizedText);
            console.log('‚úÖ BWA-Struktur erkannt:', isValidBWA);
            
            if (!isValidBWA) {
                console.log('‚ö†Ô∏è Keine BWA-Struktur erkannt, verwende Fallback');
                return generateBWAData(filename);
            }
            
            // Zahlen extrahieren (deutsche und internationale Formate)
            const numbers = extractNumbersFromText(text);
            console.log('üî¢ Gefundene Zahlen:', numbers.slice(0, 20)); // Erste 20 Zahlen
            console.log('üî¢ Anzahl gefundener Zahlen:', numbers.length);
            
            if (numbers.length < 3) {
                console.log('‚ö†Ô∏è Zu wenige Zahlen gefunden, verwende Fallback');
                return generateBWAData(filename);
            }
            
            // Intelligente Zuordnung der Zahlen zu BWA-Kategorien
            let revenue = 0;
            let costs = 0;
            
            // Umsatz-Muster suchen
            const revenuePatterns = [
                /umsatz[^0-9]*?([0-9.,\s]+)/i,
                /ertr√§ge[^0-9]*?([0-9.,\s]+)/i,
                /erl√∂se[^0-9]*?([0-9.,\s]+)/i,
                /gesamtleistung[^0-9]*?([0-9.,\s]+)/i,
                /gesamtumsatz[^0-9]*?([0-9.,\s]+)/i
            ];
            
            // Kosten-Muster suchen
            const costPatterns = [
                /gesamtkosten[^0-9]*?([0-9.,\s]+)/i,
                /aufwand[^0-9]*?([0-9.,\s]+)/i,
                /kosten[^0-9]*?([0-9.,\s]+)/i,
                /ausgaben[^0-9]*?([0-9.,\s]+)/i,
                /gesamtaufwand[^0-9]*?([0-9.,\s]+)/i
            ];
            
            // Umsatz extrahieren
            for (const pattern of revenuePatterns) {
                const match = text.match(pattern);
                if (match) {
                    console.log('üí∞ Umsatz-Match gefunden:', match[0], '-> Zahl:', match[1]);
                    const value = parseGermanNumber(match[1]);
                    console.log('üí∞ Geparster Umsatz:', value);
                    if (value > 1000) {
                        revenue = value;
                        console.log('‚úÖ Umsatz gesetzt:', revenue);
                        break;
                    }
                }
            }
            
            // Kosten extrahieren
            for (const pattern of costPatterns) {
                const match = text.match(pattern);
                if (match) {
                    console.log('üìä Kosten-Match gefunden:', match[0], '-> Zahl:', match[1]);
                    const value = parseGermanNumber(match[1]);
                    console.log('üìä Geparste Kosten:', value);
                    if (value > 500) {
                        costs = value;
                        console.log('‚úÖ Kosten gesetzt:', costs);
                        break;
                    }
                }
            }
            
            // Fallback: Gr√∂√üte Zahlen als Umsatz und zweitgr√∂√üte als Kosten
            if (revenue === 0 || costs === 0) {
                console.log('‚ö†Ô∏è Verwende Fallback: Gr√∂√üte Zahlen');
                const sortedNumbers = numbers.sort((a, b) => b - a);
                console.log('üìä Top 10 Zahlen:', sortedNumbers.slice(0, 10));
                if (revenue === 0 && sortedNumbers[0] > 5000) {
                    revenue = sortedNumbers[0];
                    console.log('üí∞ Umsatz (Fallback):', revenue);
                }
                if (costs === 0 && sortedNumbers[1] > 1000) {
                    costs = sortedNumbers[1];
                    console.log('üìä Kosten (Fallback):', costs);
                }
            }
            
            // Finale Validierung
            console.log('üîç Validierung: Umsatz=', revenue, 'Kosten=', costs);
            if (revenue === 0 || costs === 0) {
                console.log('‚ùå Umsatz oder Kosten = 0, verwende Fallback');
                return generateBWAData(filename);
            }
            
            if (revenue < costs * 0.5) {
                console.log('‚ùå Unplausibel: Umsatz < Kosten * 0.5, verwende Fallback');
                return generateBWAData(filename);
            }
            
            const profit = revenue - costs;
            const margin = ((profit / revenue) * 100).toFixed(1);
            
            console.log('‚úÖ BWA-Daten erfolgreich extrahiert:', { revenue, costs, profit, margin, source: 'extracted' });
            
            // Detaillierte Kostenaufschl√ºsselung (Sch√§tzung basierend auf Gesamtkosten)
            const personalCosts = Math.round(costs * 0.45);
            const materialCosts = Math.round(costs * 0.25);
            const rentCosts = Math.round(costs * 0.10);
            const marketingCosts = Math.round(costs * 0.08);
            const otherCosts = costs - (personalCosts + materialCosts + rentCosts + marketingCosts);

            // Fixkosten vs. Variable Kosten
            const fixedCosts = personalCosts + rentCosts + Math.round(otherCosts * 0.6);
            const variableCosts = materialCosts + marketingCosts + Math.round(otherCosts * 0.4);
            
            return {
                revenue: Math.round(revenue),
                costs: Math.round(costs),
                profit: Math.round(profit),
                margin: parseFloat(margin),
                source: 'extracted',
                
                // Kostenaufschl√ºsselung
                costBreakdown: {
                    personal: personalCosts,
                    material: materialCosts,
                    rent: rentCosts,
                    marketing: marketingCosts,
                    other: otherCosts
                },
                
                // Fixkosten vs. Variable
                fixedCosts: fixedCosts,
                variableCosts: variableCosts,
                
                // KPIs
                breakEvenPoint: Math.round(fixedCosts / (parseFloat(margin) / 100)),
                liquidityMonths: Math.round((profit * 3) / costs * 10) / 10,
                personalCostRatio: Math.round((personalCosts / revenue) * 100),
                materialCostRatio: Math.round((materialCosts / revenue) * 100)
            };
        }

        function extractNumbersFromText(text) {
            // Verschiedene Zahlenformate erkennen
            const patterns = [
                /\b(\d{1,3}(?:\.\d{3})*,\d{2})\b/g,  // Deutsche Format: 123.456,78
                /\b(\d{1,3}(?:,\d{3})*\.\d{2})\b/g,  // US Format: 123,456.78
                /\b(\d+,\d{2})\b/g,                    // Einfach: 1234,56
                /\b(\d+\.\d{2})\b/g,                   // Einfach: 1234.56
                /\b(\d{4,})\b/g                        // Ganze Zahlen > 1000
            ];
            
            const numbers = [];
            
            for (const pattern of patterns) {
                let match;
                while ((match = pattern.exec(text)) !== null) {
                    const number = parseGermanNumber(match[1]);
                    if (number > 100) { // Nur relevante Betr√§ge
                        numbers.push(number);
                    }
                }
            }
            
            // Duplikate entfernen und sortieren
            return [...new Set(numbers)].sort((a, b) => b - a);
        }

        function parseGermanNumber(str) {
            console.log('üî¢ Parse Zahl:', str);
            
            // Whitespace entfernen
            str = str.trim().replace(/\s+/g, '');
            
            // Deutsche und internationale Zahlenformate parsen
            const result = parseFloat(
                str.replace(/\./g, '')  // Tausender-Punkte entfernen
                   .replace(',', '.')   // Komma durch Punkt ersetzen
            );
            
            console.log('üî¢ Ergebnis:', result);
            return result;
        }

        function generateBWAData(filename) {
            const hash = simpleHash(filename);
            const baseRevenue = 50000 + (hash % 200000);
            const costRatio = 0.6 + (hash % 100) / 1000;
            const costs = Math.round(baseRevenue * costRatio);
            const profit = baseRevenue - costs;
            const margin = ((profit / baseRevenue) * 100).toFixed(1);

            // Detaillierte Kostenaufschl√ºsselung
            const personalCosts = Math.round(costs * 0.45); // 45% Personalkosten
            const materialCosts = Math.round(costs * 0.25); // 25% Materialkosten
            const rentCosts = Math.round(costs * 0.10);     // 10% Miete
            const marketingCosts = Math.round(costs * 0.08); // 8% Marketing
            const otherCosts = costs - (personalCosts + materialCosts + rentCosts + marketingCosts);

            // Fixkosten vs. Variable Kosten
            const fixedCosts = personalCosts + rentCosts + Math.round(otherCosts * 0.6);
            const variableCosts = materialCosts + marketingCosts + Math.round(otherCosts * 0.4);

            return {
                revenue: baseRevenue,
                costs: costs,
                profit: profit,
                margin: parseFloat(margin),
                source: 'generated',
                
                // Kostenaufschl√ºsselung
                costBreakdown: {
                    personal: personalCosts,
                    material: materialCosts,
                    rent: rentCosts,
                    marketing: marketingCosts,
                    other: otherCosts
                },
                
                // Fixkosten vs. Variable
                fixedCosts: fixedCosts,
                variableCosts: variableCosts,
                
                // KPIs
                breakEvenPoint: Math.round(fixedCosts / (margin / 100)),
                liquidityMonths: Math.round((profit * 3) / costs * 10) / 10, // Annahme: 3x Gewinn als Reserve
                personalCostRatio: Math.round((personalCosts / baseRevenue) * 100),
                materialCostRatio: Math.round((materialCosts / baseRevenue) * 100)
            };
        }

        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash);
        }

        function finishUpload(file, bwaData) {
            console.log('‚úÖ finishUpload mit Daten:', bwaData);
            console.log('üìä Detaillierte Datenpr√ºfung:');
            console.log('   - Umsatz:', bwaData.revenue);
            console.log('   - Kosten:', bwaData.costs);
            console.log('   - Gewinn:', bwaData.profit);
            console.log('   - Marge:', bwaData.margin);
            console.log('   - Fixkosten:', bwaData.fixedCosts);
            console.log('   - Variable Kosten:', bwaData.variableCosts);
            console.log('   - Break-Even:', bwaData.breakEvenPoint);
            console.log('   - Liquidit√§t (Monate):', bwaData.liquidityMonths);
            console.log('   - Kostenaufschl√ºsselung:', bwaData.costBreakdown);
            console.log('   - Personalkosten-Quote:', bwaData.personalCostRatio);
            console.log('   - Materialkosten-Quote:', bwaData.materialCostRatio);

            // Zu Historie hinzuf√ºgen
            const entry = {
                filename: file.name,
                timestamp: Date.now(),
                date: new Date().toLocaleDateString('de-DE'),
                ...bwaData
            };

            uploadHistory.unshift(entry);
            saveHistory();

            // Globale Variable f√ºr Dashboard-Daten setzen
            window.currentBWAData = bwaData;
            window.currentFileName = file.name;

            console.log('üåç Globale Variable gesetzt:', window.currentBWAData);

            // UI umschalten
            progressContainer.style.display = 'none';
            successContainer.style.display = 'block';
            dashboard.style.display = 'block';

            // Success Details - Erweitert mit neuen KPIs
            successDetails.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p><strong>Datei:</strong> ${file.name}</p>
                    <p><strong>Umsatz:</strong> ${bwaData.revenue.toLocaleString()}‚Ç¨</p>
                    <p><strong>Kosten:</strong> ${bwaData.costs.toLocaleString()}‚Ç¨</p>
                    <p><strong>Gewinn:</strong> ${bwaData.profit.toLocaleString()}‚Ç¨</p>
                    <p><strong>Marge:</strong> ${bwaData.margin}%</p>
                    <hr style="margin: 15px 0; border: none; border-top: 1px solid #e0e0e0;">
                    <p><strong>Fixkosten:</strong> ${(bwaData.fixedCosts || 0).toLocaleString()}‚Ç¨</p>
                    <p><strong>Variable Kosten:</strong> ${(bwaData.variableCosts || 0).toLocaleString()}‚Ç¨</p>
                    <p><strong>Break-Even:</strong> ${(bwaData.breakEvenPoint || 0).toLocaleString()}‚Ç¨</p>
                    <p><strong>Liquidit√§t:</strong> ${(bwaData.liquidityMonths || 0).toFixed(1)} Monate</p>
                </div>
            `;

            // Dashboard aktualisieren
            updateDashboard(bwaData);
            updateAllSections(bwaData, file.name);
            displayHistory();

            isUploading = false;
            showNotification('‚úÖ BWA erfolgreich analysiert!', 'success');
        }

        function updateDashboard(data) {
            metricsGrid.innerHTML = `
                <div class="metric-card">
                    <div class="metric-value" style="color: var(--color-gray-900);">${data.revenue.toLocaleString()}‚Ç¨</div>
                    <div class="metric-label">Umsatz</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" style="color: var(--color-gray-900);">${data.costs.toLocaleString()}‚Ç¨</div>
                    <div class="metric-label">Kosten</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" style="color: var(--color-gray-900);">${data.profit.toLocaleString()}‚Ç¨</div>
                    <div class="metric-label">Gewinn</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" style="color: var(--color-gray-900);">${data.margin}%</div>
                    <div class="metric-label">Marge</div>
                </div>
            `;
            
            // Wenn User eingeloggt ist: BWA in Historie speichern
            if (currentUser.isLoggedIn && canAccessFeature('history')) {
                saveBWAToHistory(data);
            }
        }

        // ============================================
        // BWA-HISTORIE FUNKTIONEN
        // ============================================

        // BWA in Supabase speichern
        async function saveBWAToHistory(bwaData) {
            try {
                if (!supabase) {
                    console.log('‚ÑπÔ∏è Supabase nicht konfiguriert - Historie nicht verf√ºgbar');
                    return;
                }

                // Monat und Jahr aus BWA extrahieren (oder aktuelles Datum verwenden)
                const now = new Date();
                const monat = bwaData.month || now.toLocaleString('de-DE', { month: 'long' });
                const jahr = bwaData.year || now.getFullYear();

                // Business Score berechnen
                const businessScore = calculateBusinessScore(
                    bwaData.margin,
                    bwaData.costs / bwaData.revenue * 100,
                    bwaData.profit
                );

                // BWA-Daten vorbereiten
                const bwaRecord = {
                    user_id: currentUser.userId,
                    upload_date: new Date().toISOString().split('T')[0],
                    monat: monat,
                    jahr: jahr,
                    
                    // Finanzdaten
                    umsatz: bwaData.revenue || 0,
                    kosten: bwaData.costs || 0,
                    gewinn: bwaData.profit || 0,
                    gewinnmarge: bwaData.margin || 0,
                    
                    // Liquidit√§t
                    liquide_mittel: bwaData.liquidAssets || 0,
                    forderungen: bwaData.receivables || 0,
                    verbindlichkeiten: bwaData.liabilities || 0,
                    liquiditaetsgrad: bwaData.liquidityRatio || 0,
                    
                    // Eigenkapital
                    eigenkapital: bwaData.equity || 0,
                    fremdkapital: bwaData.debt || 0,
                    eigenkapitalquote: bwaData.equityRatio || 0,
                    
                    // Kostenstruktur als JSON
                    kostenaufschluessung: bwaData.costBreakdown || {},
                    
                    // Business Score
                    business_score: businessScore
                };

                console.log('üíæ Speichere BWA in Historie...', bwaRecord);

                // In Supabase speichern (mit upsert f√ºr Update bei existierendem Monat/Jahr)
                const { data, error } = await supabase
                    .from('bwa_uploads')
                    .upsert(bwaRecord, {
                        onConflict: 'user_id,jahr,monat'
                    })
                    .select();

                if (error) throw error;

                console.log('‚úÖ BWA in Historie gespeichert:', data);
                showNotification('üíæ BWA in Ihrer Historie gespeichert', 'success');
                
                // Historie-Badge aktualisieren
                updateHistoryBadge();
                
            } catch (error) {
                console.error('‚ùå Fehler beim Speichern der BWA:', error);
                showNotification('‚ö†Ô∏è BWA konnte nicht gespeichert werden', 'warning');
            }
        }

        // Anzahl der gespeicherten BWAs abrufen
        async function getBWAHistoryCount() {
            try {
                if (!supabase || !currentUser.isLoggedIn) return 0;

                const { count, error } = await supabase
                    .from('bwa_uploads')
                    .select('*', { count: 'exact', head: true })
                    .eq('user_id', currentUser.userId);

                if (error) throw error;

                return count || 0;
            } catch (error) {
                console.error('Fehler beim Abrufen der BWA-Anzahl:', error);
                return 0;
            }
        }

        // Historie-Badge im Men√º aktualisieren
        async function updateHistoryBadge() {
            const count = await getBWAHistoryCount();
            
            // Finde Historie-Men√ºpunkt
            const historyLink = document.querySelector('[data-view="history"]');
            if (!historyLink) return;

            // Entferne altes Badge
            const oldBadge = historyLink.querySelector('.history-badge');
            if (oldBadge) oldBadge.remove();

            // F√ºge neues Badge hinzu
            if (count > 0) {
                const badge = document.createElement('span');
                badge.className = 'history-badge';
                badge.textContent = count;
                badge.style.cssText = `
                    display: inline-block;
                    background: var(--color-primary);
                    color: white;
                    font-size: 0.7rem;
                    font-weight: 700;
                    padding: 2px 6px;
                    border-radius: 10px;
                    margin-left: 8px;
                `;
                historyLink.appendChild(badge);
            }
        }

        // BWA-Historie aus Supabase laden und anzeigen
        async function loadBWAHistory() {
            const historyContent = document.getElementById('historyContent');
            if (!historyContent) return;

            try {
                if (!supabase || !currentUser.isLoggedIn) {
                    historyContent.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px;">
                            <div style="font-size: 4rem; margin-bottom: 16px; opacity: 0.3;">üîê</div>
                            <h2 style="color: var(--color-gray-600); font-weight: 600; margin-bottom: 8px;">Bitte anmelden</h2>
                            <p style="color: var(--color-gray-500); margin-bottom: 24px;">
                                Melden Sie sich an, um Ihre BWA-Historie zu sehen
                            </p>
                            <button onclick="showLoginModal()" style="padding: 12px 24px; background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;">
                                Jetzt anmelden
                            </button>
                        </div>
                    `;
                    return;
                }

                // Loading-State
                historyContent.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px;">
                        <div style="font-size: 3rem; margin-bottom: 16px;">‚è≥</div>
                        <p style="color: var(--color-gray-600);">Historie wird geladen...</p>
                    </div>
                `;

                // BWAs aus Supabase laden
                const { data: bwaList, error } = await supabase
                    .from('bwa_uploads')
                    .select('*')
                    .eq('user_id', currentUser.userId)
                    .order('jahr', { ascending: false })
                    .order('monat', { ascending: false });

                if (error) throw error;

                if (!bwaList || bwaList.length === 0) {
                    historyContent.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px;">
                            <div style="font-size: 4rem; margin-bottom: 16px; opacity: 0.3;">üìä</div>
                            <h2 style="color: var(--color-gray-600); font-weight: 600; margin-bottom: 8px;">Noch keine BWAs gespeichert</h2>
                            <p style="color: var(--color-gray-500); margin-bottom: 24px;">
                                Laden Sie Ihre erste BWA hoch, um eine Historie aufzubauen
                            </p>
                            <button onclick="showSection('upload')" style="padding: 12px 24px; background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;">
                                Jetzt BWA hochladen
                            </button>
                        </div>
                    `;
                    return;
                }

                // Historie-Tabelle rendern
                renderBWAHistoryTable(bwaList);

            } catch (error) {
                console.error('‚ùå Fehler beim Laden der Historie:', error);
                historyContent.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px;">
                        <div style="font-size: 3rem; margin-bottom: 16px; color: #ef4444;">‚ö†Ô∏è</div>
                        <h2 style="color: var(--color-gray-600); font-weight: 600; margin-bottom: 8px;">Fehler beim Laden</h2>
                        <p style="color: var(--color-gray-500); margin-bottom: 24px;">
                            ${error.message}
                        </p>
                        <button onclick="loadBWAHistory()" style="padding: 12px 24px; background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;">
                            Erneut versuchen
                        </button>
                    </div>
                `;
            }
        }

        // BWA-Historie als Tabelle darstellen
        function renderBWAHistoryTable(bwaList) {
            const historyContent = document.getElementById('historyContent');
            if (!historyContent) return;

            // Statistiken berechnen
            const totalBWAs = bwaList.length;
            const avgScore = Math.round(bwaList.reduce((sum, bwa) => sum + (bwa.business_score || 0), 0) / totalBWAs);
            const latestBWA = bwaList[0];

            // Trend berechnen (letzten 3 Monate)
            const recentBWAs = bwaList.slice(0, Math.min(3, bwaList.length));
            const avgRecentRevenue = recentBWAs.reduce((sum, bwa) => sum + (bwa.umsatz || 0), 0) / recentBWAs.length;
            const oldestRecent = recentBWAs[recentBWAs.length - 1];
            const trend = oldestRecent && oldestRecent.umsatz > 0 
                ? ((latestBWA.umsatz - oldestRecent.umsatz) / oldestRecent.umsatz * 100).toFixed(1)
                : 0;

            historyContent.innerHTML = `
                <!-- Statistik-Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    <div style="background: linear-gradient(135deg, #f0f9ff 0%, #dbeafe 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #3b82f6;">
                        <div style="font-size: 0.85rem; color: #1e40af; font-weight: 600; margin-bottom: 8px;">Gesamt BWAs</div>
                        <div style="font-size: 2rem; font-weight: 700; color: #1e40af;">${totalBWAs}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #10b981;">
                        <div style="font-size: 0.85rem; color: #065f46; font-weight: 600; margin-bottom: 8px;">√ò Business Score</div>
                        <div style="font-size: 2rem; font-weight: 700; color: #065f46;">${avgScore}/100</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #f59e0b;">
                        <div style="font-size: 0.85rem; color: #92400e; font-weight: 600; margin-bottom: 8px;">Trend (3 Monate)</div>
                        <div style="font-size: 2rem; font-weight: 700; color: #92400e;">
                            ${trend > 0 ? '+' : ''}${trend}%
                        </div>
                    </div>
                </div>

                <!-- Filter & Aktionen -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">
                    <div>
                        <button onclick="showTrendComparison()" style="padding: 10px 20px; background: var(--color-primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-right: 8px;">
                            üìà Trend-Vergleich
                        </button>
                        <button onclick="exportHistory()" style="padding: 10px 20px; background: white; color: var(--color-primary); border: 2px solid var(--color-primary); border-radius: 8px; font-weight: 600; cursor: pointer;">
                            üìÑ Als PDF exportieren
                        </button>
                    </div>
                    <select id="historyFilter" onchange="filterHistory()" style="padding: 10px; border: 2px solid var(--color-gray-200); border-radius: 8px; font-size: 0.95rem;">
                        <option value="all">Alle anzeigen</option>
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                        <option value="last6">Letzte 6 Monate</option>
                    </select>
                </div>

                <!-- BWA-Liste -->
                <div id="bwaListContainer">
                    ${bwaList.map(bwa => renderBWACard(bwa)).join('')}
                </div>
            `;
        }

        // Einzelne BWA-Card rendern
        function renderBWACard(bwa) {
            const scoreColor = bwa.business_score >= 75 ? '#10b981' : bwa.business_score >= 50 ? '#f59e0b' : '#ef4444';
            const profitColor = bwa.gewinn >= 0 ? '#10b981' : '#ef4444';
            
            return `
                <div class="bwa-card" style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: all 0.2s; cursor: pointer; border-left: 4px solid ${scoreColor};" onclick="showBWADetails('${bwa.id}')" onmouseover="this.style.boxShadow='0 4px 16px rgba(0,0,0,0.12)'" onmouseout="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.08)'">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                        <div>
                            <h3 style="margin: 0 0 4px 0; font-size: 1.2rem; color: var(--color-gray-900);">
                                ${bwa.monat} ${bwa.jahr}
                            </h3>
                            <p style="margin: 0; color: var(--color-gray-500); font-size: 0.85rem;">
                                Hochgeladen: ${new Date(bwa.upload_date).toLocaleDateString('de-DE')}
                            </p>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.75rem; color: var(--color-gray-600); margin-bottom: 4px;">Business Score</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: ${scoreColor};">
                                ${bwa.business_score}/100
                            </div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 16px;">
                        <div>
                            <div style="font-size: 0.75rem; color: var(--color-gray-600); margin-bottom: 4px;">Umsatz</div>
                            <div style="font-size: 1.1rem; font-weight: 600; color: var(--color-gray-900);">
                                ${(bwa.umsatz || 0).toLocaleString('de-DE')}‚Ç¨
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--color-gray-600); margin-bottom: 4px;">Kosten</div>
                            <div style="font-size: 1.1rem; font-weight: 600; color: var(--color-gray-900);">
                                ${(bwa.kosten || 0).toLocaleString('de-DE')}‚Ç¨
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--color-gray-600); margin-bottom: 4px;">Gewinn</div>
                            <div style="font-size: 1.1rem; font-weight: 600; color: ${profitColor};">
                                ${(bwa.gewinn || 0).toLocaleString('de-DE')}‚Ç¨
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--color-gray-600); margin-bottom: 4px;">Marge</div>
                            <div style="font-size: 1.1rem; font-weight: 600; color: var(--color-gray-900);">
                                ${(bwa.gewinnmarge || 0).toFixed(1)}%
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--color-gray-200); display: flex; gap: 8px;">
                        <button onclick="event.stopPropagation(); showBWADetails('${bwa.id}')" style="flex: 1; padding: 8px; background: var(--color-primary); color: white; border: none; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer;">
                            Details anzeigen
                        </button>
                        <button onclick="event.stopPropagation(); deleteBWA('${bwa.id}')" style="padding: 8px 16px; background: #fee2e2; color: #dc2626; border: none; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer;">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            `;
        }

        // BWA-Details anzeigen
        async function showBWADetails(bwaId) {
            // TODO: Detailansicht mit allen Kennzahlen, Charts, etc.
            showNotification('üìä Detail-Ansicht wird vorbereitet...', 'info');
            console.log('Zeige BWA Details f√ºr ID:', bwaId);
        }

        // BWA l√∂schen
        async function deleteBWA(bwaId) {
            if (!confirm('M√∂chten Sie diese BWA wirklich l√∂schen?')) return;

            try {
                const { error } = await supabase
                    .from('bwa_uploads')
                    .delete()
                    .eq('id', bwaId);

                if (error) throw error;

                showNotification('‚úÖ BWA gel√∂scht', 'success');
                loadBWAHistory(); // Liste neu laden
                updateHistoryBadge();
            } catch (error) {
                console.error('Fehler beim L√∂schen:', error);
                showNotification('‚ùå L√∂schen fehlgeschlagen', 'error');
            }
        }

        // Trend-Vergleich anzeigen
        function showTrendComparison() {
            // TODO: Multi-BWA-Vergleich mit Charts
            showNotification('üìà Trend-Vergleich wird vorbereitet...', 'info');
        }

        // Historie als PDF exportieren
        function exportHistory() {
            // TODO: PDF-Export
            showNotification('üìÑ Export wird vorbereitet...', 'info');
        }

        // Historie filtern
        function filterHistory() {
            // TODO: Filter-Funktion
            showNotification('üîç Filter wird angewendet...', 'info');
        }

        function generateHistoricalData(currentData) {
            // Generiere 6 Monate historische Daten basierend auf aktuellen Werten
            const months = ['Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober'];
            const data = [];
            
            for (let i = 0; i < 6; i++) {
                const growthFactor = 0.85 + (i * 0.03); // Simuliertes Wachstum
                const variance = 0.95 + Math.random() * 0.1; // Zuf√§llige Schwankung
                
                data.push({
                    month: months[i],
                    revenue: Math.round(currentData.revenue * growthFactor * variance),
                    costs: Math.round(currentData.costs * growthFactor * variance),
                    profit: 0 // Wird berechnet
                });
            }
            
            // Profit berechnen
            data.forEach(entry => {
                entry.profit = entry.revenue - entry.costs;
            });
            
            return data;
        }

        function createTrendChart(historicalData) {
            const canvas = document.getElementById('trendChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Alten Chart zerst√∂ren falls vorhanden
            if (window.trendChartInstance) {
                window.trendChartInstance.destroy();
            }
            
            window.trendChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: historicalData.map(d => d.month),
                    datasets: [
                        {
                            label: 'Umsatz',
                            data: historicalData.map(d => d.revenue),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Kosten',
                            data: historicalData.map(d => d.costs),
                            borderColor: '#60a5fa',
                            backgroundColor: 'rgba(96, 165, 250, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Gewinn',
                            data: historicalData.map(d => d.profit),
                            borderColor: '#1e40af',
                            backgroundColor: 'rgba(30, 64, 175, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: { size: 14, weight: 'bold' },
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + '‚Ç¨';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + '‚Ç¨';
                                }
                            }
                        }
                    }
                }
            });
            
            // Wachstumsraten berechnen und anzeigen
            const lastMonth = historicalData[historicalData.length - 1];
            const prevMonth = historicalData[historicalData.length - 2];
            
            const revenueGrowth = ((lastMonth.revenue - prevMonth.revenue) / prevMonth.revenue * 100).toFixed(1);
            const costGrowth = ((lastMonth.costs - prevMonth.costs) / prevMonth.costs * 100).toFixed(1);
            const profitGrowth = ((lastMonth.profit - prevMonth.profit) / prevMonth.profit * 100).toFixed(1);
            
            document.getElementById('revenueGrowth').textContent = (revenueGrowth > 0 ? '+' : '') + revenueGrowth + '%';
            document.getElementById('costGrowth').textContent = (costGrowth > 0 ? '+' : '') + costGrowth + '%';
            document.getElementById('profitGrowth').textContent = (profitGrowth > 0 ? '+' : '') + profitGrowth + '%';
        }

        function updateAllSections(bwaData, filename) {
            console.log('üîÑ updateAllSections aufgerufen mit:', bwaData);
            console.log('üìÅ Dateiname:', filename);
            
            // Datenvalidierung
            if (!bwaData || !bwaData.revenue) {
                console.error('‚ùå Ung√ºltige BWA-Daten:', bwaData);
                return;
            }
            
            // Historische Daten generieren f√ºr Trend-Chart
            const historicalData = generateHistoricalData(bwaData);
            console.log('üìä Historische Daten generiert:', historicalData);
            
            // Dashboard Section aktualisieren
            const dashboardSection = document.getElementById('dashboard-section');
            if (dashboardSection) {
                console.log('‚úÖ Dashboard-Section gefunden, wird aktualisiert...');
                dashboardSection.innerHTML = `
                    <div class="container">
                        <div class="header">
                            <h1>Dashboard</h1>
                            <p>√úbersicht Ihrer Gesch√§ftskennzahlen - ${filename}</p>
                        </div>
                        <div class="content">
                            <!-- KPI Scorecard -->
                            <div style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); padding: 30px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 4px 6px -1px rgba(30, 64, 175, 0.1);">
                                <h3 style="color: white; margin-bottom: 20px; font-size: 18px; font-weight: 600;">KPI-Scorecard</h3>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                                    ${[
                                        { 
                                            label: 'Gewinnmarge', 
                                            value: bwaData.margin + '%',
                                            status: bwaData.margin >= 20 ? 'good' : bwaData.margin >= 10 ? 'warning' : 'critical',
                                            target: 'Ziel: >20%'
                                        },
                                        { 
                                            label: 'Liquidit√§t', 
                                            value: (bwaData.liquidityMonths || 0).toFixed(1) + ' Mo.',
                                            status: (bwaData.liquidityMonths || 0) >= 3 ? 'good' : (bwaData.liquidityMonths || 0) >= 1.5 ? 'warning' : 'critical',
                                            target: 'Ziel: >3 Monate'
                                        },
                                        { 
                                            label: 'Personalkosten', 
                                            value: (bwaData.personalCostRatio || 0) + '%',
                                            status: (bwaData.personalCostRatio || 0) <= 45 ? 'good' : (bwaData.personalCostRatio || 0) <= 55 ? 'warning' : 'critical',
                                            target: 'Ziel: <45%'
                                        },
                                        { 
                                            label: 'Fixkostenquote', 
                                            value: (((bwaData.fixedCosts || 0) / bwaData.revenue) * 100).toFixed(0) + '%',
                                            status: (((bwaData.fixedCosts || 0) / bwaData.revenue) * 100) <= 40 ? 'good' : (((bwaData.fixedCosts || 0) / bwaData.revenue) * 100) <= 50 ? 'warning' : 'critical',
                                            target: 'Ziel: <40%'
                                        }
                                    ].map(kpi => `
                                        <div style="background: rgba(255, 255, 255, 0.95); padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                            <div style="font-size: 1.8rem; font-weight: 600; margin-bottom: 5px; color: #1e293b;">${kpi.value}</div>
                                            <div style="font-size: 0.9rem; color: #64748b; margin-bottom: 12px;">${kpi.label}</div>
                                            <div style="display: flex; align-items: center; justify-content: center; gap: 8px; padding-top: 8px; border-top: 1px solid #e2e8f0;">
                                                <span style="width: 8px; height: 8px; border-radius: 50%; background: ${kpi.status === 'good' ? '#10b981' : kpi.status === 'warning' ? '#fbbf24' : '#ef4444'};"></span>
                                                <span style="font-size: 0.75rem; color: #64748b;">${kpi.target}</span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        
                            <div class="dashboard-grid">
                                <div class="metric-card">
                                    <div class="metric-value" style="color: var(--color-gray-900);">${bwaData.revenue.toLocaleString()}‚Ç¨</div>
                                    <div class="metric-label">Umsatz</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value" style="color: var(--color-gray-900);">${bwaData.costs.toLocaleString()}‚Ç¨</div>
                                    <div class="metric-label">Kosten</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value" style="color: var(--color-gray-900);">${bwaData.profit.toLocaleString()}‚Ç¨</div>
                                    <div class="metric-label">Gewinn</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value" style="color: var(--color-gray-900);">${bwaData.margin}%</div>
                                    <div class="metric-label">Marge</div>
                                </div>
                            </div>
                            
                            <!-- Liquidit√§ts-Cockpit -->
                            <div style="margin-top: 30px; background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%); padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(14, 165, 233, 0.1);">
                                <h3 style="margin-bottom: 20px; color: white; font-size: 18px; font-weight: 600;">Liquidit√§ts-Cockpit</h3>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                                    <div style="text-align: center; padding: 20px; background: rgba(255, 255, 255, 0.95); border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                        <div style="font-size: 0.9rem; color: #64748b; margin-bottom: 8px;">Liquidit√§tsreserve</div>
                                        <div style="font-size: 2rem; font-weight: 600; margin: 10px 0; color: #0f172a;">${(bwaData.liquidityMonths || 0).toFixed(1)} Monate</div>
                                        <div style="font-size: 0.85rem; color: #64748b;">
                                            ${(bwaData.liquidityMonths || 0) >= 3 ? 'Sicher' : (bwaData.liquidityMonths || 0) >= 1.5 ? 'Kritisch' : 'Akut'}
                                        </div>
                                    </div>
                                    <div style="text-align: center; padding: 20px; background: rgba(255, 255, 255, 0.95); border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                        <div style="font-size: 0.9rem; color: #64748b; margin-bottom: 8px;">Break-Even-Point</div>
                                        <div style="font-size: 2rem; font-weight: 600; margin: 10px 0; color: #0f172a;">${(bwaData.breakEvenPoint || 0).toLocaleString()}‚Ç¨</div>
                                        <div style="font-size: 0.85rem; color: #64748b;">Gewinnschwelle</div>
                                    </div>
                                    <div style="text-align: center; padding: 20px; background: rgba(255, 255, 255, 0.95); border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                        <div style="font-size: 0.9rem; color: #64748b; margin-bottom: 8px;">Sicherheitsmarge</div>
                                        <div style="font-size: 2rem; font-weight: 600; margin: 10px 0; color: #0f172a;">${(((bwaData.revenue - (bwaData.breakEvenPoint || 0)) / bwaData.revenue) * 100).toFixed(0)}%</div>
                                        <div style="font-size: 0.85rem; color: #64748b;">Puffer √ºber Break-Even</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Kostenaufschl√ºsselung -->
                            <div class="chart-container" style="margin-top: 30px;">
                                <h3 style="margin-bottom: 20px; color: var(--color-gray-900); font-size: 18px;">Kostenstruktur-Analyse</h3>
                                
                                <!-- Fixkosten vs. Variable Kosten -->
                                <div style="background: #f0f9ff; padding: 25px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #bae6fd;">
                                    <h4 style="margin-bottom: 15px; color: #0c4a6e; font-size: 16px;">Fixkosten vs. Variable Kosten</h4>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                        <div>
                                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                                <span style="font-weight: 500; color: #0369a1;">Fixkosten</span>
                                                <span style="font-weight: 600; color: #0c4a6e;">${(bwaData.fixedCosts || 0).toLocaleString()}‚Ç¨</span>
                                            </div>
                                            <div style="background: #e0f2fe; height: 8px; border-radius: 4px; overflow: hidden;">
                                                <div style="background: #0ea5e9; height: 100%; width: ${((bwaData.fixedCosts || 0) / bwaData.costs * 100).toFixed(0)}%;"></div>
                                            </div>
                                            <div style="font-size: 0.85rem; color: #0369a1; margin-top: 4px;">
                                                ${((bwaData.fixedCosts || 0) / bwaData.costs * 100).toFixed(0)}% der Gesamtkosten
                                            </div>
                                        </div>
                                        <div>
                                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                                <span style="font-weight: 500; color: #1e40af;">Variable Kosten</span>
                                                <span style="font-weight: 600; color: #0c4a6e;">${(bwaData.variableCosts || 0).toLocaleString()}‚Ç¨</span>
                                            </div>
                                            <div style="background: #dbeafe; height: 8px; border-radius: 4px; overflow: hidden;">
                                                <div style="background: #3b82f6; height: 100%; width: ${((bwaData.variableCosts || 0) / bwaData.costs * 100).toFixed(0)}%;"></div>
                                            </div>
                                            <div style="font-size: 0.85rem; color: #1e40af; margin-top: 4px;">
                                                ${((bwaData.variableCosts || 0) / bwaData.costs * 100).toFixed(0)}% der Gesamtkosten
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Top 5 Kostenkategorien -->
                                <div style="background: white; padding: 25px; border: 1px solid var(--color-gray-200); border-radius: 12px;">
                                    <h4 style="margin-bottom: 15px; color: var(--color-gray-900); font-size: 16px;">Top 5 Kostenkategorien</h4>
                                    ${bwaData.costBreakdown ? `
                                        <div style="space-y: 15px;">
                                            ${[
                                                { label: 'Personalkosten', value: bwaData.costBreakdown.personal },
                                                { label: 'Materialkosten', value: bwaData.costBreakdown.material },
                                                { label: 'Miete & Nebenkosten', value: bwaData.costBreakdown.rent },
                                                { label: 'Marketing & Vertrieb', value: bwaData.costBreakdown.marketing },
                                                { label: 'Sonstige Kosten', value: bwaData.costBreakdown.other }
                                            ].map(item => `
                                                <div style="margin-bottom: 15px;">
                                                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                                        <span style="font-weight: 500; color: #475569;">${item.label}</span>
                                                        <div>
                                                            <span style="font-weight: 600; color: #1e293b;">${item.value.toLocaleString()}‚Ç¨</span>
                                                            <span style="color: #64748b; font-size: 0.9rem; margin-left: 8px;">
                                                                (${((item.value / bwaData.costs) * 100).toFixed(1)}%)
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <div style="background: #dbeafe; height: 10px; border-radius: 5px; overflow: hidden;">
                                                        <div style="background: #3b82f6; height: 100%; width: ${((item.value / bwaData.costs) * 100).toFixed(1)}%; transition: width 0.3s ease;"></div>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : '<p style="color: var(--color-gray-500);">Keine detaillierte Kostenaufschl√ºsselung verf√ºgbar</p>'}
                                </div>
                            </div>

                            <!-- 6-Monats-Trend -->
                            <div class="chart-container" style="margin-top: 30px;">
                                <div style="background: linear-gradient(to right, #eff6ff, #dbeafe); padding: 30px; border-radius: 12px; border: 1px solid #bfdbfe;">
                                    <h3 style="margin-bottom: 20px; color: #1e40af; font-size: 18px; font-weight: 600;">6-Monats-Trend</h3>
                                    <div style="background: white; padding: 25px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                                        <canvas id="trendChart" style="max-height: 400px;"></canvas>
                                    </div>
                                    
                                    <!-- Wachstumsraten -->
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px;">
                                        <div style="background: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                                            <div style="font-size: 0.9rem; color: #64748b;">Umsatzwachstum (MoM)</div>
                                            <div style="font-size: 1.8rem; font-weight: 600; margin: 8px 0; color: #1e40af;" id="revenueGrowth">+0%</div>
                                            <div style="font-size: 0.8rem; color: #64748b;">Monat-zu-Monat</div>
                                        </div>
                                        <div style="background: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                                            <div style="font-size: 0.9rem; color: #64748b;">Kostenwachstum (MoM)</div>
                                            <div style="font-size: 1.8rem; font-weight: 600; margin: 8px 0; color: #1e40af;" id="costGrowth">+0%</div>
                                            <div style="font-size: 0.8rem; color: #64748b;">Monat-zu-Monat</div>
                                        </div>
                                        <div style="background: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                                            <div style="font-size: 0.9rem; color: #64748b;">Gewinnwachstum (MoM)</div>
                                            <div style="font-size: 1.8rem; font-weight: 600; margin: 8px 0; color: #1e40af;" id="profitGrowth">+0%</div>
                                            <div style="font-size: 0.8rem; color: #64748b;">Monat-zu-Monat</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Was-w√§re-wenn Szenarien -->
                            <div class="chart-container" style="margin-top: 30px;">
                                <div style="background: linear-gradient(135deg, #1e40af 0%, #3730a3 100%); padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(30, 64, 175, 0.1);">
                                    <h3 style="margin-bottom: 15px; color: white; font-size: 18px; font-weight: 600;">Was-w√§re-wenn Szenarien</h3>
                                    <p style="margin-bottom: 25px; color: rgba(255,255,255,0.9); font-size: 1rem;">Simulieren Sie verschiedene Gesch√§ftsszenarien und sehen Sie die Auswirkungen in Echtzeit</p>
                                    
                                    <!-- Umsatz-Szenario -->
                                    <div style="background: rgba(255, 255, 255, 0.15); padding: 20px; border-radius: 12px; margin-bottom: 20px; backdrop-filter: blur(10px);">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                            <span style="font-weight: 500; color: white;">Umsatz√§nderung</span>
                                            <span id="revenueChangeDisplay" style="font-size: 1.3rem; font-weight: 600; color: white;">0%</span>
                                        </div>
                                        <input type="range" id="revenueSlider" min="-30" max="50" value="0" step="5" 
                                               style="width: 100%; height: 8px; border-radius: 5px; background: rgba(255,255,255,0.3); outline: none; cursor: pointer;"
                                               oninput="updateScenario()">
                                        <div style="display: flex; justify-content: space-between; font-size: 0.85rem; margin-top: 5px; color: rgba(255,255,255,0.8);">
                                            <span>-30%</span>
                                            <span>+50%</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Kosten-Szenario -->
                                    <div style="background: rgba(255, 255, 255, 0.15); padding: 20px; border-radius: 12px; margin-bottom: 25px; backdrop-filter: blur(10px);">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                            <span style="font-weight: 500; color: white;">Kosten√§nderung</span>
                                            <span id="costChangeDisplay" style="font-size: 1.3rem; font-weight: 600; color: white;">0%</span>
                                        </div>
                                        <input type="range" id="costSlider" min="-30" max="30" value="0" step="5" 
                                               style="width: 100%; height: 8px; border-radius: 5px; background: rgba(255,255,255,0.3); outline: none; cursor: pointer;"
                                               oninput="updateScenario()">
                                        <div style="display: flex; justify-content: space-between; font-size: 0.85rem; margin-top: 5px; color: rgba(255,255,255,0.8);">
                                            <span>-30%</span>
                                            <span>+30%</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Ergebnis-Anzeige -->
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                                        <div style="text-align: center; padding: 15px; background: rgba(255, 255, 255, 0.2); border-radius: 10px; backdrop-filter: blur(10px);">
                                            <div style="font-size: 0.85rem; margin-bottom: 8px; color: rgba(255,255,255,0.9);">Neuer Umsatz</div>
                                            <div id="scenarioRevenue" style="font-size: 1.5rem; font-weight: 600; color: white;">${bwaData.revenue.toLocaleString()}‚Ç¨</div>
                                        </div>
                                        <div style="text-align: center; padding: 15px; background: rgba(255, 255, 255, 0.2); border-radius: 10px; backdrop-filter: blur(10px);">
                                            <div style="font-size: 0.85rem; margin-bottom: 8px; color: rgba(255,255,255,0.9);">Neue Kosten</div>
                                            <div id="scenarioCosts" style="font-size: 1.5rem; font-weight: 600; color: white;">${bwaData.costs.toLocaleString()}‚Ç¨</div>
                                        </div>
                                        <div style="text-align: center; padding: 15px; background: rgba(255, 255, 255, 0.2); border-radius: 10px; backdrop-filter: blur(10px);">
                                            <div style="font-size: 0.85rem; margin-bottom: 8px; color: rgba(255,255,255,0.9);">Neuer Gewinn</div>
                                            <div id="scenarioProfit" style="font-size: 1.5rem; font-weight: 600; color: white;">${bwaData.profit.toLocaleString()}‚Ç¨</div>
                                            <div id="scenarioProfitChange" style="font-size: 0.8rem; margin-top: 5px; color: rgba(255,255,255,0.8);">‚Äî</div>
                                        </div>
                                    </div>
                                    
                                    <div style="text-align: center; margin-top: 20px;">
                                        <button onclick="resetScenario()" style="padding: 10px 25px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; cursor: pointer; font-weight: 500; backdrop-filter: blur(10px); transition: all 0.2s;">
                                            Zur√ºcksetzen
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Branchen-Benchmark -->
                            <div class="chart-container" style="margin-top: 30px;">
                                <h3 style="margin-bottom: 20px; color: var(--color-gray-900); font-size: 18px;">Branchen-Benchmark</h3>
                                <div style="background: white; padding: 30px; border: 1px solid var(--color-gray-200); border-radius: 12px;">
                                    <div style="margin-bottom: 25px;">
                                        <label style="display: block; font-weight: 500; margin-bottom: 10px; color: var(--color-gray-700);">Branche ausw√§hlen:</label>
                                        <select id="industrySelect" onchange="updateBenchmark()" style="width: 100%; padding: 12px; border: 1px solid var(--color-gray-300); border-radius: 8px; font-size: 1rem; cursor: pointer; background: white; color: var(--color-gray-900);">
                                            <option value="retail">Einzelhandel</option>
                                            <option value="gastro">Gastronomie</option>
                                            <option value="it">IT & Software</option>
                                            <option value="consulting">Beratung</option>
                                            <option value="craft">Handwerk</option>
                                            <option value="ecommerce">E-Commerce</option>
                                            <option value="healthcare">Gesundheitswesen</option>
                                        </select>
                                    </div>
                                    
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                                        <!-- Gewinnmarge Vergleich -->
                                        <div style="padding: 20px; background: #f8fafc; border-radius: 12px;">
                                            <div style="font-weight: 500; color: #64748b; margin-bottom: 15px;">Gewinnmarge</div>
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                                <span style="color: #3b82f6; font-weight: 500;">Ihr Wert:</span>
                                                <span style="font-size: 1.5rem; font-weight: bold; color: #3b82f6;">${bwaData.margin}%</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                                <span style="color: #64748b;">Branche √ò:</span>
                                                <span id="benchmarkMargin" style="font-size: 1.2rem; font-weight: bold; color: #64748b;">‚Äî</span>
                                            </div>
                                    
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                                        <!-- Gewinnmarge Vergleich -->
                                        <div style="padding: 20px; background: var(--color-gray-50); border-radius: 12px;">
                                            <div style="font-weight: 500; color: var(--color-gray-600); margin-bottom: 15px;">Gewinnmarge</div>
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                                <span style="color: var(--color-gray-700); font-weight: 500;">Ihr Wert:</span>
                                                <span style="font-size: 1.5rem; font-weight: 600; color: var(--color-gray-900);">${bwaData.margin}%</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                                <span style="color: var(--color-gray-600);">Branche √ò:</span>
                                                <span id="benchmarkMargin" style="font-size: 1.2rem; font-weight: 600; color: var(--color-gray-700);">‚Äî</span>
                                            </div>
                                            <div id="marginStatus" style="text-align: center; padding: 8px; border-radius: 6px; font-size: 0.9rem; font-weight: 500; margin-top: 10px; background: var(--color-gray-100); color: var(--color-gray-700);">‚Äî</div>
                                        </div>
                                        
                                        <!-- Personalkosten Vergleich -->
                                        <div style="padding: 20px; background: var(--color-gray-50); border-radius: 12px;">
                                            <div style="font-weight: 500; color: var(--color-gray-600); margin-bottom: 15px;">Personalkosten</div>
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                                <span style="color: var(--color-gray-700); font-weight: 500;">Ihr Wert:</span>
                                                <span style="font-size: 1.5rem; font-weight: 600; color: var(--color-gray-900);">${bwaData.personalCostRatio || 0}%</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                                <span style="color: var(--color-gray-600);">Branche √ò:</span>
                                                <span id="benchmarkPersonal" style="font-size: 1.2rem; font-weight: 600; color: var(--color-gray-700);">‚Äî</span>
                                            </div>
                                            <div id="personalStatus" style="text-align: center; padding: 8px; border-radius: 6px; font-size: 0.9rem; font-weight: 500; margin-top: 10px; background: var(--color-gray-100); color: var(--color-gray-700);">‚Äî</div>
                                        </div>
                                        
                                        <!-- Fixkostenquote Vergleich -->
                                        <div style="padding: 20px; background: var(--color-gray-50); border-radius: 12px;">
                                            <div style="font-weight: 500; color: var(--color-gray-600); margin-bottom: 15px;">Fixkostenquote</div>
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                                <span style="color: var(--color-gray-700); font-weight: 500;">Ihr Wert:</span>
                                                <span style="font-size: 1.5rem; font-weight: 600; color: var(--color-gray-900);">${(((bwaData.fixedCosts || 0) / bwaData.revenue) * 100).toFixed(0)}%</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                                <span style="color: var(--color-gray-600);">Branche √ò:</span>
                                                <span id="benchmarkFixed" style="font-size: 1.2rem; font-weight: 600; color: var(--color-gray-700);">‚Äî</span>
                                            </div>
                                            <div id="fixedStatus" style="text-align: center; padding: 8px; border-radius: 6px; font-size: 0.9rem; font-weight: 500; margin-top: 10px; background: var(--color-gray-100); color: var(--color-gray-700);">‚Äî</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Gesch√§ftsentwicklung -->
                            <div class="chart-container" style="margin-top: 30px;">
                                <div style="background: linear-gradient(to right, #f0f9ff, #e0f2fe); padding: 30px; border-radius: 12px; border: 1px solid #bae6fd;">
                                    <h3 style="margin-bottom: 20px; color: #0c4a6e; font-size: 18px; font-weight: 600;">Aktuelle Kennzahlen</h3>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                        <div style="text-align: center; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                            <h4 style="color: #1e40af; font-weight: 600;">Umsatzrentabilit√§t</h4>
                                            <div style="font-size: 2rem; font-weight: 600; color: #0f172a; margin: 10px 0;">${bwaData.margin}%</div>
                                            <p style="color: #64748b; font-size: 0.9rem;">${bwaData.margin > 20 ? 'Sehr gut' : bwaData.margin > 10 ? 'Gut' : 'Verbesserungsbedarf'}</p>
                                        </div>
                                        <div style="text-align: center; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                            <h4 style="color: #1e40af; font-weight: 600;">Kostenquote</h4>
                                            <div style="font-size: 2rem; font-weight: 600; color: #0f172a; margin: 10px 0;">${((bwaData.costs / bwaData.revenue) * 100).toFixed(1)}%</div>
                                            <p style="color: #64748b; font-size: 0.9rem;">Anteil der Kosten am Umsatz</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Trend-Chart erstellen nach DOM-Update
                setTimeout(() => {
                    createTrendChart(historicalData);
                    initializeScenario(bwaData);
                    updateBenchmark();
                }, 100);
            }

            // Scoring Section aktualisieren
            const scoringSection = document.getElementById('scoring-section');
            if (scoringSection) {
                const score = calculateBusinessScore(bwaData);
                scoringSection.innerHTML = `
                    <div class="container">
                        <div class="header">
                            <h1>Scoring</h1>
                            <p>Unternehmens-Bewertung basierend auf ${filename}</p>
                        </div>
                        <div class="content">
                            <div style="text-align: center; margin: 40px 0;">
                                <div style="width: 150px; height: 150px; border-radius: 50%; background: conic-gradient(#3b82f6 0deg ${score * 3.6}deg, #e5e7eb ${score * 3.6}deg 360deg); margin: 0 auto; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.2);">
                                    <div style="width: 120px; height: 120px; border-radius: 50%; background: white; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                                        <div style="font-size: 2.5rem; font-weight: 600; color: #1e40af;">${score}</div>
                                        <div style="font-size: 0.9rem; color: #64748b;">von 100</div>
                                    </div>
                                </div>
                                <h3 style="margin: 20px 0; color: #0f172a; font-weight: 600;">Gesamtbewertung: ${getScoreRating(score)}</h3>
                            </div>
                            
                            <div class="dashboard-grid">
                                <div class="metric-card" style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border: 1px solid #bfdbfe;">
                                    <h4 style="color: #1e40af; margin-bottom: 15px; font-weight: 600;">Rentabilit√§t</h4>
                                    <div style="font-size: 1.5rem; font-weight: 600; color: #0c4a6e;">${bwaData.margin > 15 ? '85' : bwaData.margin > 8 ? '70' : '45'}/100</div>
                                    <p style="color: #475569; margin-top: 10px;">${bwaData.margin}% Gewinnmarge</p>
                                </div>
                                <div class="metric-card" style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border: 1px solid #bfdbfe;">
                                    <h4 style="color: #1e40af; margin-bottom: 15px; font-weight: 600;">Effizienz</h4>
                                    <div style="font-size: 1.5rem; font-weight: 600; color: #0c4a6e;">${bwaData.costs / bwaData.revenue < 0.7 ? '90' : bwaData.costs / bwaData.revenue < 0.8 ? '75' : '60'}/100</div>
                                    <p style="color: #475569; margin-top: 10px;">Kostenmanagement</p>
                                </div>
                                <div class="metric-card" style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border: 1px solid #bfdbfe;">
                                    <h4 style="color: #1e40af; margin-bottom: 15px; font-weight: 600;">Wachstum</h4>
                                    <div style="font-size: 1.5rem; font-weight: 600; color: #0c4a6e;">75/100</div>
                                    <p style="color: #475569; margin-top: 10px;">Potenzial erkannt</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Recommendations Section aktualisieren
            const recommendationsSection = document.getElementById('recommendations-section');
            if (recommendationsSection) {
                const recommendations = generateRecommendations(bwaData);
                
                const priorityColors = {
                    'critical': { bg: '#fee2e2', border: '#dc2626', badge: '#991b1b' },
                    'high': { bg: '#fed7aa', border: '#ea580c', badge: '#c2410c' },
                    'medium': { bg: '#fef3c7', border: '#f59e0b', badge: '#d97706' },
                    'low': { bg: '#d1fae5', border: '#10b981', badge: '#059669' }
                };
                
                const typeColors = {
                    'error': { bg: '#fee2e2', border: '#dc2626' },
                    'warning': { bg: '#fed7aa', border: '#ea580c' },
                    'info': { bg: '#e0f2fe', border: '#0284c7' },
                    'success': { bg: '#d1fae5', border: '#10b981' }
                };
                
                recommendationsSection.innerHTML = `
                    <div class="container">
                        <div class="header">
                            <h1>üí° Handlungsempfehlungen</h1>
                            <p>Detaillierte KI-Analyse und Aktionsplan f√ºr ${filename}</p>
                        </div>
                        <div class="content">
                            <div style="background: #f0f9ff; border: 2px solid #0284c7; padding: 20px; border-radius: 12px; margin-bottom: 30px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <div>
                                        <h3 style="color: #0c4a6e; margin-bottom: 10px;">ü§ñ KI-gest√ºtzte Unternehmensanalyse</h3>
                                        <p style="color: #374151;">Basierend auf Ihren BWA-Daten haben wir ${recommendations.length} individuelle Handlungsempfehlungen mit insgesamt ${recommendations.reduce((sum, rec) => sum + (rec.checklist ? rec.checklist.length : 0), 0)} konkreten Ma√ünahmen erstellt.</p>
                                    </div>
                                    <div style="min-width: 200px; text-align: right;">
                                        <label style="color: #0c4a6e; font-weight: bold; display: block; margin-bottom: 8px;">Filter nach Priorit√§t:</label>
                                        <select id="priorityFilter" onchange="filterRecommendations()" style="padding: 10px 15px; border: 2px solid #0284c7; border-radius: 8px; background: white; color: #0c4a6e; font-weight: 600; cursor: pointer; width: 100%;">
                                            <option value="all">üîç Alle anzeigen</option>
                                            <option value="critical">üö® Critical</option>
                                            <option value="high">‚ö†Ô∏è High</option>
                                            <option value="medium">üìã Medium</option>
                                            <option value="low">‚úÖ Low</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="recommendationsContainer">
                            
                            ${recommendations.map((rec, index) => {
                                const colors = typeColors[rec.type] || typeColors.info;
                                const priorityColor = rec.priority ? priorityColors[rec.priority] : null;
                                
                                return `
                                    <div data-priority="${rec.priority || 'medium'}" style="background: white; border: 2px solid ${colors.border}; border-radius: 16px; padding: 30px; margin-bottom: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                                            <h3 style="color: #1a1a2e; font-size: 1.5rem;">${rec.icon} ${rec.title}</h3>
                                            ${priorityColor ? `
                                                <span style="background: ${priorityColor.badge}; color: white; padding: 6px 16px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase;">
                                                    ${rec.priority}
                                                </span>
                                            ` : ''}
                                        </div>
                                        
                                        <div style="background: ${colors.bg}; padding: 20px; border-radius: 12px; border-left: 4px solid ${colors.border}; margin-bottom: 20px;">
                                            <p style="color: #374151; font-size: 1.05rem; line-height: 1.6; margin-bottom: 0;">${rec.description}</p>
                                        </div>
                                        
                                        ${rec.details && rec.details.length > 0 ? `
                                            <div style="margin-bottom: 20px;">
                                                <h4 style="color: #374151; margin-bottom: 12px; font-size: 1.1rem;">üìã Detailanalyse</h4>
                                                <ul style="list-style: none; padding: 0;">
                                                    ${rec.details.map(detail => `
                                                        <li style="padding: 10px 0; padding-left: 25px; border-bottom: 1px solid #e5e7eb; position: relative;">
                                                            <span style="position: absolute; left: 0; color: ${colors.border};">‚Ä¢</span>
                                                            <span style="color: #4b5563;">${detail}</span>
                                                        </li>
                                                    `).join('')}
                                                </ul>
                                            </div>
                                        ` : ''}
                                        
                                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                                            <h4 style="color: white; margin-bottom: 10px; font-size: 1.1rem;">üéØ Empfohlene Ma√ünahme</h4>
                                            <p style="color: white; margin: 0; font-size: 1rem; line-height: 1.6;">${rec.action}</p>
                                        </div>
                                        
                                        ${rec.checklist && rec.checklist.length > 0 ? `
                                            <div style="background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0;">
                                                <h4 style="color: #1e293b; margin-bottom: 15px; font-size: 1.1rem;">‚úÖ Aktions-Checkliste</h4>
                                                <div style="space-y: 10px;">
                                                    ${rec.checklist.map((item, idx) => `
                                                        <label style="display: flex; align-items: start; padding: 12px; background: white; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; border: 2px solid transparent;" 
                                                               onmouseover="this.style.borderColor='${colors.border}'"
                                                               onmouseout="this.style.borderColor='transparent'">
                                                            <input type="checkbox" 
                                                                   id="check_${index}_${idx}" 
                                                                   onchange="saveChecklistState()"
                                                                   style="margin-right: 12px; margin-top: 4px; width: 18px; height: 18px; cursor: pointer;">
                                                            <span style="color: #374151; flex: 1; line-height: 1.5;">${item.task}</span>
                                                        </label>
                                                    `).join('')}
                                                </div>
                                                <div style="margin-top: 15px; padding: 12px; background: #e0f2fe; border-radius: 8px; text-align: center;">
                                                    <span style="color: #0c4a6e; font-size: 0.9rem;">
                                                        <strong id="progress_${index}">0</strong> von <strong>${rec.checklist.length}</strong> Aufgaben erledigt
                                                    </span>
                                                </div>
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                            </div>
                            
                            <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 30px; border-radius: 16px; text-align: center; color: white; margin-top: 40px;">
                                <h3 style="margin-bottom: 15px;">üöÄ N√§chste Schritte</h3>
                                <p style="margin-bottom: 20px; opacity: 0.95;">Arbeiten Sie die Checklisten der Priorit√§t nach ab. Bei Fragen stehen wir Ihnen zur Verf√ºgung.</p>
                                <button onclick="printRecommendations()" style="background: white; color: #059669; padding: 12px 24px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-right: 10px;">
                                    üìÑ Als PDF exportieren
                                </button>
                                <button onclick="alert('E-Mail-Funktion kommt bald!')" style="background: rgba(255,255,255,0.2); color: white; padding: 12px 24px; border: 1px solid white; border-radius: 8px; font-weight: bold; cursor: pointer;">
                                    üìß Per E-Mail senden
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Checklist-Progress aktualisieren
                setTimeout(() => {
                    recommendations.forEach((rec, index) => {
                        if (rec.checklist) {
                            updateChecklistProgress(index, rec.checklist.length);
                        }
                    });
                }, 100);
            }

            // Analytics Section aktualisieren
            const analyticsSection = document.getElementById('analytics-section');
            if (analyticsSection) {
                analyticsSection.innerHTML = `
                    <div class="container">
                        <div class="header">
                            <h1>Analytics</h1>
                            <p>Detaillierte Unternehmensanalyse f√ºr ${filename}</p>
                        </div>
                        <div class="content">
                            <!-- Analytics KPI Cards -->
                            <div style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); padding: 30px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 4px 6px -1px rgba(30, 64, 175, 0.1);">
                                <h3 style="color: white; margin-bottom: 20px; font-size: 18px; font-weight: 600;">Schl√ºsselkennzahlen</h3>
                                <div class="dashboard-grid">
                                    <div class="metric-card" style="background: rgba(255, 255, 255, 0.95); border: none;">
                                        <h4 style="color: #1e40af; margin-bottom: 15px; font-weight: 600;">Umsatzanalyse</h4>
                                        <div style="font-size: 1.8rem; font-weight: 600; color: #0f172a; margin-bottom: 10px;">${bwaData.revenue.toLocaleString()}‚Ç¨</div>
                                        <div style="font-size: 0.9rem; color: #475569;">
                                            <p style="margin: 4px 0;">‚Ä¢ Monatsumsatz</p>
                                            <p style="margin: 4px 0;">‚Ä¢ ${bwaData.revenue > 100000 ? '√úberdurchschnittlich' : 'Durchschnittlich'}</p>
                                            <p style="margin: 4px 0;">‚Ä¢ Trend: ${Math.random() > 0.5 ? 'Steigend ‚Üó' : 'Stabil ‚Üí'}</p>
                                        </div>
                                    </div>
                                    <div class="metric-card" style="background: rgba(255, 255, 255, 0.95); border: none;">
                                        <h4 style="color: #0ea5e9; margin-bottom: 15px; font-weight: 600;">Kostenstruktur</h4>
                                        <div style="font-size: 1.8rem; font-weight: 600; color: #0f172a; margin-bottom: 10px;">${((bwaData.costs / bwaData.revenue) * 100).toFixed(1)}%</div>
                                        <div style="font-size: 0.9rem; color: #475569;">
                                            <p style="margin: 4px 0;">‚Ä¢ Kostenquote</p>
                                            <p style="margin: 4px 0;">‚Ä¢ ${bwaData.costs / bwaData.revenue < 0.7 ? 'Effizient' : 'Optimierbar'}</p>
                                            <p style="margin: 4px 0;">‚Ä¢ Branchenvgl: ${bwaData.costs / bwaData.revenue < 0.75 ? 'Besser ‚úì' : 'Durchschnitt'}</p>
                                        </div>
                                    </div>
                                    <div class="metric-card" style="background: rgba(255, 255, 255, 0.95); border: none;">
                                        <h4 style="color: #3b82f6; margin-bottom: 15px; font-weight: 600;">Profitabilit√§t</h4>
                                        <div style="font-size: 1.8rem; font-weight: 600; color: #0f172a; margin-bottom: 10px;">${bwaData.margin}%</div>
                                        <div style="font-size: 0.9rem; color: #475569;">
                                            <p style="margin: 4px 0;">‚Ä¢ Gewinnmarge</p>
                                            <p style="margin: 4px 0;">‚Ä¢ ${bwaData.margin > 20 ? 'Exzellent' : bwaData.margin > 10 ? 'Gut' : 'Verbesserbar'}</p>
                                            <p style="margin: 4px 0;">‚Ä¢ ROI: ${(bwaData.margin * 2).toFixed(1)}%</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Detailanalyse -->
                            <div style="background: linear-gradient(to right, #f0f9ff, #dbeafe); border-radius: 12px; padding: 30px; border: 1px solid #bfdbfe;">
                                <h3 style="margin-bottom: 20px; color: #0c4a6e; font-weight: 600; font-size: 18px;">Detailanalyse</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                                        <h4 style="color: #1e40af; margin-bottom: 15px; font-weight: 600;">Kennzahlen</h4>
                                        <div style="space-y: 10px;">
                                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                                <span style="color: #475569;">Umsatzrendite:</span>
                                                <strong style="color: #0f172a;">${bwaData.margin}%</strong>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                                <span style="color: #475569;">Kostenquote:</span>
                                                <strong style="color: #0f172a;">${((bwaData.costs / bwaData.revenue) * 100).toFixed(1)}%</strong>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                                <span style="color: #475569;">Break-Even:</span>
                                                <strong style="color: #0f172a;">${bwaData.costs.toLocaleString()}‚Ç¨</strong>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                                                <span style="color: #475569;">Liquidit√§tsreserve:</span>
                                                <strong style="color: #0f172a;">${(bwaData.liquidityMonths || 0).toFixed(1)} Monate</strong>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                                        <h4 style="color: #0ea5e9; margin-bottom: 15px; font-weight: 600;">Benchmarks</h4>
                                        <div style="space-y: 10px;">
                                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                                <span style="color: #475569;">Branchenschnitt:</span>
                                                <strong style="color: #0f172a;">15-25%</strong>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                                <span style="color: #475569;">Ihr Wert:</span>
                                                <strong style="color: ${bwaData.margin > 15 ? '#10b981' : '#f59e0b'};">${bwaData.margin}%</strong>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                                <span style="color: #475569;">Bewertung:</span>
                                                <strong style="color: ${bwaData.margin > 20 ? '#10b981' : bwaData.margin > 10 ? '#f59e0b' : '#ef4444'};">${bwaData.margin > 20 ? 'Sehr gut' : bwaData.margin > 10 ? 'Gut' : 'Verbesserbar'}</strong>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                                                <span style="color: #475569;">Status:</span>
                                                <span style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: ${bwaData.margin > 20 ? '#10b981' : bwaData.margin > 10 ? '#f59e0b' : '#ef4444'};"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function calculateBusinessScore(bwaData) {
            let score = 0;
            
            // Rentabilit√§t (40% des Scores)
            if (bwaData.margin > 20) score += 40;
            else if (bwaData.margin > 15) score += 35;
            else if (bwaData.margin > 10) score += 25;
            else if (bwaData.margin > 5) score += 15;
            else score += 5;
            
            // Effizienz (30% des Scores)
            const costRatio = bwaData.costs / bwaData.revenue;
            if (costRatio < 0.6) score += 30;
            else if (costRatio < 0.7) score += 25;
            else if (costRatio < 0.8) score += 20;
            else if (costRatio < 0.9) score += 10;
            else score += 5;
            
            // Stabilit√§t (30% des Scores) - basierend auf Gewinn
            if (bwaData.profit > 50000) score += 30;
            else if (bwaData.profit > 20000) score += 25;
            else if (bwaData.profit > 10000) score += 20;
            else if (bwaData.profit > 0) score += 15;
            else score += 0;
            
            return Math.min(100, score);
        }

        function getScoreRating(score) {
            if (score >= 90) return 'Exzellent';
            if (score >= 80) return 'Sehr gut';
            if (score >= 70) return 'Gut';
            if (score >= 60) return 'Befriedigend';
            if (score >= 50) return 'Ausreichend';
            return 'Verbesserungsbedarf';
        }

        function generateRecommendations(bwaData) {
            const recommendations = [];
            const costRatio = (bwaData.costs / bwaData.revenue) * 100;
            
            // 1. Rentabilit√§tsanalyse
            if (bwaData.margin > 25) {
                recommendations.push({
                    type: 'success',
                    icon: 'üéâ',
                    title: 'Exzellente Rentabilit√§t',
                    description: `Mit ${bwaData.margin}% Gewinnmarge liegen Sie deutlich √ºber dem Branchendurchschnitt von 15-20%. Ihre Kostenstruktur ist hocheffizient und gibt Ihnen einen starken Wettbewerbsvorteil.`,
                    details: [
                        'Ihre Gewinnmarge √ºbertrifft 95% der Unternehmen in Ihrer Gr√∂√üenklasse',
                        'Aktueller Cashflow erm√∂glicht strategische Investitionen',
                        'Starke Position f√ºr Preisverhandlungen mit Lieferanten'
                    ],
                    action: 'Strategische Expansion: Nutzen Sie Ihre starke Liquidit√§t f√ºr Wachstumsinvestitionen in neue M√§rkte oder Produktlinien. Pr√ºfen Sie M&A-M√∂glichkeiten oder Kapazit√§tserweiterungen.',
                    priority: 'low',
                    checklist: [
                        { task: 'Investitionsplan f√ºr die n√§chsten 12 Monate erstellen', done: false },
                        { task: 'Wachstumsm√§rkte und -chancen identifizieren', done: false },
                        { task: 'ROI-Analyse f√ºr potenzielle Projekte durchf√ºhren', done: false },
                        { task: 'Reserven f√ºr Marktschwankungen bilden', done: false }
                    ]
                });
            } else if (bwaData.margin >= 15 && bwaData.margin <= 25) {
                recommendations.push({
                    type: 'info',
                    icon: '‚úÖ',
                    title: 'Gesunde Gewinnmarge',
                    description: `Mit ${bwaData.margin}% Gewinnmarge bewegen Sie sich im empfohlenen Bereich. Es besteht dennoch Optimierungspotenzial zu den Top-Performern.`,
                    details: [
                        'Solide Grundlage f√ºr nachhaltiges Wachstum',
                        'Puffer f√ºr wirtschaftliche Schwankungen vorhanden',
                        'Weitere 5-10% Margenverbesserung realistisch'
                    ],
                    action: 'Margin-Optimierung: Analysieren Sie Ihre gr√∂√üten Kostentreiber. Potenzial besteht oft in Automatisierung, Prozessoptimierung und strategischen Einkaufsverhandlungen.',
                    priority: 'medium',
                    checklist: [
                        { task: 'Top 10 Kostenbl√∂cke identifizieren und priorisieren', done: false },
                        { task: 'Benchmark mit Wettbewerbern durchf√ºhren', done: false },
                        { task: 'Quick-Win-Ma√ünahmen zur Kostensenkung umsetzen', done: false },
                        { task: 'Preiserh√∂hungspotenziale bei Bestandskunden pr√ºfen', done: false }
                    ]
                });
            } else if (bwaData.margin >= 10 && bwaData.margin < 15) {
                recommendations.push({
                    type: 'warning',
                    icon: '‚ö†Ô∏è',
                    title: 'Gewinnmarge unter Zielbereich',
                    description: `Bei ${bwaData.margin}% Gewinnmarge liegen Sie unter dem empfohlenen Minimum von 15%. Dies schr√§nkt Ihre Handlungsf√§higkeit bei Marktver√§nderungen ein.`,
                    details: [
                        'Geringe Pufferreserven bei Umsatzr√ºckg√§ngen',
                        'Eingeschr√§nkter Spielraum f√ºr Investitionen',
                        'Gefahr der Unterfinanzierung bei Wachstum',
                        'Erh√∂htes Risiko bei Kostensteigerungen'
                    ],
                    action: 'Sofortma√ünahmen erforderlich: F√ºhren Sie eine umfassende Kosten-Nutzen-Analyse durch. Pr√ºfen Sie Preisanpassungen, Produktportfolio-Optimierung und Effizienzsteigerungen in allen Bereichen.',
                    priority: 'high',
                    checklist: [
                        { task: 'Notfallplan f√ºr Kostenreduktion erstellen', done: false },
                        { task: 'Alle Produkte/Services auf Profitabilit√§t pr√ºfen', done: false },
                        { task: 'Preisstruktur marktgerecht anpassen', done: false },
                        { task: 'Automatisierungspotenziale identifizieren', done: false },
                        { task: 'Nicht-rentable Gesch√§ftsbereiche evaluieren', done: false }
                    ]
                });
            } else {
                recommendations.push({
                    type: 'error',
                    icon: 'üö®',
                    title: 'Kritische Rentabilit√§tssituation',
                    description: `Mit ${bwaData.margin}% Gewinnmarge befindet sich Ihr Unternehmen in einer kritischen Situation. Sofortma√ünahmen sind dringend erforderlich.`,
                    details: [
                        'Unternehmensfortbestand gef√§hrdet',
                        'Keine Reserven f√ºr Krisensituationen',
                        'Investitionen praktisch unm√∂glich',
                        'Hohe Insolvenzgefahr bei Umsatzeinbruch'
                    ],
                    action: 'Krisenmanagement: Leiten Sie SOFORT ein strukturiertes Sanierungsprogramm ein. Fokus auf Cash-Erhaltung, drastische Kostensenkungen und Neuausrichtung des Gesch√§ftsmodells. Externe Beratung dringend empfohlen.',
                    priority: 'critical',
                    checklist: [
                        { task: 'Liquidit√§tsplanung f√ºr die n√§chsten 3 Monate', done: false },
                        { task: 'Alle nicht-essentiellen Kosten SOFORT stoppen', done: false },
                        { task: 'Verhandlungen mit Gl√§ubigern/Banken einleiten', done: false },
                        { task: 'Sanierungsberater hinzuziehen', done: false },
                        { task: 'Gesch√§ftsmodell fundamental √ºberpr√ºfen', done: false },
                        { task: 'Personal- und Kapazit√§tsplanung anpassen', done: false }
                    ]
                });
            }

            // 2. Kostenstruktur-Analyse
            if (costRatio > 85) {
                recommendations.push({
                    type: 'error',
                    icon: 'üí∞',
                    title: 'Alarmierende Kostenbelastung',
                    description: `Kosten machen ${costRatio.toFixed(1)}% des Umsatzes aus. Dies ist nicht nachhaltig und erfordert sofortiges Handeln.`,
                    details: [
                        'Extrem hohe Kostenquote gef√§hrdet Unternehmen',
                        'Praktisch kein Spielraum f√ºr Investitionen',
                        'Jede Umsatzschwankung wird existenzbedrohend',
                        'Wettbewerbsf√§higkeit stark eingeschr√§nkt'
                    ],
                    action: 'Radikales Kostenmanagement: Implementieren Sie ein Zero-Based-Budget. Jede Ausgabe muss neu gerechtfertigt werden. Pr√ºfen Sie Outsourcing, Automatisierung und Prozessverschlankung.',
                    priority: 'critical',
                    checklist: [
                        { task: 'Alle Vertr√§ge und Abonnements auf K√ºndigungspotenzial pr√ºfen', done: false },
                        { task: 'Personalkosten analysieren und optimieren', done: false },
                        { task: 'Lieferantenverhandlungen mit min. 15% Ziel starten', done: false },
                        { task: 'Raumkosten reduzieren (Untervermietung, Umzug)', done: false },
                        { task: 'IT und Software-Lizenzen konsolidieren', done: false }
                    ]
                });
            } else if (costRatio > 75) {
                recommendations.push({
                    type: 'warning',
                    icon: 'üìä',
                    title: 'Hohe Kostenquote',
                    description: `Mit ${costRatio.toFixed(1)}% Kostenanteil am Umsatz liegt Ihre Kostenquote √ºber dem Branchendurchschnitt von 70-75%.`,
                    details: [
                        'Eingeschr√§nkte Flexibilit√§t bei Marktschwankungen',
                        'Wettbewerbsnachteil gegen√ºber effizienteren Konkurrenten',
                        'Limitierter Spielraum f√ºr Preisnachl√§sse'
                    ],
                    action: 'Strukturierte Kostenoptimierung: Erstellen Sie einen 6-Monats-Plan zur Kostenreduktion. Ziel sollte sein, die Kostenquote auf unter 75% zu senken.',
                    priority: 'high',
                    checklist: [
                        { task: 'Kostenanalyse nach Kategorien durchf√ºhren', done: false },
                        { task: 'Top 3 Einsparpotenziale identifizieren', done: false },
                        { task: 'Einkaufskonditionen neu verhandeln', done: false },
                        { task: 'Prozesseffizienz in allen Abteilungen pr√ºfen', done: false }
                    ]
                });
            }

            // 3. Umsatz- und Wachstumsanalyse
            if (bwaData.revenue > 200000) {
                recommendations.push({
                    type: 'success',
                    icon: 'üìà',
                    title: 'Starke Umsatzbasis f√ºr Skalierung',
                    description: `Mit ‚Ç¨${bwaData.revenue.toLocaleString()} Monatsumsatz haben Sie eine solide Grundlage f√ºr profitables Wachstum erreicht.`,
                    details: [
                        'Kritische Masse f√ºr Skaleneffekte erreicht',
                        'Marktposition erlaubt strategische Investitionen',
                        'Attraktiv f√ºr Investoren und Kooperationspartner',
                        'Potenzial f√ºr Marktf√ºhrerschaft in Nischensegmenten'
                    ],
                    action: 'Skalierungsstrategie: Nutzen Sie Ihre Position f√ºr beschleunigtes Wachstum. Pr√ºfen Sie geografische Expansion, neue Vertriebskan√§le oder erg√§nzende Produktlinien.',
                    priority: 'medium',
                    checklist: [
                        { task: 'Marktanalyse f√ºr Expansionsm√∂glichkeiten', done: false },
                        { task: 'Skalierungskosten kalkulieren', done: false },
                        { task: 'Finanzierungsoptionen f√ºr Wachstum pr√ºfen', done: false },
                        { task: 'Aufbau von F√ºhrungskapazit√§ten planen', done: false }
                    ]
                });
            } else if (bwaData.revenue >= 100000 && bwaData.revenue <= 200000) {
                recommendations.push({
                    type: 'info',
                    icon: 'üéØ',
                    title: 'Wachstumsschwelle erreicht',
                    description: `Bei ‚Ç¨${bwaData.revenue.toLocaleString()} Monatsumsatz stehen Sie an einer wichtigen Schwelle. Der n√§chste Schritt ist die Professionalisierung f√ºr Skalierung.`,
                    details: [
                        'Grundsolides Gesch√§ftsmodell etabliert',
                        'Bereit f√ºr systematisches Wachstum',
                        'Kritischer Punkt f√ºr Professionalisierung',
                        'Entscheidung: Weiteres Wachstum oder Konsolidierung'
                    ],
                    action: 'Professionalisierung: Investieren Sie in Strukturen, Prozesse und Systeme. Bereiten Sie Ihr Unternehmen auf die n√§chste Wachstumsphase vor.',
                    priority: 'medium',
                    checklist: [
                        { task: 'Organisationsstruktur f√ºr Wachstum aufbauen', done: false },
                        { task: 'Prozesse dokumentieren und standardisieren', done: false },
                        { task: 'Management-Dashboard implementieren', done: false },
                        { task: '3-Jahres-Wachstumsplan erstellen', done: false }
                    ]
                });
            } else {
                recommendations.push({
                    type: 'info',
                    icon: 'üå±',
                    title: 'Aufbauphase: Fundament legen',
                    description: `Mit ‚Ç¨${bwaData.revenue.toLocaleString()} Monatsumsatz befinden Sie sich in der Aufbauphase. Fokus sollte auf stabilem Wachstum und solider Basis liegen.`,
                    details: [
                        'Typische Phase f√ºr Startup oder Neuausrichtung',
                        'Fokus auf Produktmarkt-Fit wichtig',
                        'Cashflow-Management entscheidend',
                        'Kundenstamm und Reputation aufbauen'
                    ],
                    action: 'Fundament st√§rken: Konzentrieren Sie sich auf Kundenzufriedenheit, Produktqualit√§t und organisches Wachstum. Vermeiden Sie √ºberm√§√üige Fixkosten.',
                    priority: 'medium',
                    checklist: [
                        { task: 'Kernkundensegment klar definieren', done: false },
                        { task: 'Vertriebsstrategie optimieren', done: false },
                        { task: 'Kundenfeedback systematisch einholen', done: false },
                        { task: 'Marketing-ROI kontinuierlich messen', done: false }
                    ]
                });
            }

            // 4. Cash-Management & Liquidit√§t
            recommendations.push({
                type: 'info',
                icon: 'üíµ',
                title: 'Liquidit√§tsmanagement optimieren',
                description: `Bei ‚Ç¨${bwaData.profit.toLocaleString()} monatlichem Gewinn sollten Sie ${Math.round(bwaData.profit * 3).toLocaleString()}‚Ç¨ als Liquidit√§tsreserve aufbauen.`,
                details: [
                    '3 Monatsgeh√§lter als Notreserve empfohlen',
                    'Forderungsmanagement professionalisieren',
                    'Zahlungsziele mit Lieferanten optimieren',
                    'Working Capital kontinuierlich √ºberwachen'
                ],
                action: 'Finanzpuffer aufbauen: Etablieren Sie eine Liquidit√§tsreserve und optimieren Sie Ihren Cash-Conversion-Cycle.',
                priority: 'medium',
                checklist: [
                    { task: 'Liquidit√§tsplan f√ºr 12 Monate erstellen', done: false },
                    { task: 'Zahlungsbedingungen mit Kunden optimieren', done: false },
                    { task: 'Mahnwesen professionalisieren', done: false },
                    { task: 'T√§gliches Cash-Monitoring einrichten', done: false }
                ]
            });

            // 5. Langfristiges Monitoring
            recommendations.push({
                type: 'info',
                icon: 'üìä',
                title: 'Kontinuierliches Performance-Monitoring',
                description: 'Monatliche BWA-Analysen sind essentiell f√ºr rechtzeitiges Gegensteuern und strategische Entscheidungen.',
                details: [
                    'Fr√ºhwarnsystem f√ºr finanzielle Schieflage',
                    'Basis f√ºr datengetriebene Entscheidungen',
                    'Benchmarking mit Vormonaten und Vorjahren',
                    'Transparenz f√ºr alle Stakeholder'
                ],
                action: 'Reporting-Routine etablieren: Richten Sie einen monatlichen Management-Review-Prozess mit BWA-Analyse ein.',
                priority: 'low',
                checklist: [
                    { task: 'Monatlichen BWA-Review-Termin festlegen', done: false },
                    { task: 'Dashboard mit Schl√ºsselkennzahlen erstellen', done: false },
                    { task: 'Ampelsystem f√ºr kritische KPIs einf√ºhren', done: false },
                    { task: 'Quartalsweise Strategie-Review durchf√ºhren', done: false }
                ]
            });
            
            return recommendations;
        }

        function displayHistory() {
            if (uploadHistory.length === 0) {
                historyTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">Noch keine BWAs hochgeladen</td></tr>';
                return;
            }

            historyTableBody.innerHTML = uploadHistory.map(entry => `
                <tr>
                    <td>${entry.filename}</td>
                    <td>${entry.date}</td>
                    <td style="color: #2196F3; font-weight: bold;">${entry.revenue.toLocaleString()}‚Ç¨</td>
                    <td style="color: #ff9800; font-weight: bold;">${entry.costs.toLocaleString()}‚Ç¨</td>
                    <td style="color: ${entry.profit > 0 ? '#4caf50' : '#f44336'}; font-weight: bold;">${entry.profit.toLocaleString()}‚Ç¨</td>
                    <td><span style="color: #64748b;">üìä Generiert</span></td>
                    <td>
                        <button class="btn btn-primary" onclick="showDetails(${entry.timestamp})">Details</button>
                        <button class="btn btn-danger" onclick="deleteEntry(${entry.timestamp})">L√∂schen</button>
                    </td>
                </tr>
            `).join('');
        }

        function showDetails(timestamp) {
            const entry = uploadHistory.find(e => e.timestamp === timestamp);
            if (!entry) return;
            alert(`BWA Details:\n\nDatei: ${entry.filename}\nUmsatz: ${entry.revenue.toLocaleString()}‚Ç¨\nKosten: ${entry.costs.toLocaleString()}‚Ç¨\nGewinn: ${entry.profit.toLocaleString()}‚Ç¨\nMarge: ${entry.margin}%`);
        }

        function deleteEntry(timestamp) {
            if (confirm('BWA-Upload wirklich l√∂schen?')) {
                uploadHistory = uploadHistory.filter(e => e.timestamp !== timestamp);
                saveHistory();
                displayHistory();
                showNotification('üóëÔ∏è Upload gel√∂scht', 'success');
            }
        }

        function resetToUpload() {
            document.getElementById('uploadSection').style.display = 'block';
            progressContainer.style.display = 'none';
            successContainer.style.display = 'none';
            dashboard.style.display = 'none';
            fileInput.value = '';
        }

        function loadHistory() {
            try {
                const stored = localStorage.getItem('bwa-upload-history');
                if (stored) {
                    uploadHistory = JSON.parse(stored);
                }
            } catch (e) {
                console.error('Fehler beim Laden der Historie:', e);
            }
        }

        function saveHistory() {
            try {
                localStorage.setItem('bwa-upload-history', JSON.stringify(uploadHistory));
            } catch (e) {
                console.error('Fehler beim Speichern der Historie:', e);
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        function saveChecklistState() {
            // Checklist-Status in LocalStorage speichern
            const checkboxes = document.querySelectorAll('input[type="checkbox"][id^="check_"]');
            const states = {};
            
            checkboxes.forEach(checkbox => {
                states[checkbox.id] = checkbox.checked;
                
                // Progress-Counter aktualisieren
                const match = checkbox.id.match(/check_(\d+)_\d+/);
                if (match) {
                    const recIndex = match[1];
                    updateChecklistProgress(recIndex);
                }
            });
            
            localStorage.setItem('bwa-checklist-states', JSON.stringify(states));
        }

        function loadChecklistStates() {
            try {
                const states = JSON.parse(localStorage.getItem('bwa-checklist-states') || '{}');
                Object.entries(states).forEach(([id, checked]) => {
                    const checkbox = document.getElementById(id);
                    if (checkbox) {
                        checkbox.checked = checked;
                    }
                });
            } catch (e) {
                console.error('Fehler beim Laden der Checklist-States:', e);
            }
        }

        function updateChecklistProgress(recIndex, total) {
            const checkboxes = document.querySelectorAll(`input[type="checkbox"][id^="check_${recIndex}_"]`);
            const checked = Array.from(checkboxes).filter(cb => cb.checked).length;
            const progressEl = document.getElementById(`progress_${recIndex}`);
            
            if (progressEl) {
                progressEl.textContent = checked;
                
                // Wenn alle Aufgaben erledigt sind, Konfetti!
                if (total && checked === total && checked > 0) {
                    showNotification('üéâ Alle Aufgaben dieser Empfehlung abgeschlossen!', 'success');
                }
            }
        }

        function printRecommendations() {
            window.print();
        }

        function filterRecommendations() {
            const filter = document.getElementById('priorityFilter');
            if (!filter) return;
            
            const selectedPriority = filter.value;
            const container = document.getElementById('recommendationsContainer');
            if (!container) return;
            
            const allRecommendations = container.querySelectorAll('[data-priority]');
            let visibleCount = 0;
            
            allRecommendations.forEach(rec => {
                const recPriority = rec.getAttribute('data-priority');
                
                if (selectedPriority === 'all' || selectedPriority === recPriority) {
                    rec.style.display = 'block';
                    visibleCount++;
                } else {
                    rec.style.display = 'none';
                }
            });
            
            // Zeige Hinweis wenn keine Empfehlungen gefunden
            let noResultsMsg = document.getElementById('noResultsMessage');
            if (visibleCount === 0) {
                if (!noResultsMsg) {
                    noResultsMsg = document.createElement('div');
                    noResultsMsg.id = 'noResultsMessage';
                    noResultsMsg.style.cssText = 'text-align: center; padding: 40px; color: #666; font-size: 1.1rem; background: #f8fafc; border-radius: 12px; margin: 20px 0;';
                    noResultsMsg.innerHTML = `
                        <div style="font-size: 3rem; margin-bottom: 15px;">üîç</div>
                        <h3>Keine Empfehlungen in dieser Kategorie</h3>
                        <p style="margin-top: 10px; font-size: 0.9rem;">√Ñndern Sie den Filter, um alle Empfehlungen zu sehen.</p>
                    `;
                    container.appendChild(noResultsMsg);
                }
                noResultsMsg.style.display = 'block';
            } else {
                if (noResultsMsg) {
                    noResultsMsg.style.display = 'none';
                }
            }
            
            // Zeige Statistik
            const priorityLabels = {
                'critical': 'Critical',
                'high': 'High',
                'medium': 'Medium',
                'low': 'Low',
                'all': 'Alle'
            };
            
            showNotification(
                `${visibleCount} Empfehlung${visibleCount !== 1 ? 'en' : ''} gefunden (${priorityLabels[selectedPriority]})`, 
                'info'
            );
        }

        // ============================================
        // AUTHENTICATION & USER MANAGEMENT SYSTEM
        // ============================================

        // User-Status (wird sp√§ter von Supabase bef√ºllt)
        let currentUser = {
            isLoggedIn: false,
            email: null,
            name: 'Gast-Modus',
            tier: 'free', // 'free' | 'basic' | 'premium'
            companyLogo: null,
            userId: null
        };

        // UI basierend auf Login-Status aktualisieren
        function updateUserInterface() {
            const userNameEl = document.getElementById('userName');
            const userTierEl = document.getElementById('userTier');
            const userAvatarEl = document.getElementById('userAvatar');
            const loginButton = document.getElementById('loginButton');

            if (currentUser.isLoggedIn) {
                // User ist eingeloggt
                userNameEl.textContent = currentUser.name || currentUser.email;
                
                // Tier-Badge
                const tierConfig = {
                    'basic': { label: 'Basic', color: '#3b82f6', icon: '‚óè' },
                    'premium': { label: 'Premium', color: '#f59e0b', icon: '‚≠ê' }
                };
                
                const tier = tierConfig[currentUser.tier] || { label: 'Free', color: '#94a3b8', icon: '‚óè' };
                userTierEl.innerHTML = `
                    <span style="display: inline-block; width: 6px; height: 6px; border-radius: 50%; background: ${tier.color}; margin-right: 4px;"></span>
                    ${tier.label}
                `;

                // Avatar: Firmenlogo oder Initialen
                if (currentUser.companyLogo) {
                    userAvatarEl.innerHTML = `<img src="${currentUser.companyLogo}" alt="Logo" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                } else {
                    const initials = currentUser.name ? currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) : 'U';
                    userAvatarEl.textContent = initials;
                }

                // Login-Button zu Logout √§ndern
                loginButton.textContent = 'Abmelden';
                loginButton.onclick = logout;
            } else {
                // Gast-Modus
                userNameEl.textContent = 'Gast-Modus';
                userTierEl.innerHTML = `
                    <span style="display: inline-block; width: 6px; height: 6px; border-radius: 50%; background: var(--color-gray-400); margin-right: 4px;"></span>
                    Free Version
                `;
                userAvatarEl.textContent = 'GS';
                loginButton.textContent = 'Jetzt anmelden';
                loginButton.onclick = showLoginModal;
            }
            
            // Feature-Gating aktualisieren
            updateFeatureGating();
        }

        // Login-Modal anzeigen
        function showLoginModal() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-dialog" style="max-width: 450px;">
                    <h2 style="color: var(--color-gray-900); margin-bottom: 8px;">Willkommen zur√ºck!</h2>
                    <p style="color: var(--color-gray-600); margin-bottom: 24px;">Melden Sie sich an, um Ihre BWA-Historie zu speichern</p>
                    
                    <!-- OAuth-Buttons (sp√§ter Supabase) -->
                    <button onclick="loginWithGoogle()" style="width: 100%; padding: 14px; margin-bottom: 12px; background: white; border: 2px solid var(--color-gray-200); border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 12px; transition: all 0.2s;">
                        <svg width="20" height="20" viewBox="0 0 20 20"><path fill="#4285F4" d="M19.6 10.23c0-.82-.1-1.42-.25-2.05H10v3.72h5.5c-.15.96-.74 2.31-2.04 3.22v2.45h3.16c1.89-1.73 2.98-4.3 2.98-7.34z"/><path fill="#34A853" d="M13.46 15.13c-.83.59-1.96 1-3.46 1-2.64 0-4.88-1.74-5.68-4.15H1.07v2.52C2.72 17.75 6.09 20 10 20c2.7 0 4.96-.89 6.62-2.42l-3.16-2.45z"/><path fill="#FBBC05" d="M3.99 10c0-.69.12-1.35.32-1.97V5.51H1.07A9.973 9.973 0 000 10c0 1.61.39 3.14 1.07 4.49l3.24-2.52c-.2-.62-.32-1.28-.32-1.97z"/><path fill="#EA4335" d="M10 3.88c1.88 0 3.13.81 3.85 1.48l2.84-2.76C14.96.99 12.7 0 10 0 6.09 0 2.72 2.25 1.07 5.51l3.24 2.52C5.12 5.62 7.36 3.88 10 3.88z"/></svg>
                        Mit Google anmelden
                    </button>
                    
                    <button onclick="loginWithMicrosoft()" style="width: 100%; padding: 14px; margin-bottom: 12px; background: white; border: 2px solid var(--color-gray-200); border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 12px; transition: all 0.2s;">
                        <svg width="20" height="20" viewBox="0 0 20 20"><rect fill="#f25022" width="9" height="9"/><rect fill="#00a4ef" x="11" width="9" height="9"/><rect fill="#7fba00" y="11" width="9" height="9"/><rect fill="#ffb900" x="11" y="11" width="9" height="9"/></svg>
                        Mit Microsoft anmelden
                    </button>

                    <div style="margin: 24px 0; text-align: center; color: var(--color-gray-400); font-size: 0.85rem;">oder</div>

                    <!-- Email-Login -->
                    <form onsubmit="loginWithEmail(event)" style="text-align: left;">
                        <input type="email" id="loginEmail" placeholder="E-Mail-Adresse" required style="width: 100%; padding: 12px; margin-bottom: 12px; border: 2px solid var(--color-gray-200); border-radius: 8px; font-size: 1rem;">
                        <input type="password" id="loginPassword" placeholder="Passwort" required style="width: 100%; padding: 12px; margin-bottom: 16px; border: 2px solid var(--color-gray-200); border-radius: 8px; font-size: 1rem;">
                        <button type="submit" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;">
                            Anmelden
                        </button>
                    </form>

                    <p style="margin-top: 16px; font-size: 0.85rem; color: var(--color-gray-600);">
                        Noch kein Konto? <a href="#" onclick="showRegisterModal()" style="color: var(--color-primary); font-weight: 600; text-decoration: none;">Jetzt registrieren</a>
                    </p>

                    <button onclick="closeModal()" style="margin-top: 16px; padding: 10px 24px; background: transparent; color: var(--color-gray-600); border: none; font-size: 0.9rem; cursor: pointer;">
                        Abbrechen
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // ============================================
        // SUPABASE AUTHENTICATION FUNCTIONS
        // ============================================

        // Google OAuth Login
        async function loginWithGoogle() {
            try {
                if (!supabase) {
                    showNotification('‚ö†Ô∏è Supabase nicht konfiguriert. Bitte setup-supabase.sh ausf√ºhren.', 'warning');
                    return;
                }

                showNotification('‚è≥ Weiterleitung zu Google...', 'info');
                
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: window.location.origin + '/bwa-upload-working.html'
                    }
                });

                if (error) throw error;
                
                // Browser wird automatisch zu Google weitergeleitet
            } catch (error) {
                console.error('Google Login Fehler:', error);
                showNotification('‚ùå Google-Login fehlgeschlagen: ' + error.message, 'error');
            }
        }

        // Microsoft OAuth Login
        async function loginWithMicrosoft() {
            try {
                if (!supabase) {
                    showNotification('‚ö†Ô∏è Supabase nicht konfiguriert. Bitte setup-supabase.sh ausf√ºhren.', 'warning');
                    return;
                }

                showNotification('‚è≥ Weiterleitung zu Microsoft...', 'info');
                
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'azure',
                    options: {
                        redirectTo: window.location.origin + '/bwa-upload-working.html',
                        scopes: 'email'
                    }
                });

                if (error) throw error;
                
                // Browser wird automatisch zu Microsoft weitergeleitet
            } catch (error) {
                console.error('Microsoft Login Fehler:', error);
                showNotification('‚ùå Microsoft-Login fehlgeschlagen: ' + error.message, 'error');
            }
        }

        // Email/Passwort Login
        async function loginWithEmail(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showNotification('‚ö†Ô∏è Bitte Email und Passwort eingeben', 'warning');
                return;
            }

            try {
                if (!supabase) {
                    showNotification('‚ö†Ô∏è Supabase nicht konfiguriert. Bitte setup-supabase.sh ausf√ºhren.', 'warning');
                    return;
                }

                showNotification('‚è≥ Anmeldung l√§uft...', 'info');
                
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) throw error;

                // User-Session wurde erstellt
                await loadUserProfile(data.user);
                closeModal();
                showNotification('‚úÖ Erfolgreich angemeldet!', 'success');
                
            } catch (error) {
                console.error('Email Login Fehler:', error);
                
                if (error.message.includes('Invalid login credentials')) {
                    showNotification('‚ùå Falsche Email oder Passwort', 'error');
                } else if (error.message.includes('Email not confirmed')) {
                    showNotification('‚ö†Ô∏è Bitte best√§tigen Sie zuerst Ihre Email-Adresse', 'warning');
                } else {
                    showNotification('‚ùå Anmeldung fehlgeschlagen: ' + error.message, 'error');
                }
            }
        }

        // User-Profil aus Supabase laden
        async function loadUserProfile(authUser) {
            try {
                // Subscription-Status abrufen
                const { data: subscription, error: subError } = await supabase
                    .from('user_subscriptions')
                    .select('tier, status')
                    .eq('user_id', authUser.id)
                    .single();

                if (subError && subError.code !== 'PGRST116') { // PGRST116 = no rows found
                    console.error('Fehler beim Laden der Subscription:', subError);
                }

                // User-Profil abrufen
                const { data: profile, error: profileError } = await supabase
                    .from('user_profiles')
                    .select('firmenname, company_logo_url')
                    .eq('id', authUser.id)
                    .single();

                if (profileError && profileError.code !== 'PGRST116') {
                    console.error('Fehler beim Laden des Profils:', profileError);
                }

                // currentUser-Objekt aktualisieren
                currentUser = {
                    isLoggedIn: true,
                    email: authUser.email,
                    name: profile?.firmenname || authUser.user_metadata?.full_name || authUser.email.split('@')[0],
                    tier: subscription?.tier || 'basic',
                    companyLogo: profile?.company_logo_url || null,
                    userId: authUser.id
                };

                updateUserInterface();
                
            } catch (error) {
                console.error('Fehler beim Laden des User-Profils:', error);
                // Fallback auf Basis-Daten
                currentUser = {
                    isLoggedIn: true,
                    email: authUser.email,
                    name: authUser.email.split('@')[0],
                    tier: 'basic',
                    companyLogo: null,
                    userId: authUser.id
                };
                updateUserInterface();
            }
        }

        // Logout-Funktion
        async function logout() {
            try {
                if (supabase) {
                    const { error } = await supabase.auth.signOut();
                    if (error) throw error;
                }

                // User-State zur√ºcksetzen
                currentUser = {
                    isLoggedIn: false,
                    email: null,
                    name: 'Gast-Modus',
                    tier: 'free',
                    companyLogo: null,
                    userId: null
                };
                
                updateUserInterface();
                showNotification('üëã Erfolgreich abgemeldet', 'info');
                
                // Optional: Zur Upload-Seite zur√ºckkehren
                switchView('upload');
                
            } catch (error) {
                console.error('Logout Fehler:', error);
                showNotification('‚ùå Abmeldung fehlgeschlagen', 'error');
            }
        }

        // Session-Check beim Laden der Seite
        async function checkUserSession() {
            try {
                if (!supabase) {
                    console.log('‚ÑπÔ∏è Supabase nicht konfiguriert - Gast-Modus aktiv');
                    return;
                }

                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) throw error;

                if (session && session.user) {
                    console.log('‚úÖ Bestehende Session gefunden');
                    await loadUserProfile(session.user);
                } else {
                    console.log('‚ÑπÔ∏è Keine aktive Session - Gast-Modus');
                }
            } catch (error) {
                console.error('Fehler beim Session-Check:', error);
            }
        }

        // Auth-State-Listener (reagiert auf Login/Logout)
        function setupAuthListener() {
            if (!supabase) return;

            supabase.auth.onAuthStateChange(async (event, session) => {
                console.log('Auth Event:', event);

                if (event === 'SIGNED_IN' && session) {
                    await loadUserProfile(session.user);
                } else if (event === 'SIGNED_OUT') {
                    currentUser = {
                        isLoggedIn: false,
                        email: null,
                        name: 'Gast-Modus',
                        tier: 'free',
                        companyLogo: null,
                        userId: null
                    };
                    updateUserInterface();
                } else if (event === 'TOKEN_REFRESHED') {
                    console.log('ÔøΩ Token aktualisiert');
                }
            });
        }

        function closeModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) modal.remove();
        }

        // Registrierungs-Modal anzeigen
        function showRegisterModal() {
            closeModal();
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-dialog" style="max-width: 450px;">
                    <h2 style="color: var(--color-gray-900); margin-bottom: 8px;">Kostenloses Konto erstellen</h2>
                    <p style="color: var(--color-gray-600); margin-bottom: 24px;">Speichern Sie Ihre BWA-Historie und behalten Sie den √úberblick</p>
                    
                    <!-- OAuth-Buttons -->
                    <button onclick="loginWithGoogle()" style="width: 100%; padding: 14px; margin-bottom: 12px; background: white; border: 2px solid var(--color-gray-200); border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 12px; transition: all 0.2s;">
                        <svg width="20" height="20" viewBox="0 0 20 20"><path fill="#4285F4" d="M19.6 10.23c0-.82-.1-1.42-.25-2.05H10v3.72h5.5c-.15.96-.74 2.31-2.04 3.22v2.45h3.16c1.89-1.73 2.98-4.3 2.98-7.34z"/><path fill="#34A853" d="M13.46 15.13c-.83.59-1.96 1-3.46 1-2.64 0-4.88-1.74-5.68-4.15H1.07v2.52C2.72 17.75 6.09 20 10 20c2.7 0 4.96-.89 6.62-2.42l-3.16-2.45z"/><path fill="#FBBC05" d="M3.99 10c0-.69.12-1.35.32-1.97V5.51H1.07A9.973 9.973 0 000 10c0 1.61.39 3.14 1.07 4.49l3.24-2.52c-.2-.62-.32-1.28-.32-1.97z"/><path fill="#EA4335" d="M10 3.88c1.88 0 3.13.81 3.85 1.48l2.84-2.76C14.96.99 12.7 0 10 0 6.09 0 2.72 2.25 1.07 5.51l3.24 2.52C5.12 5.62 7.36 3.88 10 3.88z"/></svg>
                        Mit Google registrieren
                    </button>
                    
                    <button onclick="loginWithMicrosoft()" style="width: 100%; padding: 14px; margin-bottom: 12px; background: white; border: 2px solid var(--color-gray-200); border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 12px; transition: all 0.2s;">
                        <svg width="20" height="20" viewBox="0 0 20 20"><rect fill="#f25022" width="9" height="9"/><rect fill="#00a4ef" x="11" width="9" height="9"/><rect fill="#7fba00" y="11" width="9" height="9"/><rect fill="#ffb900" x="11" y="11" width="9" height="9"/></svg>
                        Mit Microsoft registrieren
                    </button>

                    <div style="margin: 24px 0; text-align: center; color: var(--color-gray-400); font-size: 0.85rem;">oder</div>

                    <!-- Email-Registrierung -->
                    <form onsubmit="registerWithEmail(event)" style="text-align: left;">
                        <input type="email" id="registerEmail" placeholder="E-Mail-Adresse" required style="width: 100%; padding: 12px; margin-bottom: 12px; border: 2px solid var(--color-gray-200); border-radius: 8px; font-size: 1rem;">
                        <input type="password" id="registerPassword" placeholder="Passwort (min. 6 Zeichen)" required minlength="6" style="width: 100%; padding: 12px; margin-bottom: 12px; border: 2px solid var(--color-gray-200); border-radius: 8px; font-size: 1rem;">
                        <input type="password" id="registerPasswordConfirm" placeholder="Passwort wiederholen" required minlength="6" style="width: 100%; padding: 12px; margin-bottom: 16px; border: 2px solid var(--color-gray-200); border-radius: 8px; font-size: 1rem;">
                        
                        <label style="display: flex; align-items: start; gap: 8px; margin-bottom: 16px; font-size: 0.85rem; color: var(--color-gray-600);">
                            <input type="checkbox" required style="margin-top: 2px;">
                            <span>Ich akzeptiere die <a href="#" style="color: var(--color-primary); text-decoration: none;">Nutzungsbedingungen</a> und <a href="#" style="color: var(--color-primary); text-decoration: none;">Datenschutzerkl√§rung</a></span>
                        </label>
                        
                        <button type="submit" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;">
                            Kostenloses Konto erstellen
                        </button>
                    </form>

                    <p style="margin-top: 16px; font-size: 0.85rem; color: var(--color-gray-600);">
                        Bereits ein Konto? <a href="#" onclick="showLoginModal()" style="color: var(--color-primary); font-weight: 600; text-decoration: none;">Jetzt anmelden</a>
                    </p>

                    <button onclick="closeModal()" style="margin-top: 16px; padding: 10px 24px; background: transparent; color: var(--color-gray-600); border: none; font-size: 0.9rem; cursor: pointer;">
                        Abbrechen
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Email-Registrierung
        async function registerWithEmail(event) {
            event.preventDefault();
            
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
            
            // Validierung
            if (password !== passwordConfirm) {
                showNotification('‚ö†Ô∏è Passw√∂rter stimmen nicht √ºberein', 'warning');
                return;
            }

            if (password.length < 6) {
                showNotification('‚ö†Ô∏è Passwort muss mindestens 6 Zeichen lang sein', 'warning');
                return;
            }

            try {
                if (!supabase) {
                    showNotification('‚ö†Ô∏è Supabase nicht konfiguriert. Bitte setup-supabase.sh ausf√ºhren.', 'warning');
                    return;
                }

                showNotification('‚è≥ Konto wird erstellt...', 'info');
                
                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        emailRedirectTo: window.location.origin + '/bwa-upload-working.html',
                        data: {
                            registration_date: new Date().toISOString()
                        }
                    }
                });

                if (error) throw error;

                closeModal();

                // Pr√ºfe ob Email-Best√§tigung erforderlich ist
                if (data.user && data.user.identities && data.user.identities.length === 0) {
                    // User existiert bereits
                    showNotification('‚ö†Ô∏è Diese Email-Adresse ist bereits registriert', 'warning');
                    setTimeout(() => showLoginModal(), 2000);
                } else if (data.user && !data.session) {
                    // Email-Best√§tigung erforderlich
                    showNotification('‚úÖ Konto erstellt! Bitte best√§tigen Sie Ihre Email-Adresse.', 'success');
                } else if (data.session) {
                    // Direkter Login (wenn Email-Best√§tigung deaktiviert)
                    await loadUserProfile(data.user);
                    showNotification('‚úÖ Konto erstellt und angemeldet!', 'success');
                }
                
            } catch (error) {
                console.error('Registrierungs-Fehler:', error);
                
                if (error.message.includes('already registered')) {
                    showNotification('‚ö†Ô∏è Diese Email-Adresse ist bereits registriert', 'warning');
                    setTimeout(() => showLoginModal(), 2000);
                } else {
                    showNotification('‚ùå Registrierung fehlgeschlagen: ' + error.message, 'error');
                }
            }
        }

        // Feature-Gating: Pr√ºfen ob User Zugriff hat
        function canAccessFeature(feature) {
            const featureGates = {
                'analytics': ['premium'],
                'recommendations': ['premium'],
                'history': ['basic', 'premium'],
                'trends': ['basic', 'premium'],
                'export_pdf': ['basic', 'premium'],
                'company_logo': ['basic', 'premium']
            };
            
            if (!currentUser.isLoggedIn && (feature === 'history' || feature === 'trends' || feature === 'export_pdf' || feature === 'company_logo')) {
                return false;
            }
            
            return featureGates[feature]?.includes(currentUser.tier) || false;
        }

        // Upgrade-Prompt anzeigen
        function showUpgradePrompt(feature) {
            const featureNames = {
                'analytics': 'Analytics-Bereich',
                'recommendations': 'KI-Empfehlungen',
                'history': 'BWA-Historie',
                'trends': 'Entwicklungstrends'
            };

            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div style="font-size: 3rem; margin-bottom: 16px;">üîí</div>
                    <h2 style="color: var(--color-gray-900); margin-bottom: 8px;">Premium Feature</h2>
                    <p style="color: var(--color-gray-600); margin-bottom: 24px; line-height: 1.6;">
                        Der <strong>${featureNames[feature]}</strong> ist nur f√ºr Premium-Mitglieder verf√ºgbar.
                    </p>
                    
                    <div style="background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%); padding: 20px; border-radius: 12px; margin-bottom: 24px; text-align: left;">
                        <h3 style="color: #ea580c; font-size: 1.1rem; margin-bottom: 12px;">Premium Vorteile:</h3>
                        <ul style="color: var(--color-gray-700); line-height: 1.8; padding-left: 20px;">
                            <li>Vollst√§ndige Analytics mit Detailauswertungen</li>
                            <li>KI-gest√ºtzte Handlungsempfehlungen</li>
                            <li>Erweiterte Branchen-Benchmarks</li>
                            <li>Unbegrenzte Szenario-Simulationen</li>
                            <li>Priorit√§ts-Support</li>
                        </ul>
                        <div style="margin-top: 16px; font-size: 1.5rem; font-weight: 700; color: #ea580c;">
                            Nur 14,99‚Ç¨ / Monat
                        </div>
                    </div>

                    <button onclick="upgradeToPremium()" style="width: 100%; padding: 16px; background: linear-gradient(135deg, #ea580c 0%, #f59e0b 100%); color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer; margin-bottom: 12px; box-shadow: 0 4px 12px rgba(234, 88, 12, 0.3);">
                        Jetzt auf Premium upgraden
                    </button>
                    
                    <button onclick="closeModal()" style="padding: 10px 24px; background: transparent; color: var(--color-gray-600); border: none; font-size: 0.9rem; cursor: pointer;">
                        Vielleicht sp√§ter
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function upgradeToPremium() {
            closeModal();
            
            // Pr√ºfe ob User eingeloggt ist
            if (!currentUser.isLoggedIn) {
                showNotification('‚ö†Ô∏è Bitte melde dich zuerst an', 'warning');
                showLoginModal();
                return;
            }
            
            // Pr√ºfe ob Stripe konfiguriert ist
            if (typeof isStripeConfigured === 'undefined' || !isStripeConfigured()) {
                showNotification('‚ö†Ô∏è Zahlungssystem nicht konfiguriert', 'error');
                console.error('Stripe nicht konfiguriert. Siehe STRIPE_SETUP.md');
                return;
            }
            
            showNotification('üí≥ Zahlungsseite wird vorbereitet...', 'info');
            
            try {
                // Stripe initialisieren falls noch nicht geschehen
                if (!stripe) {
                    await initializeStripe();
                }
                
                if (!stripe) {
                    throw new Error('Stripe konnte nicht initialisiert werden');
                }
                
                // Checkout Session erstellen (via Supabase Edge Function)
                const { data, error } = await supabase.functions.invoke('create-checkout-session', {
                    body: {
                        userId: currentUser.id,
                        userEmail: currentUser.email,
                        priceId: STRIPE_CONFIG.premiumPriceId
                    }
                });
                
                if (error) {
                    throw error;
                }
                
                if (!data || !data.sessionId) {
                    throw new Error('Keine Session-ID erhalten');
                }
                
                // Redirect zu Stripe Checkout
                const result = await stripe.redirectToCheckout({
                    sessionId: data.sessionId
                });
                
                if (result.error) {
                    throw result.error;
                }
                
            } catch (error) {
                console.error('Checkout-Fehler:', error);
                showNotification('‚ùå Fehler beim √ñffnen der Zahlungsseite: ' + error.message, 'error');
            }
        }

        // ============================================
        // FEATURE-GATING: PREMIUM-OVERLAY ANWENDEN
        // ============================================

        function applyFeatureGating() {
            // Analytics-Bereich pr√ºfen
            applyPremiumGate('analytics', 'analyticsContainer');
            
            // Empfehlungen-Bereich pr√ºfen
            applyPremiumGate('recommendations', 'recommendationsContainer');
        }

        function applyPremiumGate(feature, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            // Pr√ºfe ob User Zugriff hat
            const hasAccess = canAccessFeature(feature);

            // Entferne altes Overlay falls vorhanden
            const existingOverlay = container.querySelector('.premium-overlay');
            if (existingOverlay) {
                existingOverlay.remove();
                container.classList.remove('premium-locked');
            }

            // Wenn kein Zugriff: Premium-Overlay hinzuf√ºgen
            if (!hasAccess) {
                container.classList.add('premium-locked');
                
                const featureInfo = {
                    'analytics': {
                        title: 'Advanced Analytics',
                        description: 'Tiefgehende Unternehmensanalyse mit KI-gest√ºtzten Insights',
                        features: [
                            'Detaillierte Umsatzanalyse',
                            'Kostenstruktur-Optimierung',
                            'Profitabilit√§ts-Tracking',
                            'Erweiterte Branchen-Benchmarks',
                            'Predictive Analytics'
                        ]
                    },
                    'recommendations': {
                        title: 'KI-Empfehlungen',
                        description: 'Intelligente Handlungsempfehlungen f√ºr Ihr Business',
                        features: [
                            'Personalisierte Gesch√§ftsempfehlungen',
                            'Priorisierte Aktionspl√§ne',
                            'Best-Practice-Strategien',
                            'Automatische Optimierungsvorschl√§ge',
                            'Erfolgs-Tracking'
                        ]
                    }
                };

                const info = featureInfo[feature];
                
                // Overlay erstellen
                const overlay = document.createElement('div');
                overlay.className = 'premium-overlay';
                
                if (!currentUser.isLoggedIn) {
                    // Nicht eingeloggt: Zeige Login-Prompt
                    overlay.innerHTML = `
                        <div class="premium-badge">
                            ‚≠ê Premium Feature
                        </div>
                        <h2>${info.title}</h2>
                        <p>${info.description}</p>
                        <div class="premium-features">
                            <ul>
                                ${info.features.map(f => `<li>${f}</li>`).join('')}
                            </ul>
                        </div>
                        <p style="font-size: 0.95rem; margin-bottom: 16px;">
                            Melden Sie sich an, um Premium-Features zu nutzen
                        </p>
                        <button class="login-prompt-button" onclick="event.stopPropagation(); showLoginModal();">
                            Jetzt kostenlos anmelden
                        </button>
                    `;
                } else {
                    // Eingeloggt aber nicht Premium: Zeige Upgrade-Prompt
                    overlay.innerHTML = `
                        <div class="premium-badge">
                            ‚≠ê Premium Feature
                        </div>
                        <h2>${info.title}</h2>
                        <p>${info.description}</p>
                        <div class="premium-features">
                            <ul>
                                ${info.features.map(f => `<li>${f}</li>`).join('')}
                            </ul>
                        </div>
                        <div class="premium-price">
                            14,99‚Ç¨ <small>/ Monat</small>
                        </div>
                        <button class="upgrade-button" onclick="event.stopPropagation(); upgradeToPremium();">
                            Jetzt auf Premium upgraden
                        </button>
                        <p style="color: rgba(255, 255, 255, 0.8); font-size: 0.85rem; margin-top: 12px;">
                            Jederzeit k√ºndbar ‚Ä¢ Keine versteckten Kosten
                        </p>
                    `;
                }

                // Event-Handler f√ºr Overlay-Click
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        if (!currentUser.isLoggedIn) {
                            showLoginModal();
                        } else {
                            upgradeToPremium();
                        }
                    }
                });

                container.appendChild(overlay);
            }
        }

        // Feature-Gating aktualisieren wenn User-Status sich √§ndert
        function updateFeatureGating() {
            applyFeatureGating();
        }

        // ============================================
        // PAYMENT CALLBACK HANDLING
        // ============================================

        /**
         * Verarbeitet Stripe Payment Callbacks
         * Wird nach Redirect von Stripe Checkout aufgerufen
         */
        function handlePaymentCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const paymentStatus = urlParams.get('payment');
            const sessionId = urlParams.get('session_id');

            if (paymentStatus === 'success') {
                // Erfolgreiche Zahlung
                showNotification('üéâ Zahlung erfolgreich! Willkommen bei Premium!', 'success');
                
                // Session-ID f√ºr Verification loggen
                if (sessionId) {
                    console.log('‚úÖ Payment Session ID:', sessionId);
                }
                
                // User-Profil neu laden (Tier wurde durch Webhook aktualisiert)
                if (currentUser.isLoggedIn) {
                    setTimeout(async () => {
                        await loadUserProfile();
                        updateUserInterface();
                        showNotification('‚ú® Premium-Features sind jetzt freigeschaltet!', 'success');
                    }, 2000); // 2 Sekunden warten damit Webhook Zeit hat
                }
                
                // URL-Parameter entfernen (f√ºr saubere URL)
                window.history.replaceState({}, document.title, window.location.pathname);
                
            } else if (paymentStatus === 'cancelled') {
                // Abgebrochene Zahlung
                showNotification('‚ÑπÔ∏è Zahlung abgebrochen', 'info');
                
                // URL-Parameter entfernen
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        /**
         * √ñffnet das Stripe Customer Portal f√ºr Subscription-Verwaltung
         * User kann dort:
         * - Rechnungen herunterladen
         * - Zahlungsmethode √§ndern
         * - Subscription k√ºndigen
         */
        async function openCustomerPortal() {
            if (!currentUser.isLoggedIn) {
                showNotification('‚ö†Ô∏è Bitte melde dich zuerst an', 'warning');
                return;
            }

            if (currentUser.tier !== 'premium') {
                showNotification('‚ÑπÔ∏è Du hast aktuell keine Premium-Subscription', 'info');
                return;
            }

            showNotification('üîÑ Portal wird geladen...', 'info');

            try {
                const { data, error } = await supabase.functions.invoke('create-portal-session', {
                    body: {
                        returnUrl: window.location.href
                    }
                });

                if (error) throw error;

                if (data?.url) {
                    window.location.href = data.url;
                } else {
                    throw new Error('Keine Portal-URL erhalten');
                }

            } catch (error) {
                console.error('Portal-Fehler:', error);
                showNotification('‚ùå Fehler beim √ñffnen des Portals: ' + error.message, 'error');
            }
        }

        // ============================================
        // INITIALISIERUNG BEIM SEITENSTART
        // ============================================
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ BWA Insights wird initialisiert...');
            
            // 1. Supabase initialisieren (falls konfiguriert)
            if (typeof initializeSupabase === 'function') {
                const supabaseInit = initializeSupabase();
                if (supabaseInit) {
                    console.log('‚úÖ Supabase erfolgreich verbunden');
                    
                    // 2. Auth-Listener einrichten
                    setupAuthListener();
                    
                    // 3. Bestehende Session pr√ºfen
                    await checkUserSession();
                } else {
                    console.log('‚ö†Ô∏è Supabase nicht konfiguriert - Gast-Modus aktiv');
                    console.log('üí° Tipp: F√ºhren Sie ./setup-supabase.sh aus');
                }
            } else {
                console.log('‚ÑπÔ∏è supabase-config.js nicht geladen - Gast-Modus aktiv');
            }
            
            // 2. Stripe initialisieren (falls konfiguriert)
            if (typeof initializeStripe === 'function') {
                await initializeStripe();
            } else {
                console.log('‚ÑπÔ∏è stripe-config.js nicht geladen - Zahlungen deaktiviert');
            }
            
            // 3. Payment-Callback verarbeiten
            handlePaymentCallback();
            
            // 4. UI initialisieren
            updateUserInterface();
            
            // 5. Feature-Gating anwenden
            applyFeatureGating();
            
            console.log('‚úÖ BWA Insights bereit');
        });

        console.log('üì¶ BWA Upload System mit Authentication geladen');
    </script>
</body>
</html>