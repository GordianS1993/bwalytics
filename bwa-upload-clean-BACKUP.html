<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BWA Upload | BWA-Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
        }
        
        .sidebar-header {
            padding: 24px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.12);
        }
        
        .sidebar-header .icon {
            font-size: 48px;
            color: #4fc3f7;
            margin-bottom: 8px;
        }
        
        .sidebar-header h1 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .sidebar-header .subtitle {
            font-size: 14px;
            color: rgba(255,255,255,0.7);
        }
        
        .user-profile {
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.12);
        }
        
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #4fc3f7;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        
        .user-info h3 {
            font-size: 14px;
            font-weight: 600;
        }
        
        .user-info p {
            font-size: 12px;
            color: rgba(255,255,255,0.7);
        }
        
        .nav-menu {
            padding: 16px;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: white;
        }
        
        .nav-item:hover {
            background: rgba(79, 195, 247, 0.1);
        }
        
        .nav-item.active {
            background: #4fc3f7;
            color: #1a1a2e;
        }
        
        .nav-item .icon {
            margin-right: 12px;
            font-size: 20px;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 24px;
            max-width: calc(100vw - 320px); /* Verhindert √úberlauf */
            box-sizing: border-box;
            overflow-x: auto; /* Scrollbar bei Bedarf */
        }
        
        .page-header {
            margin-bottom: 32px;
        }
        
        .page-header h1 {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .page-header p {
            color: #666;
            font-size: 16px;
        }
        
        /* Upload Zone */
        .upload-section {
            background: white;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 32px;
        }
        
        .upload-zone {
            border: 3px dashed #1976d2;
            border-radius: 12px;
            padding: 80px 40px;
            text-align: center;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 24px;
        }
        
        .upload-zone:hover {
            border-color: #1565c0;
            background: #f0f4ff;
            transform: translateY(-2px);
        }
        
        .upload-zone.dragover {
            border-color: #22c55e;
            background: #f0fdf4;
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 64px;
            color: #1976d2;
            margin-bottom: 24px;
        }
        
        .upload-zone h3 {
            font-size: 24px;
            color: #1976d2;
            margin-bottom: 12px;
            font-weight: 600;
        }
        
        .upload-zone p {
            color: #666;
            font-size: 16px;
            margin-bottom: 24px;
        }
        
        .upload-info {
            display: flex;
            justify-content: center;
            gap: 32px;
            font-size: 14px;
            color: #666;
        }
        
        .upload-info div {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(25, 118, 210, 0.1);
            border-radius: 20px;
        }
        
        /* Progress */
        .progress-container {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 32px;
        }
        
        .progress-header {
            text-align: center;
            margin-bottom: 24px;
        }
        
        .progress-bar {
            width: 100%;
            height: 24px;
            background: #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            margin: 24px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #1976d2, #22c55e);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            text-align: center;
            font-weight: 600;
            color: #374151;
        }
        
        /* Success Message */
        .success-container {
            display: none;
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            border-radius: 12px;
            padding: 32px;
            margin-bottom: 32px;
            text-align: center;
        }
        
        .success-container h3 {
            color: #065f46;
            font-size: 24px;
            margin-bottom: 16px;
        }
        
        /* History */
        .history-section {
            background: white;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-x: auto; /* Horizontales Scrollen erm√∂glichen */
        }
        
        .table-container {
            min-width: 1000px; /* Mindestbreite f√ºr alle Spalten */
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: auto; /* Automatische Spaltenbreiten */
            min-width: 1000px;
        }
        
        th, td {
            text-align: left;
            padding: 12px 8px;
            border-bottom: 1px solid #e5e7eb;
            white-space: nowrap;
        }
        
        /* Datei-Spalte kann umbrechen */
        th:nth-child(1), td:nth-child(1) { 
            max-width: 200px;
            white-space: normal;
            word-break: break-word;
        }
        
        /* Aktions-Spalte fixieren */
        th:nth-child(8), td:nth-child(8) { 
            min-width: 140px;
            position: sticky;
            right: 0;
            background: white;
            box-shadow: -2px 0 4px rgba(0,0,0,0.1);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .section-title {
            font-size: 24px;
            font-weight: 600;
            color: #1a1a2e;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #374151;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            background: #d1fae5;
            color: #065f46;
        }
        
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
        }
        
        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }
        
        .btn-secondary:hover {
            background: #e5e7eb;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            padding: 8px 12px;
            border-radius: 8px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
            text-decoration: none;
            color: inherit;
        }
        
        .action-btn-details {
            background: #f0f4ff;
            color: #1976d2;
            border: 1px solid #e3f2fd;
        }
        
        .action-btn-details:hover {
            background: #e3f2fd;
            border-color: #1976d2;
            transform: translateY(-1px);
        }
        
        .action-btn-delete {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        
        .action-btn-delete:hover {
            background: #fecaca;
            border-color: #dc2626;
            transform: translateY(-1px);
        }
    </style>
    <!-- PDF.js f√ºr PDF-Textextraktion -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // PDF.js Worker konfigurieren
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="icon">üè¢</div>
                <h1>BWA Dashboard</h1>
                <p class="subtitle">Kleinunternehmer</p>
            </div>
            
            <div class="user-profile">
                <div class="avatar">GS</div>
                <div class="user-info">
                    <h3>Gordian Schmitz</h3>
                    <p>Unternehmer</p>
                </div>
            </div>
            
            <nav class="nav-menu">
                <a href="demo.html" class="nav-item">
                    <span class="icon">üìä</span>
                    Dashboard
                </a>
                <a href="bwa-upload-clean.html" class="nav-item active">
                    <span class="icon">‚òÅÔ∏è</span>
                    BWA Upload
                </a>
                <a href="scoring.html" class="nav-item">
                    <span class="icon">üìà</span>
                    Scoring
                </a>
                <a href="recommendations.html" class="nav-item">
                    <span class="icon">üí°</span>
                    Empfehlungen
                </a>
                <a href="analytics.html" class="nav-item">
                    <span class="icon">üìä</span>
                    Analytics
                </a>
            </nav>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <div class="page-header">
                <h1>BWA Upload</h1>
                <p>Laden Sie Ihre BWA-Datei hoch und lassen Sie sie automatisch analysieren</p>
            </div>
            
            <!-- Upload Section -->
            <div class="upload-section">
                <div class="upload-zone" id="uploadZone">
                    <label for="fileInput" style="display: block; cursor: pointer; width: 100%; height: 100%;">
                        <div class="upload-icon">‚òÅÔ∏è</div>
                        <h3>üìÑ Klicken Sie hier, um Ihre BWA-Datei hochzuladen</h3>
                        <p>Ziehen Sie Ihre PDF-Datei hierher oder klicken Sie zum Ausw√§hlen</p>
                        <div class="upload-info">
                            <div>
                                <span>üìÑ</span>
                                Nur PDF-Dateien
                            </div>
                            <div>
                                <span>üìè</span>
                                Max. 50MB
                            </div>
                            <div>
                                <span>üîí</span>
                                Sicher verschl√ºsselt
                            </div>
                        </div>
                    </label>
                    <input type="file" id="fileInput" accept=".pdf" style="display: none;">
                    
                    <!-- EMERGENCY DEBUG PANEL -->
                    <div style="position: fixed; top: 10px; right: 10px; background: #f59e0b; color: white; padding: 10px; border-radius: 8px; z-index: 999999; font-size: 12px; font-family: monospace;">
                        <div>üêõ DEBUG PANEL</div>
                        <button onclick="testFileInput()" style="margin: 5px 0; padding: 5px; background: white; color: black; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                            Test File Input
                        </button>
                        <button onclick="testConsole()" style="margin: 5px 0; padding: 5px; background: white; color: black; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                            Test Console
                        </button>
                        <button onclick="testUpload()" style="margin: 5px 0; padding: 5px; background: white; color: black; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                            Test Upload
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Progress Container -->
            <div class="progress-container" id="progressContainer">
                <div class="progress-header">
                    <h3>üîÑ BWA wird verarbeitet...</h3>
                    <p>Ihre Datei wird analysiert und die Kennzahlen extrahiert</p>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <p class="progress-text" id="progressText">0% - Wird gestartet...</p>
            </div>
            
            <!-- Success Container -->
            <div class="success-container" id="successContainer">
                <h3>‚úÖ BWA erfolgreich verarbeitet!</h3>
                <div id="successDetails">Ihre BWA wurde erfolgreich analysiert.</div>
            </div>
            
            <!-- History Section -->
            <div class="history-section">
                <div class="section-header">
                    <h3 class="section-title">üìã Upload-Historie</h3>
                    <button onclick="refreshHistory()" class="btn btn-secondary">üîÑ Aktualisieren</button>
                </div>
                <div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Datei</th>
                                    <th>Status</th>
                                    <th>Upload-Zeit</th>
                                    <th>Umsatz</th>
                                    <th>Kosten</th>
                                    <th>Gewinn</th>
                                    <th>Marge</th>
                                    <th>Aktionen</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <tr>
                                    <td colspan="8" style="text-align: center; padding: 40px; color: #666;">
                                        <div style="font-size: 48px; margin-bottom: 16px;">üìÇ</div>
                                        <h3 style="margin: 0 0 8px 0;">Noch keine BWA-Dateien hochgeladen</h3>
                                        <p style="margin: 0;">Laden Sie Ihre erste BWA-Datei hoch.</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        console.log('üöÄ BWA Upload Clean Version gestartet');
        
        // Globale Variablen
        let uploadHistory = [];
        let uploadZone, fileInput, progressContainer, progressFill, progressText, successContainer, successDetails, historyTableBody;
        let isUploading = false; // Verhindert doppelte Uploads
        let lastUploadedFile = null; // Track der zuletzt hochgeladenen Datei
        
        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéØ DOM CONTENT LOADED - SCRIPT STARTET!');
            alert('üéØ JavaScript wird ausgef√ºhrt! Schauen Sie in die Console (F12)');
            
            // DOM Elemente abrufen NACH DOMContentLoaded
            uploadZone = document.getElementById('uploadZone');
            fileInput = document.getElementById('fileInput');
            progressContainer = document.getElementById('progressContainer');
            progressFill = document.getElementById('progressFill');
            progressText = document.getElementById('progressText');
            successContainer = document.getElementById('successContainer');
            successDetails = document.getElementById('successDetails');
            historyTableBody = document.getElementById('historyTableBody');
            
            console.log('üìã DOM Elemente gefunden:', {
                uploadZone: !!uploadZone,
                fileInput: !!fileInput,
                progressContainer: !!progressContainer,
                progressFill: !!progressFill,
                progressText: !!progressText,
                successContainer: !!successContainer
            });
            
            if (!uploadZone || !fileInput || !progressContainer) {
                console.error('‚ùå KRITISCHE DOM ELEMENTE FEHLEN!');
                alert('‚ùå DOM Elemente nicht gefunden!');
                return;
            }
            
            console.log('‚úÖ Upload-System wird initialisiert...');
            
            // Upload Zone ist jetzt mit Label klickbar + Drag & Drop
            
            fileInput.addEventListener('change', function(event) {
                console.log('üéØ FILE INPUT CHANGE EVENT AUSGEL√ñST!');
                console.log('ÔøΩ Event Details:', event);
                console.log('üìÇ Files Array:', event.target.files);
                console.log('üìä Anzahl Dateien:', event.target.files.length);
                
                const file = event.target.files[0];
                if (file) {
                    console.log('‚úÖ Datei erfolgreich ausgew√§hlt!');
                    console.log('üìÑ Datei-Info:', {
                        name: file.name,
                        type: file.type,
                        size: file.size + ' bytes',
                        lastModified: new Date(file.lastModified).toISOString()
                    });
                    
                    console.log('üöÄ Rufe handleFileUpload auf...');
                    handleFileUpload(file);
                } else {
                    console.log('‚ùå Keine Datei in event.target.files[0] gefunden');
                    console.log('üîç Files Array Details:', [...event.target.files]);
                }
            });
            
            // Drag & Drop - Event Listener sowohl auf uploadZone als auch Label
            const dropZone = uploadZone;
            const labelElement = uploadZone.querySelector('label');
            
            function addDragDropListeners(element) {
                element.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    uploadZone.classList.add('dragover');
                    console.log('üìã Drag over auf', element.tagName);
                });
                
                element.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    // Nur entfernen wenn wir wirklich das Element verlassen
                    if (!uploadZone.contains(e.relatedTarget)) {
                        uploadZone.classList.remove('dragover');
                    }
                });
                
                element.addEventListener('drop', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    uploadZone.classList.remove('dragover');
                    const file = e.dataTransfer.files[0];
                    if (file) {
                        console.log('‚úÖ Datei per Drop erhalten:', file.name);
                        handleFileUpload(file);
                    }
                });
            }
            
            // Drag & Drop auf beide Elemente anwenden
            addDragDropListeners(uploadZone);
            if (labelElement) {
                addDragDropListeners(labelElement);
            }
            
            // Historie laden
            loadHistory();
        });
        
        // Hash-Funktion f√ºr konsistente Daten
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            return Math.abs(hash);
        }

        // Seeded Random f√ºr konsistente Generierung
        function seededRandom(seed) {
            const x = Math.sin(seed) * 10000;
            return x - Math.floor(x);
        }

        // BWA-Daten basierend auf Dateiname generieren
        function generateConsistentBWAData(filename) {
            const hash = simpleHash(filename);
            const seed1 = hash % 1000;
            const seed2 = (hash * 31) % 1000;
            const seed3 = (hash * 37) % 1000;
            
            const revenue = Math.round(20000 + seededRandom(seed1) * 60000);
            const costPercentage = 0.6 + seededRandom(seed2) * 0.3; // 60-90%
            const costs = Math.round(revenue * costPercentage);
            const profit = revenue - costs;
            const margin = ((profit / revenue) * 100).toFixed(1);

            return { revenue, costs, profit, margin };
        }

        // Pr√ºfung auf bereits hochgeladene Dateien
        function checkDuplicateFile(filename) {
            const existingData = JSON.parse(localStorage.getItem('bwa-clean-history') || '[]');
            console.log('üîç Pr√ºfe Duplikat f√ºr:', filename);
            console.log('üìö Vorhandene Dateien:', existingData.map(item => item.filename));
            const isDuplicate = existingData.some(item => item.filename === filename);
            console.log('üéØ Duplikat gefunden:', isDuplicate);
            return isDuplicate;
        }

        // Warndialog f√ºr doppelte Uploads
        function showDuplicateWarning(filename, callback) {
            // Pr√ºfe ob es sich um eine sofortige Wiederholung handelt
            const isImmedateRepeat = lastUploadedFile && lastUploadedFile.name === filename;
            const warningText = isImmedateRepeat 
                ? "Diese Datei wurde gerade eben hochgeladen."
                : "Eine Datei mit diesem Namen wurde bereits fr√ºher hochgeladen.";
            
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;

            const dialog = document.createElement('div');
            dialog.style.cssText = `
                background: white;
                padding: 2rem;
                border-radius: 8px;
                max-width: 450px;
                width: 90%;
                text-align: center;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                position: relative;
                margin: auto;
            `;

            dialog.innerHTML = `
                <h3 style="margin-top: 0; color: #f57c00;">‚ö†Ô∏è Datei bereits vorhanden</h3>
                <div style="background: #fff3e0; padding: 16px; border-radius: 8px; margin: 16px 0; border-left: 4px solid #f57c00;">
                    <p style="margin: 0 0 8px 0; font-weight: 600;">üìÑ ${filename}</p>
                    <p style="margin: 0; color: #ef6c00; font-size: 14px;">${warningText}</p>
                </div>
                <p>M√∂chten Sie die Datei trotzdem erneut verarbeiten?</p>
                <div style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: center;">
                    <button id="cancelBtn" style="padding: 0.5rem 1rem; background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">Abbrechen</button>
                    <button id="confirmBtn" style="padding: 0.5rem 1rem; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">Erneut hochladen</button>
                </div>
            `;

            overlay.appendChild(dialog);
            document.body.appendChild(overlay);

            document.getElementById('cancelBtn').onclick = () => {
                document.body.removeChild(overlay);
                callback(false);
            };

            document.getElementById('confirmBtn').onclick = () => {
                document.body.removeChild(overlay);
                callback(true);
            };

            // ESC-Taste zum Schlie√üen
            overlay.onclick = (e) => {
                if (e.target === overlay) {
                    document.body.removeChild(overlay);
                    callback(false);
                }
            };
            
            // ESC-Taste Support
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && overlay.parentElement) {
                    document.body.removeChild(overlay);
                    callback(false);
                }
            }, { once: true });
        }

        function handleFileUpload(file) {
            console.log('üöÄ handleFileUpload aufgerufen');
            console.log('üìÑ Datei-Details:', {
                name: file.name,
                type: file.type,
                size: file.size,
                lastModified: file.lastModified
            });
            console.log('üîÑ Upload-Status:', { isUploading, lastUploadedFile });
            
            // Verhindere doppelte Uploads
            if (isUploading) {
                console.log('‚ö†Ô∏è Upload bereits in Bearbeitung, ignoriere...');
                showNotification('‚ö†Ô∏è Upload bereits in Bearbeitung...', 'warning');
                return;
            }
            
            // Validierung
            console.log('üîç Validiere Dateityp:', file.type);
            if (file.type !== 'application/pdf') {
                console.log('‚ùå Falscher Dateityp:', file.type);
                showNotification('‚ö†Ô∏è Nur PDF-Dateien sind erlaubt!', 'error');
                return;
            }
            
            console.log('üîç Validiere Dateigr√∂√üe:', file.size, 'Bytes');
            if (file.size > 50 * 1024 * 1024) {
                console.log('‚ùå Datei zu gro√ü:', file.size);
                showNotification('‚ö†Ô∏è Datei zu gro√ü! Max 50MB.', 'error');
                return;
            }

            console.log('‚úÖ Datei-Validierung erfolgreich');

            // Umfassende Duplikats-Pr√ºfung:
            // 1. Pr√ºfung gegen zuletzt hochgeladene Datei (verhindert sofortige Wiederholung)
            if (lastUploadedFile) {
                console.log('üîç Pr√ºfe gegen zuletzt hochgeladene Datei:', lastUploadedFile.name);
                if (lastUploadedFile.name === file.name && 
                    lastUploadedFile.size === file.size && 
                    lastUploadedFile.lastModified === file.lastModified) {
                    console.log('‚ö†Ô∏è Identische Datei wurde gerade hochgeladen');
                    showDuplicateWarning(file.name, (confirmed) => {
                        if (confirmed) {
                            console.log('‚úÖ Benutzer best√§tigt sofortigen Re-Upload');
                            startUpload(file);
                        } else {
                            console.log('‚ùå Sofortiger Re-Upload abgebrochen');
                        }
                    });
                    return;
                }
            }

            // 2. Pr√ºfung gegen alle Dateien in der Historie (auch √§ltere Uploads)
            console.log('üîç Starte Duplikats-Pr√ºfung f√ºr:', file.name);
            console.log('üìã Upload-Historie:', uploadHistory.map(h => h.filename));
            
            if (checkDuplicateFile(file.name)) {
                console.log('‚ö†Ô∏è Datei mit diesem Namen bereits in Historie vorhanden');
                showDuplicateWarning(file.name, (confirmed) => {
                    if (confirmed) {
                        console.log('‚úÖ Benutzer best√§tigt erneuten Upload');
                        startUpload(file);
                    } else {
                        console.log('‚ùå Upload abgebrochen durch Benutzer');
                    }
                });
                return;
            }
            
            // Normaler Upload - keine Duplikate gefunden
            console.log('‚úÖ Keine Duplikate gefunden, starte normalen Upload');
            startUpload(file);
            // Normaler Upload - keine Duplikate gefunden
            console.log('‚úÖ Keine Duplikate gefunden, starte normalen Upload');
            startUpload(file);
        }

        // PDF-Analyse Funktionen
        async function analyzePDF(file) {
            try {
                console.log('üîç Starte PDF-Analyse f√ºr:', file.name);
                
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                
                let fullText = '';
                
                // Alle Seiten durchgehen
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + ' ';
                }
                
                console.log('üìÑ Extrahierter Text (erste 500 Zeichen):', fullText.substring(0, 500));
                
                // BWA-Daten aus Text extrahieren
                const bwaData = extractBWAData(fullText, file.name);
                return bwaData;
                
            } catch (error) {
                console.error('‚ùå PDF-Analyse Fehler:', error);
                // Fallback zu konsistenten generierten Daten
                console.log('‚ö†Ô∏è Fallback zu generierten Daten');
                return generateConsistentBWAData(file.name);
            }
        }

        // BWA-Daten aus PDF-Text extrahieren
        function extractBWAData(text, filename) {
            console.log('üîç Starte intelligente BWA-Analyse...');
            
            const cleanText = text.toLowerCase().replace(/\s+/g, ' ');
            
            // Erweiterte BWA-Begriffe f√ºr bessere Erkennung
            const bwaTerms = {
                revenue: [
                    'umsatzerl√∂se', 'umsatz', 'erl√∂se', 'ertr√§ge', 'einnahmen', 
                    'verkaufserl√∂se', 'betriebserl√∂se', 'ertrag', 'revenue',
                    'nettoumsatz', 'bruttoumsatz', 'gesamtumsatz'
                ],
                personalCosts: [
                    'personalkosten', 'personalaufwand', 'l√∂hne', 'geh√§lter',
                    'sozialabgaben', 'lohnkosten', 'lohnaufwand', 'personal'
                ],
                materialCosts: [
                    'materialkosten', 'materialaufwand', 'rohstoffe', 'wareneinsatz',
                    'bezogene leistungen', 'fremdleistungen', 'material'
                ],
                operatingCosts: [
                    'betriebskosten', 'verwaltungskosten', 'mietkosten', 'miete',
                    'raumkosten', 'energiekosten', 'strom', 'heizung'
                ],
                marketingCosts: [
                    'marketingkosten', 'werbekosten', 'werbung', 'marketing',
                    'vertriebskosten', 'verkaufskosten', 'promotion'
                ],
                otherCosts: [
                    'sonstige kosten', 'abschreibungen', 'zinsen', 'steuern',
                    'versicherungen', 'beratungskosten', 'reisekosten'
                ],
                totalCosts: [
                    'gesamtkosten', 'gesamtaufwand', 'summe kosten', 'total kosten',
                    'betriebsausgaben', 'aufwendungen gesamt'
                ],
                profit: [
                    'gewinn', 'verlust', 'ergebnis', 'betriebsergebnis',
                    'jahres√ºberschuss', 'periodengewinn', 'profit'
                ]
            };
            
            // BWA-Validierung
            const allTerms = Object.values(bwaTerms).flat();
            const foundTerms = allTerms.filter(term => cleanText.includes(term));
            
            if (foundTerms.length < 3) {
                throw new Error(`Dies scheint keine BWA-Datei zu sein. Nur ${foundTerms.length} BWA-relevante Begriffe gefunden.`);
            }
            
            console.log('‚úÖ BWA-Datei validiert. Gefundene Begriffe:', foundTerms.slice(0, 10));
            
            // Intelligente Zahlenextraktion
            function extractNumbers(text, terms) {
                const results = [];
                
                // Verschiedene Zahlenmuster: 1.234,56 oder 1,234.56 oder 1234.56
                const numberPatterns = [
                    /(\d{1,3}(?:[.,]\d{3})*[.,]\d{2})/g,  // 1.234,56 oder 1,234.56
                    /(\d{1,3}(?:[.,]\d{3})+)/g,           // 1.234 oder 1,234
                    /(\d+[.,]\d{2})/g,                    // 123,45 oder 123.45
                    /(\d+)/g                              // 123
                ];
                
                for (const term of terms) {
                    // Suche Kontext um den Begriff (50 Zeichen vor und nach)
                    const termIndex = text.indexOf(term);
                    if (termIndex !== -1) {
                        const contextStart = Math.max(0, termIndex - 50);
                        const contextEnd = Math.min(text.length, termIndex + term.length + 100);
                        const context = text.substring(contextStart, contextEnd);
                        
                        // Suche nach Zahlen im Kontext
                        for (const pattern of numberPatterns) {
                            const matches = [...context.matchAll(pattern)];
                            for (const match of matches) {
                                let value = match[1];
                                
                                // Normalisiere Zahl (deutsche/amerikanische Notation)
                                if (value.includes(',') && value.includes('.')) {
                                    // Pr√ºfe welches Format: 1.234,56 (deutsch) oder 1,234.56 (amerikanisch)
                                    const lastComma = value.lastIndexOf(',');
                                    const lastDot = value.lastIndexOf('.');
                                    if (lastComma > lastDot) {
                                        // Deutsches Format: 1.234,56
                                        value = value.replace(/\./g, '').replace(',', '.');
                                    } else {
                                        // Amerikanisches Format: 1,234.56
                                        value = value.replace(/,/g, '');
                                    }
                                } else if (value.includes(',')) {
                                    // Nur Komma: kann Dezimaltrennzeichen oder Tausendertrennzeichen sein
                                    const parts = value.split(',');
                                    if (parts[parts.length - 1].length === 2) {
                                        // Letzter Teil hat 2 Stellen -> Dezimaltrennzeichen
                                        value = value.replace(/,(?=\d{2}$)/, '.').replace(/,/g, '');
                                    } else {
                                        // Tausendertrennzeichen
                                        value = value.replace(/,/g, '');
                                    }
                                }
                                
                                const numValue = parseFloat(value);
                                if (!isNaN(numValue) && numValue > 0) {
                                    results.push({
                                        term: term,
                                        value: numValue,
                                        context: context.trim(),
                                        confidence: calculateConfidence(term, context, numValue)
                                    });
                                }
                            }
                        }
                    }
                }
                
                return results.sort((a, b) => b.confidence - a.confidence);
            }
            
            function calculateConfidence(term, context, value) {
                let confidence = 50; // Basis-Confidence
                
                // H√∂here Confidence f√ºr spezifische Begriffe
                if (['umsatzerl√∂se', 'gesamtumsatz', 'nettoumsatz'].includes(term)) confidence += 30;
                if (['gesamtkosten', 'gesamtaufwand'].includes(term)) confidence += 30;
                if (['personalkosten', 'materialkosten'].includes(term)) confidence += 20;
                
                // Confidence basierend auf Kontext
                if (context.includes('euro') || context.includes('eur') || context.includes('‚Ç¨')) confidence += 15;
                if (context.includes('tsd') || context.includes('tausend')) confidence += 10;
                if (context.includes('mio') || context.includes('million')) confidence += 5;
                
                // Plausible Werte (typische BWA-Gr√∂√üenordnungen)
                if (value >= 1000 && value <= 10000000) confidence += 10;
                if (value >= 10000 && value <= 1000000) confidence += 20;
                
                return confidence;
            }
            
            // Extrahiere Werte f√ºr jede Kategorie
            const extractedData = {};
            
            for (const [category, terms] of Object.entries(bwaTerms)) {
                const numbers = extractNumbers(cleanText, terms);
                if (numbers.length > 0) {
                    extractedData[category] = numbers[0]; // Beste √úbereinstimmung
                    console.log(`üìä ${category}: ${numbers[0].value} (${numbers[0].term}, Confidence: ${numbers[0].confidence})`);
                }
            }
            
            // Berechne oder verwende extrahierte Werte
            let revenue = extractedData.revenue?.value || 0;
            let totalCosts = extractedData.totalCosts?.value || 0;
            
            // Falls keine Gesamtkosten gefunden, addiere Einzelkosten
            if (!totalCosts && Object.keys(extractedData).some(key => key.includes('Costs'))) {
                totalCosts = (extractedData.personalCosts?.value || 0) +
                           (extractedData.materialCosts?.value || 0) +
                           (extractedData.operatingCosts?.value || 0) +
                           (extractedData.marketingCosts?.value || 0) +
                           (extractedData.otherCosts?.value || 0);
                console.log(`üßÆ Gesamtkosten berechnet aus Einzelkosten: ${totalCosts}`);
            }
            
            let profit = extractedData.profit?.value || (revenue - totalCosts);
            
            // Validierung der mathematischen Logik: Umsatz - Kosten = Gewinn
            if (revenue && totalCosts && Math.abs((revenue - totalCosts) - profit) > revenue * 0.1) {
                console.warn('‚ö†Ô∏è Mathematische Inkonsistenz erkannt. Korrigiere Gewinn-Berechnung.');
                profit = revenue - totalCosts;
            }
            
            // Falls keine plausiblen Werte extrahiert wurden
            if (!revenue || revenue < 1000 || (!totalCosts && !profit)) {
                console.log('‚ö†Ô∏è BWA-Datei erkannt, aber keine plausiblen Zahlen extrahiert. Verwende generierte Daten.');
                const generated = generateConsistentBWAData(filename);
                return {
                    ...generated,
                    source: 'bwa-validated',
                    extractedTerms: foundTerms.slice(0, 5),
                    extractionNote: 'BWA validiert, Zahlen generiert'
                };
            }
            
            const margin = revenue > 0 ? ((profit / revenue) * 100).toFixed(1) : 0;
            
            console.log('‚úÖ BWA-Daten erfolgreich extrahiert:', { revenue, costs: totalCosts, profit, margin });
            
            return {
                revenue: Math.round(revenue),
                costs: Math.round(totalCosts),
                profit: Math.round(profit),
                margin: parseFloat(margin),
                source: 'extracted',
                extractedTerms: foundTerms.slice(0, 5),
                categoryBreakdown: {
                    personal: Math.round(extractedData.personalCosts?.value || 0),
                    material: Math.round(extractedData.materialCosts?.value || 0),
                    operating: Math.round(extractedData.operatingCosts?.value || 0),
                    marketing: Math.round(extractedData.marketingCosts?.value || 0),
                    other: Math.round(extractedData.otherCosts?.value || 0)
                }
            };
        }
            
            console.log('‚úÖ BWA-Daten erfolgreich extrahiert:', { revenue, costs: totalCosts, profit, margin });
            
            return {
                revenue: Math.round(revenue),
                costs: Math.round(totalCosts),
                profit: Math.round(profit),
                margin: parseFloat(margin),
                source: 'extracted',
                extractedTerms: foundTerms.slice(0, 5),
                categoryBreakdown: {
                    personal: Math.round(extractedData.personalCosts?.value || 0),
                    material: Math.round(extractedData.materialCosts?.value || 0),
                    operating: Math.round(extractedData.operatingCosts?.value || 0),
                    marketing: Math.round(extractedData.marketingCosts?.value || 0),
                    other: Math.round(extractedData.otherCosts?.value || 0)
                }
            };
        }

        function startUpload(file) {
            console.log('üöÄ startUpload aufgerufen f√ºr:', file.name);
            console.log('üìä Upload-Status vor Start:', { isUploading, lastUploadedFile });
            
            // Upload starten
            isUploading = true;
            lastUploadedFile = file;
            
            console.log('‚úÖ Upload-Flags gesetzt. Starte Simulation...');
            
            // Upload simulieren
            simulateUpload(file);
        }
        
        // Nicht-blockierende Benachrichtigung
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'error' ? '#fee2e2' : type === 'success' ? '#d1fae5' : '#e0f2fe'};
                color: ${type === 'error' ? '#991b1b' : type === 'success' ? '#065f46' : '#0c4a6e'};
                padding: 16px 20px;
                border-radius: 8px;
                border-left: 4px solid ${type === 'error' ? '#ef4444' : type === 'success' ? '#22c55e' : '#0284c7'};
                box-shadow: 0 4px 20px rgba(0,0,0,0.1);
                z-index: 10001;
                max-width: 400px;
                font-weight: 600;
            `;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 18px; cursor: pointer; margin-left: auto;">√ó</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }
        
        function simulateUpload(file) {
            console.log('üé¨ simulateUpload gestartet f√ºr:', file.name);
            console.log('üéØ Umschalte UI...');
            
            // UI umschalten
            uploadZone.style.display = 'none';
            progressContainer.style.display = 'block';
            successContainer.style.display = 'none';
            
            console.log('üìà Starte Progress-Animation...');
            
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 10 + 5;
                
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                    console.log('‚úÖ Progress-Animation abgeschlossen, starte Analyse...');
                    // PDF-Analyse vor completeUpload
                    setTimeout(() => completeUploadWithAnalysis(file), 1000);
                }
                
                progressFill.style.width = progress + '%';
                progressText.textContent = Math.round(progress) + '% - Verarbeitung l√§uft...';
            }, 200);
        }
        
        async function completeUploadWithAnalysis(file) {
            console.log('Upload abgeschlossen, starte Analyse...');
            
            try {
                // Fortschritt auf Analyse umstellen
                progressText.textContent = '100% - Analysiere PDF...';
                
                // PDF analysieren
                const bwaData = await analyzePDF(file);
                const { revenue, costs, profit, margin } = bwaData;
                
                // Normale Complete-Upload Logik mit analysierten Daten
                completeUpload(file, { revenue, costs, profit, margin });
                
            } catch (error) {
                console.error('‚ùå Analyse-Fehler:', error);
                
                // Reset upload state
                isUploading = false;
                lastUploadedFile = null;
                
                // BWA-Validierungsfehler vs. andere Fehler unterscheiden
                if (error.message.includes('BWA-Datei')) {
                    showBWAValidationError(error.message, file.name);
                } else {
                    console.log('‚ö†Ô∏è Technischer Fehler, verwende Fallback zu generierten Daten');
                    const bwaData = generateConsistentBWAData(file.name);
                    completeUpload(file, bwaData);
                }
            }
        }

        // Spezielle Fehlermeldung f√ºr BWA-Validierung
        function showBWAValidationError(message, filename) {
            // Zur√ºck zur Upload-Zone
            resetToUploadZone();
            
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;

            const dialog = document.createElement('div');
            dialog.style.cssText = `
                background: white;
                padding: 2.5rem;
                border-radius: 12px;
                max-width: 500px;
                width: 90%;
                text-align: center;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
                position: relative;
                margin: auto;
            `;

            dialog.innerHTML = `
                <div style="width: 80px; height: 80px; background: #fef2f2; border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 40px; margin: 0 auto 24px auto;">‚ùå</div>
                <h3 style="margin: 0 0 16px 0; color: #dc2626; font-size: 24px; font-weight: 600;">Keine BWA-Datei erkannt</h3>
                <div style="background: #fef2f2; padding: 16px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #dc2626;">
                    <p style="margin: 0; color: #dc2626; font-weight: 500; text-align: left;">
                        üìÑ <strong>${filename}</strong>
                    </p>
                    <p style="margin: 8px 0 0 0; color: #7f1d1d; text-align: left; font-size: 14px;">
                        ${message}
                    </p>
                </div>
                <div style="background: #f0f9ff; padding: 16px; border-radius: 8px; margin-bottom: 24px; border-left: 4px solid #0ea5e9;">
                    <p style="margin: 0; color: #0c4a6e; text-align: left; font-size: 14px; line-height: 1.5;">
                        <strong>üí° Bitte laden Sie eine echte BWA-Datei hoch, die folgende Begriffe enth√§lt:</strong><br>
                        ‚Ä¢ Betriebswirtschaftliche Auswertung / BWA<br>
                        ‚Ä¢ Umsatz, Erl√∂se oder Ertr√§ge<br>
                        ‚Ä¢ Kosten, Aufwand oder Aufwendungen<br>
                        ‚Ä¢ Vom Steuerberater oder Buchhaltung
                    </p>
                </div>
                <button id="okBtn" style="background: #dc2626; color: white; border: none; padding: 14px 28px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px; transition: all 0.2s ease;" onmouseover="this.style.background='#b91c1c'" onmouseout="this.style.background='#dc2626'">
                    Verstanden
                </button>
            `;

            overlay.appendChild(dialog);
            document.body.appendChild(overlay);

            document.getElementById('okBtn').onclick = () => {
                document.body.removeChild(overlay);
            };

            // ESC-Taste und Au√üenklick zum Schlie√üen
            overlay.onclick = (e) => {
                if (e.target === overlay) {
                    document.body.removeChild(overlay);
                }
            };

            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && overlay.parentElement) {
                    document.body.removeChild(overlay);
                }
            }, { once: true });
        }
        
        function completeUpload(file, bwaData = null) {
            console.log('Upload abgeschlossen');
            
            // BWA-Daten verwenden (analysiert oder generiert)
            const { revenue, costs, profit, margin } = bwaData || generateConsistentBWAData(file.name);
            
            // UI umschalten
            if (progressContainer) progressContainer.style.display = 'none';
            if (uploadZone) uploadZone.style.display = 'block';
            if (successContainer) successContainer.style.display = 'block';
            
            // Erfolgsdetails
            if (successDetails) {
                successDetails.innerHTML = `
                    <h3>‚úÖ ${file.name}</h3>
                    <div class="success-stats">
                        <div><span>üí∞ Umsatz:</span> ${revenue.toLocaleString()}‚Ç¨</div>
                        <div><span>üìä Kosten:</span> ${costs.toLocaleString()}‚Ç¨</div>
                        <div><span>üéØ Gewinn:</span> ${profit.toLocaleString()}‚Ç¨</div>
                        <div><span>üìà Marge:</span> ${margin}%</div>
                    </div>
                    <button onclick="resetUpload()" style="background: #1976d2; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin-top: 16px;">üì§ Weitere BWA hochladen</button>
                `;
            }
            
            // Zur Historie hinzuf√ºgen (mit aktueller Zeit f√ºr UI-Status)
            addToHistory(file, { revenue, costs, profit, margin });
            
            // Dashboard aktualisieren
            updateDashboard({ revenue, costs, profit, margin, filename: file.name });
            
            // Reset Input
            if (fileInput) fileInput.value = '';
            
            // Upload-Sperre aufheben
            isUploading = false;
            
            console.log('Upload komplett abgeschlossen');
        }
        
        function resetUpload() {
            if (successContainer) successContainer.style.display = 'none';
            if (uploadZone) uploadZone.style.display = 'block';
            progressContainer.style.display = 'none';
            
            // Upload-Sperre aufheben falls sie noch aktiv ist
            isUploading = false;
            lastUploadedFile = null;
        }
        
        function addToHistory(file, data) {
            const entry = {
                filename: file.name,
                size: (file.size / (1024 * 1024)).toFixed(1),
                date: new Date().toLocaleDateString('de-DE'),
                time: new Date().toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'}),
                revenue: data.revenue,
                costs: data.costs,
                profit: data.profit,
                margin: data.margin,
                dataSource: data.source || 'generated', // PDF-Analyse oder generiert
                timestamp: Date.now()
            };
            
            uploadHistory.unshift(entry);
            
            // LocalStorage speichern
            try {
                localStorage.setItem('bwa-clean-history', JSON.stringify(uploadHistory));
            } catch (e) {
                console.error('LocalStorage Fehler:', e);
            }
            
            displayHistory();
        }

        // Datenquelle-Label generieren
        function getDataSourceLabel(dataSource) {
            switch(dataSource) {
                case 'pdf-analysis':
                    return 'üîç PDF-Analyse';
                case 'bwa-validated':
                    return '‚úÖ BWA-validiert';
                case 'generated':
                default:
                    return 'üé≤ Generiert';
            }
        }

        function displayHistory() {
            if (uploadHistory.length === 0) {
                historyTableBody.innerHTML = 
                    '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #666;">' +
                    '<div style="font-size: 48px; margin-bottom: 16px;">üìÇ</div>' +
                    '<h3 style="margin: 0 0 8px 0;">Noch keine BWA-Dateien hochgeladen</h3>' +
                    '<p style="margin: 0;">Laden Sie Ihre erste BWA-Datei hoch.</p>' +
                    '</td></tr>';
                return;
            }
            
            let html = '';
            uploadHistory.forEach(entry => {
                html += 
                    '<tr>' +
                    '<td><strong>' + entry.filename + '</strong><br><small style="color: #666;">' + entry.size + ' MB</small>' +
                    '<br><small style="color: #8b5cf6; font-size: 10px;">' + getDataSourceLabel(entry.dataSource) + '</small></td>' +
                    '<td><span class="status-badge">‚úÖ Verarbeitet</span></td>' +
                    '<td>' + entry.date + '<br><small style="color: #666;">' + entry.time + '</small></td>' +
                    '<td><strong>' + entry.revenue.toLocaleString() + ' ‚Ç¨</strong></td>' +
                    '<td>' + entry.costs.toLocaleString() + ' ‚Ç¨</td>' +
                    '<td style="color: ' + (entry.profit > 0 ? '#22c55e' : '#dc2626') + ';"><strong>' + entry.profit.toLocaleString() + ' ‚Ç¨</strong></td>' +
                    '<td><span class="status-badge">' + entry.margin + '%</span></td>' +
                    '<td><div style="display: flex; gap: 6px; justify-content: flex-start;">' +
                    '<button onclick="showDetails(' + entry.timestamp + ')" style="padding: 6px 8px; border-radius: 6px; border: 1px solid #e3f2fd; background: #f0f4ff; color: #1976d2; font-weight: 500; cursor: pointer; font-size: 11px; white-space: nowrap;" onmouseover="this.style.background=\'#e3f2fd\'" onmouseout="this.style.background=\'#f0f4ff\'">üëÅÔ∏è Details</button>' +
                    '<button onclick="deleteEntry(' + entry.timestamp + ')" style="padding: 6px 8px; border-radius: 6px; border: 1px solid #fecaca; background: #fef2f2; color: #dc2626; font-weight: 500; cursor: pointer; font-size: 11px; white-space: nowrap;" onmouseover="this.style.background=\'#fecaca\'" onmouseout="this.style.background=\'#fef2f2\'">üóëÔ∏è L√∂schen</button>' +
                    '</div></td>' +
                    '</tr>';
            });
            
            historyTableBody.innerHTML = html;
        }
        
        function showDetails(timestamp) {
            const entry = uploadHistory.find(e => e.timestamp === timestamp);
            if (entry) {
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100vw;
                    height: 100vh;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                `;

                const dialog = document.createElement('div');
                dialog.style.cssText = `
                    background: white;
                    border-radius: 16px;
                    padding: 32px;
                    max-width: 500px;
                    width: 90%;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.2);
                    position: relative;
                    margin: auto;
                `;

                dialog.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 24px;">
                        <div style="width: 48px; height: 48px; background: #f0f4ff; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">üìä</div>
                        <h2 style="margin: 0; color: #1a1a2e; font-size: 24px; font-weight: 600;">BWA-Details</h2>
                    </div>
                    <div style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                        <div style="margin-bottom: 12px; display: flex; justify-content: space-between;"><span style="color: #666;">Datei:</span> <strong>${entry.filename}</strong></div>
                        <div style="margin-bottom: 12px; display: flex; justify-content: space-between;"><span style="color: #666;">Umsatz:</span> <strong style="color: #1976d2;">${entry.revenue.toLocaleString()}‚Ç¨</strong></div>
                        <div style="margin-bottom: 12px; display: flex; justify-content: space-between;"><span style="color: #666;">Kosten:</span> <strong>${entry.costs.toLocaleString()}‚Ç¨</strong></div>
                        <div style="margin-bottom: 12px; display: flex; justify-content: space-between;"><span style="color: #666;">Gewinn:</span> <strong style="color: ${entry.profit > 0 ? '#22c55e' : '#dc2626'};">${entry.profit.toLocaleString()}‚Ç¨</strong></div>
                        <div style="display: flex; justify-content: space-between;"><span style="color: #666;">Marge:</span> <strong style="color: ${entry.margin > 0 ? '#22c55e' : '#dc2626'};">${entry.margin}%</strong></div>
                    </div>
                    <button id="closeDetailsBtn" style="background: #1976d2; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; width: 100%; transition: all 0.2s ease;" onmouseover="this.style.background='#1565c0'" onmouseout="this.style.background='#1976d2'">Schlie√üen</button>
                `;

                overlay.appendChild(dialog);
                document.body.appendChild(overlay);

                // Event Handlers
                document.getElementById('closeDetailsBtn').onclick = () => {
                    document.body.removeChild(overlay);
                };

                // Klick au√üerhalb schlie√üt Modal
                overlay.onclick = (e) => {
                    if (e.target === overlay) {
                        document.body.removeChild(overlay);
                    }
                };

                // ESC-Taste
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && overlay.parentElement) {
                        document.body.removeChild(overlay);
                    }
                }, { once: true });
            }
        }
        
        function deleteEntry(timestamp) {
            // Alle bestehenden Modals entfernen
            const existingModals = document.querySelectorAll('.delete-modal-overlay');
            existingModals.forEach(modal => modal.remove());

            const overlay = document.createElement('div');
            overlay.className = 'delete-modal-overlay';
            overlay.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                background: rgba(0, 0, 0, 0.5) !important;
                display: table !important;
                z-index: 999999 !important;
                pointer-events: all !important;
            `;

            const tableCell = document.createElement('div');
            tableCell.style.cssText = `
                display: table-cell !important;
                vertical-align: middle !important;
                text-align: center !important;
                padding: 20px !important;
            `;

            const dialog = document.createElement('div');
            dialog.style.cssText = `
                display: inline-block !important;
                background: white !important;
                border-radius: 16px !important;
                padding: 32px !important;
                max-width: 400px !important;
                width: 90% !important;
                text-align: center !important;
                box-shadow: 0 20px 60px rgba(0,0,0,0.2) !important;
                vertical-align: middle !important;
            `;

            dialog.innerHTML = `
                <div style="width: 64px; height: 64px; background: #fef2f2; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 32px; margin: 0 auto 20px auto;">üóëÔ∏è</div>
                <h3 style="margin: 0 0 12px 0; color: #1a1a2e; font-size: 20px; font-weight: 600;">L√∂schen best√§tigen</h3>
                <p style="margin: 0 0 24px 0; color: #666; line-height: 1.5;">BWA-Upload wirklich permanent l√∂schen? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.</p>
                <div style="display: flex; gap: 12px; justify-content: center;">
                    <button id="cancelDeleteBtn" style="background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.2s ease;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">Abbrechen</button>
                    <button id="confirmDeleteBtn" style="background: #dc2626; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.2s ease;" onmouseover="this.style.background='#b91c1c'" onmouseout="this.style.background='#dc2626'">L√∂schen</button>
                </div>
            `;

            tableCell.appendChild(dialog);
            overlay.appendChild(tableCell);
            document.body.appendChild(overlay);

            // Event Handlers
            document.getElementById('cancelDeleteBtn').onclick = () => {
                document.body.removeChild(overlay);
            };

            document.getElementById('confirmDeleteBtn').onclick = () => {
                confirmDelete(timestamp);
                document.body.removeChild(overlay);
            };

            // Klick au√üerhalb schlie√üt Modal
            overlay.onclick = (e) => {
                if (e.target === overlay || e.target === tableCell) {
                    document.body.removeChild(overlay);
                }
            };

            // ESC-Taste
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && overlay.parentElement) {
                    document.body.removeChild(overlay);
                }
            }, { once: true });
        }
        
        function confirmDelete(timestamp) {
            uploadHistory = uploadHistory.filter(e => e.timestamp !== timestamp);
            localStorage.setItem('bwa-clean-history', JSON.stringify(uploadHistory));
            displayHistory();
            showNotification('üóëÔ∏è Upload gel√∂scht', 'success');
        }
        
        function refreshHistory() {
            displayHistory();
            console.log('Historie aktualisiert');
        }
        
        // Manuell alle Test-Daten l√∂schen
        function clearTestData() {
            const originalLength = uploadHistory.length;
            uploadHistory = uploadHistory.filter(entry => 
                !entry.filename.toLowerCase().includes('test') &&
                !entry.filename.toLowerCase().includes('debug') &&
                !entry.filename.toLowerCase().includes('fake')
            );
            
            localStorage.setItem('bwa-clean-history', JSON.stringify(uploadHistory));
            displayHistory();
            
            const removedCount = originalLength - uploadHistory.length;
            console.log(`üßπ ${removedCount} Test-Dateien entfernt`);
            showNotification(`üßπ ${removedCount} Test-Dateien entfernt`, 'success');
        }
        
        // Alle Daten l√∂schen (Reset)
        function clearAllData() {
            if (confirm('Wirklich alle Upload-Daten l√∂schen?')) {
                uploadHistory = [];
                localStorage.removeItem('bwa-clean-history');
                displayHistory();
                resetDashboardToZero();
                showNotification('üóëÔ∏è Alle Daten gel√∂scht', 'success');
                console.log('üóëÔ∏è Alle Upload-Daten gel√∂scht');
            }
        }
        
        function updateDashboard(data) {
            try {
                // Dashboard-Daten speichern
                const dashboardData = {
                    revenue: data.revenue,
                    costs: data.costs,
                    profit: data.profit,
                    margin: parseFloat(data.margin),
                    filename: data.filename,
                    lastUpdate: new Date().toISOString()
                };
                
                localStorage.setItem('bwa-dashboard-current', JSON.stringify(dashboardData));
                localStorage.setItem('bwa-dashboard-kpis', JSON.stringify(dashboardData));
                
                console.log('Dashboard aktualisiert mit echten BWA-Daten');
            } catch (e) {
                console.error('Dashboard Update Fehler:', e);
            }
        }
        
        // Historie beim Laden wiederherstellen
        function loadHistory() {
            try {
                const saved = localStorage.getItem('bwa-clean-history');
                if (saved) {
                    uploadHistory = JSON.parse(saved);
                    
                    // Test-Dateien automatisch entfernen
                    const originalLength = uploadHistory.length;
                    uploadHistory = uploadHistory.filter(entry => 
                        !entry.filename.toLowerCase().includes('test') &&
                        !entry.filename.toLowerCase().includes('debug') &&
                        !entry.filename.toLowerCase().includes('fake')
                    );
                    
                    if (originalLength !== uploadHistory.length) {
                        console.log(`üßπ ${originalLength - uploadHistory.length} Test-Dateien automatisch entfernt`);
                        localStorage.setItem('bwa-clean-history', JSON.stringify(uploadHistory));
                    }
                    
                    console.log('Historie geladen:', uploadHistory.length, 'echte Eintr√§ge');
                    displayHistory();
                    
                    // UI-Status wiederherstellen basierend auf letztem Upload
                    restoreUIState();
                } else {
                    // Wenn keine Historie vorhanden, Dashboard auf Null setzen
                    resetDashboardToZero();
                }
            } catch (e) {
                console.error('Fehler beim Laden der Historie:', e);
                uploadHistory = [];
                resetDashboardToZero();
            }
        }
        
        // UI-Status basierend auf letztem Upload wiederherstellen
        function restoreUIState() {
            if (uploadHistory.length > 0) {
                const lastUpload = uploadHistory[0]; // Neuester Upload
                
                // Pr√ºfen ob ein Upload in den letzten 10 Sekunden war (f√ºr Success-Anzeige)
                const timeSinceUpload = Date.now() - lastUpload.timestamp;
                
                if (timeSinceUpload < 10000) { // 10 Sekunden
                    // Success-Container anzeigen
                    if (uploadZone) uploadZone.style.display = 'block';
                    if (progressContainer) progressContainer.style.display = 'none';
                    if (successContainer) {
                        successContainer.style.display = 'block';
                        
                        // Success-Details aktualisieren
                        if (successDetails) {
                            successDetails.innerHTML = `
                                <h3>‚úÖ ${lastUpload.filename}</h3>
                                <div class="success-stats">
                                    <div><span>üí∞ Umsatz:</span> ${lastUpload.revenue.toLocaleString()}‚Ç¨</div>
                                    <div><span>üìä Kosten:</span> ${lastUpload.costs.toLocaleString()}‚Ç¨</div>
                                    <div><span>üéØ Gewinn:</span> ${lastUpload.profit.toLocaleString()}‚Ç¨</div>
                                    <div><span>üìà Marge:</span> ${lastUpload.margin}%</div>
                                </div>
                            `;
                        }
                    }
                } else {
                    // Normal Upload-Zone anzeigen
                    resetToUploadZone();
                }
            } else {
                resetToUploadZone();
            }
        }
        
        // Zur√ºck zur normalen Upload-Zone
        function resetToUploadZone() {
            if (uploadZone) uploadZone.style.display = 'block';
            if (progressContainer) progressContainer.style.display = 'none';
            if (successContainer) successContainer.style.display = 'none';
        }
        
        function resetDashboardToZero() {
            console.log('üîÑ Dashboard auf Null-Werte zur√ºcksetzen');
            
            const emptyDashboard = {
                revenue: 0,
                costs: 0,
                profit: 0,
                margin: 0,
                filename: null,
                lastUpdate: null
            };
            
            // Alle Dashboard-Daten l√∂schen
            localStorage.removeItem('bwa-dashboard-current');
            localStorage.removeItem('bwa-dashboard-kpis');
            localStorage.removeItem('bwa-dashboard-charts');
            localStorage.removeItem('bwa-scoring-current');
            localStorage.removeItem('bwa-recommendations-current');
            
            // Null-Werte setzen
            localStorage.setItem('bwa-dashboard-current', JSON.stringify(emptyDashboard));
            localStorage.setItem('bwa-dashboard-kpis', JSON.stringify(emptyDashboard));
            
            console.log('‚úÖ Dashboard auf Null-Zustand gesetzt');
        }
        
        // Debug-Funktion f√ºr Test-Upload (nur f√ºr Entwicklung)
        function testUpload() {
            console.log('üß™ Test-Upload deaktiviert f√ºr Produktionsversion');
            showNotification('‚ÑπÔ∏è Test-Upload ist in der Produktionsversion deaktiviert', 'info');
            return;
            
            // Auskommentiert f√ºr Produktionsversion
            /*
            console.log('üß™ Test-Upload gestartet');
            
            try {
                // Fake-Datei erstellen
                const fakeFile = {
                    name: 'Test_BWA_Oktober_2024.pdf',
                    type: 'application/pdf',
                    size: 2048000 // 2MB
                };
                
                console.log('Fake file created:', fakeFile);
                
                // Sofort starten ohne blockierendes Alert
                showNotification('üß™ Test-Upload wird simuliert...', 'info');
                setTimeout(() => {
                    console.log('Calling handleFileUpload...');
                    handleFileUpload(fakeFile);
                }, 100);
                
            } catch (error) {
                console.error('Fehler in testUpload:', error);
                showNotification('‚ùå Fehler beim Test-Upload: ' + error.message, 'error');
            }
            */
        }
        
        // Test-Funktion f√ºr File Input Dialog
        function testFileInput() {
            console.log('üìÅ Test File Input Dialog');
            
            if (!fileInput) {
                console.error('‚ùå FileInput nicht gefunden!');
                showNotification('‚ùå FileInput nicht verf√ºgbar', 'error');
                return;
            }
            
            console.log('FileInput Element:', fileInput);
            console.log('FileInput style.display:', fileInput.style.display);
            console.log('FileInput disabled:', fileInput.disabled);
            
            try {
                console.log('üîÑ √ñffne File Dialog direkt...');
                
                // FileInput kurz sichtbar machen f√ºr Click
                fileInput.style.display = 'block';
                fileInput.style.position = 'absolute';
                fileInput.style.left = '-9999px';
                
                // Click ausf√ºhren
                fileInput.click();
                
                // Wieder verstecken
                setTimeout(() => {
                    fileInput.style.display = 'none';
                }, 100);
                
                showNotification('üìÅ File Dialog sollte sich √∂ffnen...', 'info');
            } catch (error) {
                console.error('‚ùå Fehler beim √ñffnen File Dialog:', error);
                showNotification('‚ùå File Dialog Fehler: ' + error.message, 'error');
            }
        }
        
        // EMERGENCY DEBUG FUNCTIONS
        function testConsole() {
            console.log('üî• TEST CONSOLE FUNKTIONIERT!');
            alert('Console-Test erfolgreich! Schauen Sie in die Console (F12 ‚Üí Console)');
        }
        
        function testFileInput() {
            console.log('üî• TEST FILE INPUT');
            const input = document.getElementById('fileInput');
            console.log('File Input Element:', input);
            if (input) {
                console.log('‚úÖ File Input gefunden, trigger click...');
                input.click();
            } else {
                console.log('‚ùå File Input NICHT gefunden!');
                alert('‚ùå File Input Element fehlt!');
            }
        }
        
        function testUpload() {
            console.log('üî• TEST UPLOAD SIMULATION');
            // Erstelle eine Fake-Datei f√ºr Test
            const fakeFile = new File(['BWA Test Content'], 'test-bwa.pdf', { type: 'application/pdf' });
            console.log('Fake File erstellt:', fakeFile);
            
            if (typeof handleFileUpload === 'function') {
                console.log('‚úÖ handleFileUpload Funktion gefunden, starte Test...');
                handleFileUpload(fakeFile);
            } else {
                console.log('‚ùå handleFileUpload Funktion NICHT gefunden!');
                alert('‚ùå handleFileUpload Funktion fehlt!');
            }
        }
        
        // Debug-Funktion f√ºr File Input Troubleshooting
        function debugFileInput() {
            console.log('üêõ DEBUG FILE INPUT');
            console.log('üìã File Input Element:', fileInput);
            console.log('üéØ File Input Properties:', {
                id: fileInput.id,
                type: fileInput.type,
                accept: fileInput.accept,
                multiple: fileInput.multiple,
                disabled: fileInput.disabled,
                style: fileInput.style.cssText
            });
            console.log('üìÇ Current Files:', fileInput.files);
            console.log('üîó Event Listeners:', getEventListeners ? getEventListeners(fileInput) : 'getEventListeners not available');
            
            // Test-Upload simulieren
            try {
                console.log('üé¨ Trigger File Input Click...');
                fileInput.click();
            } catch (error) {
                console.error('‚ùå Click Error:', error);
            }
        }
        
        console.log('‚úÖ BWA Upload Clean Script geladen');
        
        // SOFORTIGER FUNKTIONSTEST BEIM LADEN
        setTimeout(() => {
            console.log('üéØ STARTUP TEST - Pr√ºfe Funktionen...');
            console.log('handleFileUpload verf√ºgbar:', typeof handleFileUpload);
            console.log('simulateUpload verf√ºgbar:', typeof simulateUpload);
            console.log('File Input Element:', document.getElementById('fileInput'));
            console.log('Upload Zone Element:', document.getElementById('uploadZone'));
        }, 1000);
    </script>
</body>
</html>