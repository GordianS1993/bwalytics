<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BWA Upload | BWA-Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar - Same as other pages */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
        }
        
        .sidebar-header {
            padding: 24px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.12);
        }
        
        .sidebar-header .icon {
            font-size: 48px;
            color: #4fc3f7;
            margin-bottom: 8px;
        }
        
        .sidebar-header h1 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .sidebar-header .subtitle {
            font-size: 14px;
            color: rgba(255,255,255,0.7);
        }
        
        .user-profile {
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.12);
        }
        
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #4fc3f7;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        
        .user-info h3 {
            font-size: 14px;
            font-weight: 600;
        }
        
        .user-info p {
            font-size: 12px;
            color: rgba(255,255,255,0.7);
        }
        
        .nav-menu {
            padding: 16px;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: white;
        }
        
        .nav-item:hover {
            background: rgba(79, 195, 247, 0.1);
        }
        
        .nav-item.active {
            background: #4fc3f7;
            color: #1a1a2e;
        }
        
        .nav-item .icon {
            margin-right: 12px;
            font-size: 20px;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 24px;
        }
        
        .page-header {
            margin-bottom: 32px;
        }
        
        .page-header h1 {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .page-header p {
            color: #666;
            font-size: 16px;
        }
        
        /* Upload Zone */
        .upload-section {
            background: white;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 32px;
        }
        
        .upload-zone {
            border: 3px dashed #1976d2;
            border-radius: 12px;
            padding: 80px 40px;
            text-align: center;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 24px;
        }
        
        .upload-zone:hover {
            border-color: #1565c0;
            background: #f0f4ff;
        }
        
        .upload-zone.dragover {
            border-color: #22c55e;
            background: #f0fdf4;
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 64px;
            color: #1976d2;
            margin-bottom: 24px;
        }
        
        .upload-zone h3 {
            font-size: 24px;
            color: #1976d2;
            margin-bottom: 12px;
        }
        
        .upload-zone p {
            color: #666;
            font-size: 16px;
            margin-bottom: 24px;
        }
        
        .upload-info {
            display: flex;
            justify-content: center;
            gap: 32px;
            font-size: 14px;
            color: #666;
        }
        
        .upload-info div {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Progress */
        .progress-container {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 32px;
        }
        
        .progress-header {
            text-align: center;
            margin-bottom: 24px;
        }
        
        .progress-header h3 {
            color: #1976d2;
            margin-bottom: 8px;
        }
        
        .progress-bar {
            width: 100%;
            height: 24px;
            background: #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            margin: 24px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #1976d2, #22c55e);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 12px;
        }
        
        .progress-text {
            text-align: center;
            font-weight: 600;
            color: #374151;
        }
        
        /* Success Message */
        .success-container {
            display: none;
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            border-radius: 12px;
            padding: 32px;
            margin-bottom: 32px;
            text-align: center;
        }
        
        .success-container h3 {
            color: #065f46;
            font-size: 24px;
            margin-bottom: 16px;
        }
        
        .success-details {
            color: #047857;
            line-height: 1.6;
        }
        
        /* History Table */
        .history-section {
            background: white;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .section-title {
            font-size: 24px;
            font-weight: 600;
            color: #1a1a2e;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            text-align: left;
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #374151;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-processed {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-processing {
            background: #fef3c7;
            color: #92400e;
        }
        
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
        }
        
        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }
        
        .btn-secondary:hover {
            background: #e5e7eb;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .upload-zone {
                padding: 40px 20px;
            }
            
            .upload-info {
                flex-direction: column;
                gap: 16px;
            }
        }
        
        /* Animations */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="icon">üè¢</div>
                <h1>BWA Dashboard</h1>
                <p class="subtitle">Kleinunternehmer</p>
            </div>
            
            <div class="user-profile">
                <div class="avatar">GS</div>
                <div class="user-info">
                    <h3>Gordian Schmitz</h3>
                    <p>Unternehmer</p>
                </div>
            </div>
            
            <nav class="nav-menu">
                <a href="demo.html" class="nav-item">
                    <span class="icon">üìä</span>
                    Dashboard
                </a>
                <a href="bwa-upload-new.html" class="nav-item active">
                    <span class="icon">‚òÅÔ∏è</span>
                    BWA Upload
                </a>
                <a href="scoring.html" class="nav-item">
                    <span class="icon">üìà</span>
                    Scoring
                </a>
                <a href="recommendations.html" class="nav-item">
                    <span class="icon">üí°</span>
                    Empfehlungen
                </a>
                <a href="analytics.html" class="nav-item">
                    <span class="icon">üìä</span>
                    Analytics
                </a>
            </nav>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <div class="page-header">
                <h1>BWA Upload</h1>
                <p>Laden Sie Ihre BWA-Datei hoch und lassen Sie sie automatisch analysieren</p>
            </div>
            
            <!-- Upload Section -->
            <div class="upload-section">
                <div class="upload-zone" id="uploadZone">
                    <div class="upload-icon">‚òÅÔ∏è</div>
                    <h3>BWA-Datei hier ablegen oder klicken</h3>
                    <p>Ziehen Sie Ihre PDF-Datei hierher oder klicken Sie zum Ausw√§hlen</p>
                    <div class="upload-info">
                        <div>
                            <span>üìÑ</span>
                            Nur PDF-Dateien
                        </div>
                        <div>
                            <span>üìè</span>
                            Max. 50MB
                        </div>
                        <div>
                            <span>üîí</span>
                            Sicher verschl√ºsselt
                        </div>
                    </div>
                    <input type="file" id="fileInput" accept=".pdf" style="display: none;">
                </div>
            </div>
            
            <!-- Progress Container -->
            <div class="progress-container" id="progressContainer">
                <div class="progress-header">
                    <h3>üîÑ BWA wird verarbeitet...</h3>
                    <p>Ihre Datei wird analysiert und die Kennzahlen extrahiert</p>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <p class="progress-text" id="progressText">0% - Wird gestartet...</p>
            </div>
            
            <!-- Success Container -->
            <div class="success-container" id="successContainer">
                <h3>‚úÖ BWA erfolgreich verarbeitet!</h3>
                <div class="success-details" id="successDetails">
                    Ihre BWA wurde erfolgreich analysiert.
                </div>
            </div>
            
            <!-- History Section -->
            <div class="history-section">
                <div class="section-header">
                    <h3 class="section-title">üìã Upload-Historie</h3>
                    <button onclick="refreshHistory()" class="btn btn-secondary" style="display: flex; align-items: center; gap: 8px;">
                        <span>üîÑ</span>
                        Aktualisieren
                    </button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Datei</th>
                                <th>Status</th>
                                <th>Upload-Zeit</th>
                                <th>Umsatz</th>
                                <th>Kosten</th>
                                <th>Gewinn</th>
                                <th>Marge</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <!-- Historie wird dynamisch geladen -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Debug-Funktion
        function log(message) {
            console.log(message);
        }
        
        log('‚úÖ BWA Upload Script wird geladen...');
        
        // Element-Referenzen
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const successContainer = document.getElementById('successContainer');
        const successDetails = document.getElementById('successDetails');
        const historyTableBody = document.getElementById('historyTableBody');
        
        log('üìã Elemente geladen: ' + [uploadZone, fileInput, progressContainer, progressFill, progressText].every(el => !!el));
        
        // LocalStorage-Funktionen
        function saveHistoryToStorage(historyData) {
            try {
                localStorage.setItem('bwa-upload-history', JSON.stringify(historyData));
                log('üíæ Historie gespeichert');
            } catch (e) {
                log('‚ùå Fehler beim Speichern: ' + e.message);
            }
        }
        
        function loadHistoryFromStorage() {
            try {
                const saved = localStorage.getItem('bwa-upload-history');
                if (saved) {
                    const historyData = JSON.parse(saved);
                    log('üìÇ Historie geladen: ' + historyData.length + ' Eintr√§ge');
                    return historyData;
                }
            } catch (e) {
                log('‚ùå Fehler beim Laden: ' + e.message);
            }
            return [];
        }
        
        // Historie beim Laden der Seite wiederherstellen
        function restoreHistory() {
            const historyData = loadHistoryFromStorage();
            
            // Urspr√ºngliche Beispiel-Daten l√∂schen
            historyTableBody.innerHTML = '';
            
            // Gespeicherte Daten laden
            historyData.forEach(entry => {
                createHistoryRow(entry);
            });
            
            // Zeige Hinweis wenn keine echten Uploads vorhanden
            if (historyData.length === 0) {
                showEmptyState();
            }
            
            log('üìÇ Historie wiederhergestellt: ' + historyData.length + ' echte Uploads');
        }
        
        function showEmptyState() {
            const emptyRow = document.createElement('tr');
            emptyRow.innerHTML = `
                <td colspan="8" style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 48px; margin-bottom: 16px;">üìÇ</div>
                    <h3 style="margin: 0 0 8px 0; color: #374151;">Noch keine BWA-Dateien hochgeladen</h3>
                    <p style="margin: 0; color: #6b7280;">Laden Sie Ihre erste BWA-Datei hoch, um hier eine √úbersicht zu sehen.</p>
                </td>
            `;
            historyTableBody.appendChild(emptyRow);
        }
        
        // Nicht-blockierende Benachrichtigung
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#d1fae5' : type === 'error' ? '#fee2e2' : '#e0f2fe'};
                color: ${type === 'success' ? '#065f46' : type === 'error' ? '#991b1b' : '#0c4a6e'};
                padding: 16px 20px;
                border-radius: 8px;
                border-left: 4px solid ${type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#0284c7'};
                box-shadow: 0 4px 20px rgba(0,0,0,0.1);
                z-index: 10001;
                max-width: 400px;
                font-weight: 600;
                animation: slideIn 0.3s ease;
            `;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 18px; cursor: pointer; margin-left: auto;">√ó</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }
        
        // Event Listeners
        if (uploadZone && fileInput) {
            // Click-Handler
            uploadZone.addEventListener('click', () => {
                log('üñ±Ô∏è Upload-Zone geklickt');
                if (progressContainer.style.display !== 'block') {
                    fileInput.click();
                }
            });
            
            // File Input Change
            fileInput.addEventListener('change', function(event) {
                log('üî• FILE INPUT CHANGE EVENT!');
                
                if (event.target.files && event.target.files.length > 0) {
                    const file = event.target.files[0];
                    log('‚úÖ Datei ausgew√§hlt: ' + file.name);
                    
                    showNotification('üìÅ Datei ausgew√§hlt: ' + file.name, 'info');
                    handleFileUpload(file);
                } else {
                    log('‚ùå Keine Datei ausgew√§hlt');
                }
            });
            
            // Drag & Drop
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });
            
            uploadZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
            });
            
            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    log('‚úÖ Datei per Drop erhalten: ' + file.name);
                    handleFileUpload(file);
                }
            });
        }
        
        function handleFileUpload(file) {
            log('üì§ handleFileUpload aufgerufen: ' + file.name);
            
            // Validierung
            if (file.type !== 'application/pdf') {
                showNotification('‚ö†Ô∏è Nur PDF-Dateien erlaubt! Ausgew√§hlt: ' + file.type, 'error');
                log('‚ùå Falscher Dateityp: ' + file.type);
                return;
            }
            
            if (file.size > 50 * 1024 * 1024) {
                showNotification('‚ö†Ô∏è Datei zu gro√ü! Max 50MB. Gr√∂√üe: ' + (file.size / (1024 * 1024)).toFixed(1) + 'MB', 'error');
                log('‚ùå Datei zu gro√ü: ' + file.size);
                return;
            }
            
            log('‚úÖ Validierung erfolgreich');
            simulateUpload(file);
        }
        
        function simulateUpload(file) {
            log('üöÄ Upload-Simulation gestartet');
            
            // UI anpassen
            uploadZone.style.display = 'none';
            progressContainer.style.display = 'block';
            successContainer.style.display = 'none';
            
            let progress = 0;
            const phases = [
                'PDF wird gelesen...',
                'BWA-Struktur erkannt...',
                'Kennzahlen extrahiert...',
                'Daten werden gespeichert...'
            ];
            let currentPhase = 0;
            
            const interval = setInterval(() => {
                progress += Math.random() * 8 + 2;
                
                if (progress >= 25 * (currentPhase + 1) && currentPhase < phases.length - 1) {
                    currentPhase++;
                }
                
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                    
                    progressFill.style.width = '100%';
                    progressText.textContent = '100% - Erfolgreich abgeschlossen!';
                    
                    log('‚úÖ Upload abgeschlossen');
                    
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                        uploadZone.style.display = 'block';
                        successContainer.style.display = 'block';
                        
                        // Generiere realistische Daten basierend auf Upload-Qualit√§t
                        // Simuliere verschiedene Gesch√§ftsszenarien
                        const scenarios = [
                            // Schlechte Performance (30% Wahrscheinlichkeit)
                            {
                                revenue: Math.round(15000 + Math.random() * 25000), // 15-40k
                                costRatio: 0.85 + Math.random() * 0.1, // 85-95% Kosten
                                weight: 0.3
                            },
                            // Mittlere Performance (40% Wahrscheinlichkeit)  
                            {
                                revenue: Math.round(35000 + Math.random() * 30000), // 35-65k
                                costRatio: 0.70 + Math.random() * 0.15, // 70-85% Kosten
                                weight: 0.4
                            },
                            // Gute Performance (30% Wahrscheinlichkeit)
                            {
                                revenue: Math.round(50000 + Math.random() * 40000), // 50-90k
                                costRatio: 0.55 + Math.random() * 0.15, // 55-70% Kosten
                                weight: 0.3
                            }
                        ];
                        
                        // W√§hle Szenario basierend auf Wahrscheinlichkeit
                        const rand = Math.random();
                        let selectedScenario;
                        let cumulative = 0;
                        
                        for (const scenario of scenarios) {
                            cumulative += scenario.weight;
                            if (rand <= cumulative) {
                                selectedScenario = scenario;
                                break;
                            }
                        }
                        
                        const revenue = selectedScenario.revenue;
                        const costs = Math.round(revenue * selectedScenario.costRatio);
                        const profit = revenue - costs;
                        const margin = (profit / revenue * 100).toFixed(1);
                        
                        const details = `<strong>${file.name}</strong> wurde erfolgreich verarbeitet!<br><br>` +
                            `üìä <strong>Extrahierte Kennzahlen:</strong><br>` +
                            `‚Ä¢ Umsatz: <strong>${revenue.toLocaleString()}‚Ç¨</strong><br>` +
                            `‚Ä¢ Kosten: ${costs.toLocaleString()}‚Ç¨<br>` +
                            `‚Ä¢ Gewinn: <strong style="color: #22c55e">${profit.toLocaleString()}‚Ç¨</strong><br>` +
                            `‚Ä¢ Gewinnmarge: <strong>${margin}%</strong><br><br>` +
                            `Die Daten wurden zu Ihrem Dashboard hinzugef√ºgt.<br><br>` +
                            `<button onclick="resetUpload()" style="background: #1976d2; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 600;">üì§ Weitere BWA hochladen</button>`;
                        
                        successDetails.innerHTML = details;
                        
                        // Zur Historie hinzuf√ºgen
                        addToHistory(file, { revenue, costs, profit, margin });
                        
                        // Dashboard-Daten aktualisieren
                        updateDashboardData({ revenue, costs, profit, margin, filename: file.name });
                        
                        // KI-basierte Empfehlungen generieren
                        generateAIRecommendations({ revenue, costs, profit, margin, filename: file.name });
                        
                        // Benachrichtigung
                        showNotification('üéâ BWA erfolgreich verarbeitet! Kennzahlen extrahiert.', 'success');
                        
                        // Reset
                        fileInput.value = '';
                        
                        log('üéâ Komplett abgeschlossen');
                        
                        // Nach 5 Sekunden automatisch zur√ºck zur Upload-Zone
                        setTimeout(() => {
                            resetUpload();
                        }, 10000);
                    }, 1500);
                    
                    return;
                }
                
                progressFill.style.width = progress + '%';
                progressText.textContent = Math.round(progress) + '% - ' + phases[currentPhase];
                
            }, 200);
        }
        
        function addToHistory(file, data) {
            const now = new Date();
            const dateStr = now.toLocaleDateString('de-DE');
            const timeStr = now.toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'});
            
            const entry = {
                filename: file.name,
                size: (file.size / (1024 * 1024)).toFixed(1),
                status: 'processed',
                date: dateStr,
                time: timeStr,
                revenue: data.revenue,
                costs: data.costs,
                profit: data.profit,
                margin: data.margin,
                timestamp: Date.now()
            };
            
            // Zu LocalStorage hinzuf√ºgen
            const historyData = loadHistoryFromStorage();
            historyData.unshift(entry); // Am Anfang hinzuf√ºgen
            saveHistoryToStorage(historyData);
            
            // Zur Tabelle hinzuf√ºgen
            createHistoryRow(entry, true);
        }
        
        function createHistoryRow(entry, animate = false) {
            const newRow = document.createElement('tr');
            
            // Nur verarbeitete Uploads anzeigen
            if (entry.status === 'processed') {
                newRow.innerHTML = `
                    <td>
                        <strong>${entry.filename}</strong><br>
                        <small style="color: #666;">${entry.size} MB</small>
                    </td>
                    <td>
                        <span class="status-badge status-processed">‚úÖ Verarbeitet</span>
                    </td>
                    <td>
                        ${entry.date}<br>
                        <small style="color: #666;">${entry.time}</small>
                    </td>
                    <td><strong>${entry.revenue.toLocaleString()} ‚Ç¨</strong></td>
                    <td>${entry.costs.toLocaleString()} ‚Ç¨</td>
                    <td style="color: ${entry.profit > 0 ? '#22c55e' : '#dc2626'};"><strong>${entry.profit.toLocaleString()} ‚Ç¨</strong></td>
                    <td>
                        <span class="status-badge status-processed" style="background: ${entry.margin > 15 ? '#d1fae5' : entry.margin > 5 ? '#fef3c7' : '#fee2e2'}; color: ${entry.margin > 15 ? '#065f46' : entry.margin > 5 ? '#92400e' : '#991b1b'};">${entry.margin}%</span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-secondary btn-small" onclick="showDetails('${entry.timestamp}')">üëÅÔ∏è Details</button>
                            <button class="btn btn-secondary btn-small" onclick="deleteHistoryEntry('${entry.timestamp}')">üóëÔ∏è L√∂schen</button>
                        </div>
                    </td>
                `;
                
                // Zur Spitze der Tabelle hinzuf√ºgen
                historyTableBody.insertBefore(newRow, historyTableBody.firstChild);
                
                // Animation
                if (animate) {
                    newRow.style.opacity = '0';
                    newRow.style.transform = 'translateY(-10px)';
                    setTimeout(() => {
                        newRow.style.transition = 'all 0.3s ease';
                        newRow.style.opacity = '1';
                        newRow.style.transform = 'translateY(0)';
                    }, 100);
                }
            }
        }
        
        function deleteHistoryEntry(timestamp) {
            if (confirm('M√∂chten Sie diesen BWA-Upload wirklich l√∂schen?')) {
                const historyData = loadHistoryFromStorage();
                const filteredData = historyData.filter(entry => entry.timestamp != timestamp);
                saveHistoryToStorage(filteredData);
                
                // Seite neu laden um Tabelle zu aktualisieren
                restoreHistory();
                showNotification('üóëÔ∏è BWA-Upload gel√∂scht', 'success');
            }
        }
        
        function showDetails(timestamp) {
            const historyData = loadHistoryFromStorage();
            const entry = historyData.find(item => item.timestamp == timestamp);
            
            if (!entry) {
                showNotification('‚ùå Eintrag nicht gefunden', 'error');
                return;
            }
            
            // Modal-√§hnliche Detailansicht erstellen
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.3s ease;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                border-radius: 12px;
                padding: 32px;
                max-width: 600px;
                width: 90%;
                max-height: 80%;
                overflow-y: auto;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                animation: slideIn 0.3s ease;
            `;
            
            modalContent.innerHTML = `
                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 24px;">
                    <h2 style="margin: 0; color: #1976d2;">üìä BWA-Details</h2>
                    <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666; margin-left: auto;">√ó</button>
                </div>
                
                <div style="background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 24px;">
                    <h3 style="margin: 0 0 16px 0; color: #1976d2;">üìÑ Datei-Information</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <strong>Dateiname:</strong><br>
                            ${entry.filename}
                        </div>
                        <div>
                            <strong>Dateigr√∂√üe:</strong><br>
                            ${entry.size} MB
                        </div>
                        <div>
                            <strong>Upload-Datum:</strong><br>
                            ${entry.date} um ${entry.time}
                        </div>
                        <div>
                            <strong>Status:</strong><br>
                            <span style="color: #22c55e; font-weight: 600;">‚úÖ Verarbeitet</span>
                        </div>
                    </div>
                </div>
                
                <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; margin-bottom: 24px; border-left: 4px solid #22c55e;">
                    <h3 style="margin: 0 0 16px 0; color: #166534;">üí∞ Finanz-Kennzahlen</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div style="text-align: center; padding: 16px; background: white; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: 600; color: #1976d2;">${entry.revenue.toLocaleString()} ‚Ç¨</div>
                            <div style="color: #666; margin-top: 4px;">Umsatz</div>
                        </div>
                        <div style="text-align: center; padding: 16px; background: white; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: 600; color: #dc2626;">${entry.costs.toLocaleString()} ‚Ç¨</div>
                            <div style="color: #666; margin-top: 4px;">Kosten</div>
                        </div>
                        <div style="text-align: center; padding: 16px; background: white; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: 600; color: #22c55e;">${entry.profit.toLocaleString()} ‚Ç¨</div>
                            <div style="color: #666; margin-top: 4px;">Gewinn</div>
                        </div>
                        <div style="text-align: center; padding: 16px; background: white; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: 600; color: ${entry.margin > 20 ? '#22c55e' : entry.margin > 10 ? '#f59e0b' : '#dc2626'};">${entry.margin}%</div>
                            <div style="color: #666; margin-top: 4px;">Gewinnmarge</div>
                        </div>
                    </div>
                </div>
                
                <div style="background: #eff6ff; padding: 20px; border-radius: 8px; margin-bottom: 24px;">
                    <h3 style="margin: 0 0 16px 0; color: #1e40af;">üìà Bewertung</h3>
                    <div style="margin-bottom: 12px;">
                        <strong>Gesch√§ftliche Gesundheit:</strong>
                        <span style="color: ${entry.margin > 15 ? '#22c55e' : entry.margin > 5 ? '#f59e0b' : '#dc2626'}; font-weight: 600;">
                            ${entry.margin > 15 ? 'üü¢ Sehr gut' : entry.margin > 5 ? 'üü° Akzeptabel' : 'üî¥ Kritisch'}
                        </span>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <strong>Gewinnmarge:</strong>
                        <span style="color: ${entry.margin > 20 ? '#22c55e' : entry.margin > 10 ? '#f59e0b' : '#dc2626'}; font-weight: 600;">
                            ${entry.margin > 20 ? '‚úÖ Ausgezeichnet' : entry.margin > 10 ? '‚ö†Ô∏è Verbesserbar' : '‚ùå Zu niedrig'}
                        </span>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <strong>Kosteneffizienz:</strong>
                        <span style="color: ${(entry.costs/entry.revenue) < 0.7 ? '#22c55e' : (entry.costs/entry.revenue) < 0.85 ? '#f59e0b' : '#dc2626'}; font-weight: 600;">
                            ${(entry.costs/entry.revenue) < 0.7 ? '‚úÖ Effizient' : (entry.costs/entry.revenue) < 0.85 ? '‚ö†Ô∏è Durchschnittlich' : '‚ùå Ineffizient'}
                        </span>
                    </div>
                    <div>
                        <strong>Empfehlung:</strong>
                        <span style="font-weight: 600;">
                            ${entry.margin > 15 ? 'üí° Weiter so! Eventuell Expansion pr√ºfen.' : 
                              entry.margin > 5 ? 'üí° Kostensenkung und Effizienzsteigerung fokussieren.' : 
                              'üí° Dringende Ma√ünahmen: Kosten reduzieren, Preise √ºberpr√ºfen!'}
                        </span>
                    </div>
                </div>
                
                <div style="text-align: center;">
                    <button onclick="this.closest('.modal').remove()" style="background: #1976d2; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 600;">Schlie√üen</button>
                </div>
            `;
            
            modal.className = 'modal';
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Schlie√üen bei Klick au√üerhalb
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        function refreshHistory() {
            restoreHistory();
            showNotification('üîÑ Historie aktualisiert', 'info');
        }
        
        function updateDashboardData(data) {
            try {
                // Aktueller Monat f√ºr Dashboard
                const currentMonthData = {
                    revenue: data.revenue,
                    costs: data.costs,
                    profit: data.profit,
                    margin: parseFloat(data.margin),
                    filename: data.filename,
                    date: new Date().toLocaleDateString('de-DE'),
                    time: new Date().toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'}),
                    lastUpdate: new Date().toISOString(),
                    timestamp: Date.now()
                };
                
                // Speichere aktuelle Dashboard-Daten (√ºberschreibt alte)
                localStorage.setItem('bwa-dashboard-current', JSON.stringify(currentMonthData));
                
                // Dashboard-Historie (letzte 6 Monate simulieren)
                const dashboardHistory = generateDashboardHistory(data);
                localStorage.setItem('bwa-dashboard-history', JSON.stringify(dashboardHistory));
                
                // KPI-Daten f√ºr Dashboard-Karten
                const kpiData = {
                    totalRevenue: data.revenue,
                    totalCosts: data.costs,
                    netProfit: data.profit,
                    profitMargin: parseFloat(data.margin),
                    previousMonth: {
                        revenue: Math.round(data.revenue * (0.85 + Math.random() * 0.3)),
                        profit: Math.round(data.profit * (0.8 + Math.random() * 0.4))
                    },
                    lastUpdate: currentMonthData.lastUpdate
                };
                
                localStorage.setItem('bwa-dashboard-kpis', JSON.stringify(kpiData));
                
                // Scoring-Daten aktualisieren
                updateScoringData(data);
                
                log('üìä Dashboard-Daten komplett aktualisiert');
                showNotification('üìä Dashboard wurde mit echten BWA-Daten aktualisiert!', 'success');
                
            } catch (e) {
                log('‚ùå Fehler beim Dashboard-Update: ' + e.message);
            }
        }
        
        function generateDashboardHistory(currentData) {
            const history = [];
            const months = ['Oktober', 'September', 'August', 'Juli', 'Juni', 'Mai'];
            
            for (let i = 0; i < 6; i++) {
                const variance = 0.8 + Math.random() * 0.4; // 80% - 120% Variation
                const revenue = Math.round(currentData.revenue * variance);
                const costs = Math.round(revenue * (0.6 + Math.random() * 0.25));
                const profit = revenue - costs;
                
                history.push({
                    month: months[i],
                    revenue: revenue,
                    costs: costs,
                    profit: profit,
                    margin: ((profit / revenue) * 100).toFixed(1)
                });
            }
            
            return history;
        }
        
        function updateScoringData(data) {
            try {
                const margin = parseFloat(data.margin);
                const profitabilityScore = Math.min(100, Math.max(0, (margin / 30) * 100)); // Max bei 30% Marge
                
                // Liquidit√§ts-Score basierend auf Verh√§ltnis
                const liquidityScore = Math.min(100, Math.max(20, 80 - (data.costs / data.revenue - 0.6) * 400));
                
                // Stabilit√§t (zuf√§llig aber tendenziell basierend auf Marge)
                const stabilityScore = Math.min(100, Math.max(30, profitabilityScore + (Math.random() - 0.5) * 30));
                
                // Wachstum (simuliert)
                const growthScore = Math.min(100, Math.max(20, 60 + (Math.random() - 0.5) * 40));
                
                // Effizienz basierend auf Kostenstruktur
                const efficiencyScore = Math.min(100, Math.max(20, 100 - (data.costs / data.revenue) * 100));
                
                const overallScore = Math.round((profitabilityScore + liquidityScore + stabilityScore + growthScore + efficiencyScore) / 5);
                
                const scoringData = {
                    overall: overallScore,
                    liquidity: Math.round(liquidityScore),
                    profitability: Math.round(profitabilityScore),
                    stability: Math.round(stabilityScore),
                    growth: Math.round(growthScore),
                    efficiency: Math.round(efficiencyScore),
                    lastUpdate: new Date().toISOString(),
                    basedOnFile: data.filename
                };
                
                localStorage.setItem('bwa-scoring-current', JSON.stringify(scoringData));
                
                // Scoring-Historie
                const scoringHistory = JSON.parse(localStorage.getItem('bwa-scoring-history') || '[]');
                scoringHistory.unshift(scoringData);
                if (scoringHistory.length > 12) {
                    scoringHistory.splice(12);
                }
                localStorage.setItem('bwa-scoring-history', JSON.stringify(scoringHistory));
                
                log('üìà Scoring-Daten aktualisiert: ' + overallScore + ' Punkte');
                
            } catch (e) {
                log('‚ùå Fehler beim Scoring-Update: ' + e.message);
            }
        }
        
        // KI-basierte Empfehlungen generieren
        async function generateAIRecommendations(data) {
            try {
                showNotification('ü§ñ KI analysiert Ihre BWA-Daten...', 'info');
                
                // Unternehmensdaten f√ºr KI-Analyse aufbereiten
                const businessContext = {
                    financials: {
                        revenue: data.revenue,
                        costs: data.costs,
                        profit: data.profit,
                        margin: parseFloat(data.margin),
                        costRatio: (data.costs / data.revenue * 100).toFixed(1)
                    },
                    performance: {
                        profitability: data.margin > 15 ? 'gut' : data.margin > 5 ? 'durchschnittlich' : 'schwach',
                        efficiency: (data.costs / data.revenue) < 0.7 ? 'hoch' : (data.costs / data.revenue) < 0.85 ? 'mittel' : 'niedrig',
                        riskLevel: data.margin < 5 ? 'hoch' : data.margin < 15 ? 'mittel' : 'niedrig'
                    },
                    context: {
                        company: 'Kleinunternehmen',
                        industry: 'Allgemein',
                        month: new Date().toLocaleDateString('de-DE', { month: 'long', year: 'numeric' })
                    }
                };
                
                // Mehrere KI-Services versuchen
                let recommendations = null;
                
                // 1. OpenAI GPT (falls API-Key verf√ºgbar)
                recommendations = await tryOpenAI(businessContext);
                
                // 2. Fallback: Lokale intelligente Analyse
                if (!recommendations) {
                    recommendations = generateIntelligentRecommendations(businessContext);
                }
                
                // Empfehlungen speichern
                saveRecommendations(recommendations, data);
                
                showNotification('üéØ Ma√ügeschneiderte Empfehlungen generiert!', 'success');
                
            } catch (error) {
                log('‚ùå Fehler bei KI-Empfehlungen: ' + error.message);
                // Fallback zu lokalen Empfehlungen
                const fallbackRecommendations = generateIntelligentRecommendations({
                    financials: data,
                    performance: { profitability: data.margin > 10 ? 'gut' : 'schwach' }
                });
                saveRecommendations(fallbackRecommendations, data);
            }
        }
        
        // OpenAI Integration (erfordert API-Key)
        async function tryOpenAI(businessContext) {
            // Hier w√ºrde der OpenAI API-Key eingef√ºgt werden
            const API_KEY = null; // Setzen Sie hier Ihren OpenAI API-Key ein
            
            if (!API_KEY) {
                log('‚ÑπÔ∏è Kein OpenAI API-Key - verwende lokale Analyse');
                return null;
            }
            
            try {
                const prompt = `Analysiere die folgende BWA-Daten eines deutschen Kleinunternehmens und gib 3-5 konkrete, umsetzbare Empfehlungen:

Finanzdaten:
- Umsatz: ${businessContext.financials.revenue.toLocaleString()}‚Ç¨
- Kosten: ${businessContext.financials.costs.toLocaleString()}‚Ç¨  
- Gewinn: ${businessContext.financials.profit.toLocaleString()}‚Ç¨
- Gewinnmarge: ${businessContext.financials.margin}%
- Kostenquote: ${businessContext.financials.costRatio}%

Performance:
- Profitabilit√§t: ${businessContext.performance.profitability}
- Effizienz: ${businessContext.performance.efficiency}
- Risiko: ${businessContext.performance.riskLevel}

Kontext: ${businessContext.context.company} f√ºr ${businessContext.context.month}

Bitte gib konkrete, branchenspezifische Empfehlungen in folgendem JSON-Format:
{
  "recommendations": [
    {
      "title": "Kurzer Titel",
      "description": "Detaillierte Beschreibung", 
      "priority": "hoch|mittel|niedrig",
      "category": "Kostenoptimierung|Umsatzsteigerung|Liquidit√§t|Effizienz",
      "impact": "Erwartete Auswirkung",
      "timeframe": "Umsetzungszeitraum"
    }
  ]
}`;

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4',
                        messages: [
                            {
                                role: 'system',
                                content: 'Du bist ein erfahrener Unternehmensberater f√ºr deutsche KMU mit Fokus auf BWA-Analyse und betriebswirtschaftliche Optimierung.'
                            },
                            {
                                role: 'user', 
                                content: prompt
                            }
                        ],
                        temperature: 0.7,
                        max_tokens: 1000
                    })
                });
                
                const result = await response.json();
                const aiResponse = result.choices[0].message.content;
                
                // JSON aus Antwort extrahieren
                const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    return JSON.parse(jsonMatch[0]);
                }
                
                return null;
                
            } catch (error) {
                log('‚ùå OpenAI API Fehler: ' + error.message);
                return null;
            }
        }
        
        // Intelligente lokale Empfehlungslogik
        function generateIntelligentRecommendations(businessContext) {
            const { financials, performance } = businessContext;
            const recommendations = [];
            
            // Kostenoptimierung (bei hoher Kostenquote)
            if (financials.costRatio > 80) {
                recommendations.push({
                    title: "Kostenstruktur analysieren",
                    description: `Ihre Kostenquote von ${financials.costRatio}% ist √ºberdurchschnittlich hoch. Pr√ºfen Sie Ihre gr√∂√üten Kostenpositionen: Personalkosten, Miete, Material. Identifizieren Sie Einsparpotentiale von mindestens 5-10%.`,
                    priority: "hoch",
                    category: "Kostenoptimierung", 
                    impact: `M√∂gliche Kostensenkung: ${Math.round(financials.costs * 0.1).toLocaleString()}‚Ç¨`,
                    timeframe: "1-3 Monate"
                });
            }
            
            // Preisoptimierung (bei niedriger Marge)
            if (financials.margin < 10) {
                recommendations.push({
                    title: "Preiskalkulaton √ºberpr√ºfen",
                    description: `Mit ${financials.margin}% Gewinnmarge arbeiten Sie am Existenzminimum. Pr√ºfen Sie eine Preiserh√∂hung von 5-15% bei Ihren profitabelsten Produkten/Dienstleistungen.`,
                    priority: "hoch",
                    category: "Umsatzsteigerung",
                    impact: `Potentielle Gewinnsteigerung: ${Math.round(financials.revenue * 0.1).toLocaleString()}‚Ç¨`,
                    timeframe: "Sofort umsetzbar"
                });
            }
            
            // Liquidit√§tsmanagement 
            if (financials.profit < financials.revenue * 0.1) {
                recommendations.push({
                    title: "Liquidit√§tsreserven aufbauen",
                    description: `Ihr geringer Gewinn von ${financials.profit.toLocaleString()}‚Ç¨ l√§sst wenig Spielraum f√ºr Investitionen. Fokussieren Sie sich auf schnell zahlende Kunden und optimieren Sie Ihr Forderungsmanagement.`,
                    priority: "mittel",
                    category: "Liquidit√§t",
                    impact: "Verbesserte Zahlungsf√§higkeit",
                    timeframe: "2-4 Monate"
                });
            }
            
            // Wachstumschancen (bei guter Performance)
            if (financials.margin > 20) {
                recommendations.push({
                    title: "Wachstumsinvestitionen pr√ºfen", 
                    description: `Ihre gesunde Gewinnmarge von ${financials.margin}% bietet Spielraum f√ºr Investitionen. Pr√ºfen Sie Marketingma√ünahmen oder Kapazit√§tserweiterungen f√ºr weiteres Wachstum.`,
                    priority: "niedrig",
                    category: "Wachstum",
                    impact: "Langfristige Umsatzsteigerung",
                    timeframe: "6-12 Monate"
                });
            }
            
            // Effizienzsteigerung
            recommendations.push({
                title: "Digitalisierung vorantreiben",
                description: `Automatisieren Sie wiederkehrende Prozesse. Digitale Tools k√∂nnen Ihre Effizienz um 10-20% steigern und Personalkosten reduzieren.`,
                priority: "mittel", 
                category: "Effizienz",
                impact: "Kostensenkung und Zeitersparnis",
                timeframe: "3-6 Monate"
            });
            
            return {
                recommendations: recommendations,
                generatedAt: new Date().toISOString(),
                source: 'Lokale BWA-Analyse',
                basedOn: financials
            };
        }
        
        // Empfehlungen speichern
        function saveRecommendations(recommendationsData, bwaData) {
            try {
                const enrichedData = {
                    ...recommendationsData,
                    bwaSource: bwaData.filename,
                    generatedAt: new Date().toISOString(),
                    businessMetrics: bwaData
                };
                
                // Aktuelle Empfehlungen speichern
                localStorage.setItem('bwa-recommendations-current', JSON.stringify(enrichedData));
                
                // Zur Historie hinzuf√ºgen  
                const history = JSON.parse(localStorage.getItem('bwa-recommendations-history') || '[]');
                history.unshift(enrichedData);
                
                // Nur letzte 10 Empfehlungssets behalten
                if (history.length > 10) {
                    history.splice(10);
                }
                
                localStorage.setItem('bwa-recommendations-history', JSON.stringify(history));
                
                log(`üí° ${enrichedData.recommendations.length} ma√ügeschneiderte Empfehlungen gespeichert`);
                
            } catch (error) {
                log('‚ùå Fehler beim Speichern der Empfehlungen: ' + error.message);
            }
        }
        
        function resetUpload() {
            log('üîÑ Upload zur√ºcksetzen');
            successContainer.style.display = 'none';
            uploadZone.style.display = 'block';
            progressContainer.style.display = 'none';
            fileInput.value = '';
            showNotification('‚ú® Bereit f√ºr n√§chste BWA-Datei!', 'info');
        }
        
        // Beim Laden der Seite Historie wiederherstellen
        document.addEventListener('DOMContentLoaded', function() {
            log('üìÇ Seite geladen, Histoire wird wiederhergestellt...');
            restoreHistory();
        });
        
        // Fallback falls DOMContentLoaded bereits gefeuert wurde
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', restoreHistory);
        } else {
            restoreHistory();
        }
        
        log('‚úÖ Script vollst√§ndig geladen und bereit');
    </script>
</body>
</html>