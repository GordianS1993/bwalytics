<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BWA Upload | BWA-Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
        }
        
        .sidebar-header {
            padding: 24px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.12);
        }
        
        .sidebar-header .icon {
            font-size: 48px;
            color: #4fc3f7;
            margin-bottom: 8px;
        }
        
        .sidebar-header h1 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .sidebar-header .subtitle {
            font-size: 14px;
            color: rgba(255,255,255,0.7);
        }
        
        .user-profile {
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.12);
        }
        
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #4fc3f7;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        
        .user-info h3 {
            font-size: 14px;
            font-weight: 600;
        }
        
        .user-info p {
            font-size: 12px;
            color: rgba(255,255,255,0.7);
        }
        
        .nav-menu {
            padding: 16px;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: white;
        }
        
        .nav-item:hover {
            background: rgba(79, 195, 247, 0.1);
        }
        
        .nav-item.active {
            background: #4fc3f7;
            color: #1a1a2e;
        }
        
        .nav-item .icon {
            margin-right: 12px;
            font-size: 20px;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 24px;
        }
        
        .page-header {
            margin-bottom: 32px;
        }
        
        .page-header h1 {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .page-header p {
            color: #666;
            font-size: 16px;
        }
        
        /* Upload Zone */
        .upload-section {
            background: white;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 32px;
        }
        
        .upload-zone {
            border: 3px dashed #1976d2;
            border-radius: 12px;
            padding: 80px 40px;
            text-align: center;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 24px;
            position: relative;
        }
        
        .upload-zone:hover {
            border-color: #1565c0;
            background: #f0f4ff;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(25, 118, 210, 0.15);
        }
        
        .upload-zone.dragover {
            border-color: #22c55e;
            background: #f0fdf4;
            transform: scale(1.02);
            box-shadow: 0 0 30px rgba(34, 197, 94, 0.2);
        }
        
        .upload-icon {
            font-size: 64px;
            color: #1976d2;
            margin-bottom: 24px;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .upload-zone h3 {
            font-size: 24px;
            color: #1976d2;
            margin-bottom: 12px;
            font-weight: 600;
        }
        
        .upload-zone p {
            color: #666;
            font-size: 16px;
            margin-bottom: 24px;
        }
        
        .upload-info {
            display: flex;
            justify-content: center;
            gap: 32px;
            font-size: 14px;
            color: #666;
        }
        
        .upload-info div {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(25, 118, 210, 0.1);
            border-radius: 20px;
        }
        
        /* Progress */
        .progress-container {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 32px;
        }
        
        .progress-header {
            text-align: center;
            margin-bottom: 24px;
        }
        
        .progress-header h3 {
            color: #1976d2;
            margin-bottom: 8px;
        }
        
        .progress-bar {
            width: 100%;
            height: 24px;
            background: #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            margin: 24px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #1976d2, #22c55e);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 12px;
        }
        
        .progress-text {
            text-align: center;
            font-weight: 600;
            color: #374151;
        }
        
        /* Success Message */
        .success-container {
            display: none;
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            border-radius: 12px;
            padding: 32px;
            margin-bottom: 32px;
            text-align: center;
        }
        
        .success-container h3 {
            color: #065f46;
            font-size: 24px;
            margin-bottom: 16px;
        }
        
        .success-details {
            color: #047857;
            line-height: 1.6;
        }
        
        /* History Table */
        .history-section {
            background: white;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .section-title {
            font-size: 24px;
            font-weight: 600;
            color: #1a1a2e;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            text-align: left;
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #374151;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-processed {
            background: #d1fae5;
            color: #065f46;
        }
        
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
        }
        
        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }
        
        .btn-secondary:hover {
            background: #e5e7eb;
            transform: translateY(-1px);
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .upload-zone {
                padding: 40px 20px;
            }
            
            .upload-info {
                flex-direction: column;
                gap: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="icon">üè¢</div>
                <h1>BWA Dashboard</h1>
                <p class="subtitle">Kleinunternehmer</p>
            </div>
            
            <div class="user-profile">
                <div class="avatar">GS</div>
                <div class="user-info">
                    <h3>Gordian Schmitz</h3>
                    <p>Unternehmer</p>
                </div>
            </div>
            
            <nav class="nav-menu">
                <a href="demo.html" class="nav-item">
                    <span class="icon">üìä</span>
                    Dashboard
                </a>
                <a href="bwa-upload-final.html" class="nav-item active">
                    <span class="icon">‚òÅÔ∏è</span>
                    BWA Upload
                </a>
                <a href="scoring.html" class="nav-item">
                    <span class="icon">üìà</span>
                    Scoring
                </a>
                <a href="recommendations.html" class="nav-item">
                    <span class="icon">üí°</span>
                    Empfehlungen
                </a>
                <a href="analytics.html" class="nav-item">
                    <span class="icon">üìä</span>
                    Analytics
                </a>
            </nav>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <div class="page-header">
                <h1>BWA Upload</h1>
                <p>Laden Sie Ihre BWA-Datei hoch und lassen Sie sie automatisch analysieren</p>
            </div>
            
            <!-- Upload Section -->
            <div class="upload-section">
                <div class="upload-zone" id="uploadZone">
                    <div class="upload-icon">‚òÅÔ∏è</div>
                    <h3>üìÑ Klicken Sie hier, um Ihre BWA-Datei hochzuladen</h3>
                    <p>Ziehen Sie Ihre PDF-Datei hierher oder klicken Sie zum Ausw√§hlen</p>
                    <div class="upload-info">
                        <div>
                            <span>üìÑ</span>
                            Nur PDF-Dateien
                        </div>
                        <div>
                            <span>üìè</span>
                            Max. 50MB
                        </div>
                        <div>
                            <span>üîí</span>
                            Sicher verschl√ºsselt
                        </div>
                    </div>
                    <input type="file" id="fileInput" accept=".pdf" style="display: none;">
                </div>
            </div>
            
            <!-- Progress Container -->
            <div class="progress-container" id="progressContainer">
                <div class="progress-header">
                    <h3>üîÑ BWA wird verarbeitet...</h3>
                    <p>Ihre Datei wird analysiert und die Kennzahlen extrahiert</p>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <p class="progress-text" id="progressText">0% - Wird gestartet...</p>
            </div>
            
            <!-- Success Container -->
            <div class="success-container" id="successContainer">
                <h3>‚úÖ BWA erfolgreich verarbeitet!</h3>
                <div class="success-details" id="successDetails">
                    Ihre BWA wurde erfolgreich analysiert.
                </div>
            </div>
            
            <!-- History Section -->
            <div class="history-section">
                <div class="section-header">
                    <h3 class="section-title">üìã Upload-Historie</h3>
                    <button onclick="refreshHistory()" class="btn btn-secondary" style="display: flex; align-items: center; gap: 8px;">
                        <span>üîÑ</span>
                        Aktualisieren
                    </button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Datei</th>
                                <th>Status</th>
                                <th>Upload-Zeit</th>
                                <th>Umsatz</th>
                                <th>Kosten</th>
                                <th>Gewinn</th>
                                <th>Marge</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <!-- Historie wird dynamisch geladen -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        console.log('üöÄ BWA Upload Final - Version geladen');
        
        // Element-Referenzen
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const successContainer = document.getElementById('successContainer');
        const successDetails = document.getElementById('successDetails');
        const historyTableBody = document.getElementById('historyTableBody');
        
        console.log('‚úÖ Alle Elemente gefunden:', {
            uploadZone: !!uploadZone,
            fileInput: !!fileInput,
            progressContainer: !!progressContainer,
            historyTableBody: !!historyTableBody
        });
        
        // Nicht-blockierende Benachrichtigung
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#d1fae5' : type === 'error' ? '#fee2e2' : '#e0f2fe'};
                color: ${type === 'success' ? '#065f46' : type === 'error' ? '#991b1b' : '#0c4a6e'};
                padding: 16px 20px;
                border-radius: 8px;
                border-left: 4px solid ${type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#0284c7'};
                box-shadow: 0 4px 20px rgba(0,0,0,0.1);
                z-index: 10001;
                max-width: 400px;
                font-weight: 600;
                animation: slideIn 0.3s ease;
            `;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 18px; cursor: pointer; margin-left: auto;">√ó</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }
        
        // Event Listeners sofort nach DOM-Load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéØ DOM Content Loaded - Event Listeners werden gesetzt');
            setupEventListeners();
            restoreHistory();
        });
        
        // Fallback falls DOMContentLoaded bereits gefeuert
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                setupEventListeners();
                restoreHistory();
            });
        } else {
            setupEventListeners();
            restoreHistory();
        }
        
        function setupEventListeners() {
            if (!uploadZone || !fileInput) {
                console.error('‚ùå Upload-Elemente nicht gefunden!');
                return;
            }
            
            console.log('üîß Event Listeners werden gesetzt...');
            
            // Click-Handler
            uploadZone.addEventListener('click', function(e) {
                console.log('üñ±Ô∏è Upload-Zone geklickt!');
                e.preventDefault();
                if (progressContainer.style.display !== 'block') {
                    fileInput.click();
                }
            });
            
            // File Input Change
            fileInput.addEventListener('change', function(event) {
                console.log('üìÅ FILE INPUT CHANGE EVENT ausgel√∂st!');
                
                if (event.target.files && event.target.files.length > 0) {
                    const file = event.target.files[0];
                    console.log('‚úÖ Datei ausgew√§hlt:', file.name);
                    
                    showNotification('üìÅ Datei ausgew√§hlt: ' + file.name, 'info');
                    handleFileUpload(file);
                } else {
                    console.log('‚ùå Keine Datei ausgew√§hlt');
                }
            });
            
            // Drag & Drop
            uploadZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });
            
            uploadZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
            });
            
            uploadZone.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    console.log('‚úÖ Datei per Drop erhalten:', file.name);
                    handleFileUpload(file);
                }
            });
            
            console.log('‚úÖ Alle Event Listeners erfolgreich gesetzt!');
        }
        
        function handleFileUpload(file) {
            console.log('üì§ handleFileUpload aufgerufen mit:', file.name);
            
            // Validierung
            if (file.type !== 'application/pdf') {
                showNotification('‚ö†Ô∏è Nur PDF-Dateien erlaubt! Ausgew√§hlt: ' + file.type, 'error');
                console.log('‚ùå Falscher Dateityp:', file.type);
                return;
            }
            
            if (file.size > 50 * 1024 * 1024) {
                showNotification('‚ö†Ô∏è Datei zu gro√ü! Max 50MB. Gr√∂√üe: ' + (file.size / (1024 * 1024)).toFixed(1) + 'MB', 'error');
                console.log('‚ùå Datei zu gro√ü:', file.size);
                return;
            }
            
            console.log('‚úÖ Validierung erfolgreich - starte Upload-Simulation');
            simulateUpload(file);
        }
        
        function simulateUpload(file) {
            console.log('üöÄ Upload-Simulation gestartet f√ºr:', file.name);
            
            // UI anpassen
            uploadZone.style.display = 'none';
            progressContainer.style.display = 'block';
            successContainer.style.display = 'none';
            
            let progress = 0;
            const phases = [
                'PDF wird gelesen...',
                'BWA-Struktur erkannt...',
                'Kennzahlen extrahiert...',
                'KI-Analyse l√§uft...',
                'Daten werden gespeichert...'
            ];
            let currentPhase = 0;
            
            const interval = setInterval(() => {
                progress += Math.random() * 6 + 3;
                
                if (progress >= 20 * (currentPhase + 1) && currentPhase < phases.length - 1) {
                    currentPhase++;
                }
                
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                    
                    progressFill.style.width = '100%';
                    progressText.textContent = '100% - Erfolgreich abgeschlossen!';
                    
                    console.log('‚úÖ Upload-Simulation abgeschlossen');
                    
                    setTimeout(() => {
                        completeUpload(file);
                    }, 1500);
                    
                    return;
                }
                
                progressFill.style.width = progress + '%';
                progressText.textContent = Math.round(progress) + '% - ' + phases[currentPhase];
                
            }, 200);
        }
        
        function completeUpload(file) {
            // Realistische Gesch√§ftsszenarien
            const scenarios = [
                { revenue: [15000, 25000], costRatio: [0.85, 0.95], weight: 0.3 }, // Schlecht
                { revenue: [35000, 50000], costRatio: [0.70, 0.85], weight: 0.4 }, // Mittel
                { revenue: [50000, 80000], costRatio: [0.55, 0.70], weight: 0.3 }  // Gut
            ];
            
            const rand = Math.random();
            let selectedScenario;
            let cumulative = 0;
            
            for (const scenario of scenarios) {
                cumulative += scenario.weight;
                if (rand <= cumulative) {
                    selectedScenario = scenario;
                    break;
                }
            }
            
            const revenue = Math.round(selectedScenario.revenue[0] + Math.random() * (selectedScenario.revenue[1] - selectedScenario.revenue[0]));
            const costRatio = selectedScenario.costRatio[0] + Math.random() * (selectedScenario.costRatio[1] - selectedScenario.costRatio[0]);
            const costs = Math.round(revenue * costRatio);
            const profit = revenue - costs;
            const margin = (profit / revenue * 100).toFixed(1);
            
            progressContainer.style.display = 'none';
            uploadZone.style.display = 'block';
            successContainer.style.display = 'block';
            
            const details = `<strong>${file.name}</strong> wurde erfolgreich verarbeitet!<br><br>` +
                `üìä <strong>Extrahierte Kennzahlen:</strong><br>` +
                `‚Ä¢ Umsatz: <strong>${revenue.toLocaleString()}‚Ç¨</strong><br>` +
                `‚Ä¢ Kosten: ${costs.toLocaleString()}‚Ç¨<br>` +
                `‚Ä¢ Gewinn: <strong style="color: ${profit > 0 ? '#22c55e' : '#dc2626'}">${profit.toLocaleString()}‚Ç¨</strong><br>` +
                `‚Ä¢ Gewinnmarge: <strong>${margin}%</strong><br><br>` +
                `ü§ñ <strong>KI-Empfehlungen generiert!</strong><br>` +
                `Die Daten wurden zu Ihrem Dashboard hinzugef√ºgt.<br><br>` +
                `<button onclick="resetUpload()" style="background: #1976d2; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 600; margin-right: 12px;">üì§ Weitere BWA hochladen</button>` +
                `<button onclick="window.open('recommendations.html', '_blank')" style="background: #22c55e; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 600;">üí° Empfehlungen ansehen</button>`;
            
            successDetails.innerHTML = details;
            
            // Zur Historie hinzuf√ºgen
            addToHistory(file, { revenue, costs, profit, margin });
            
            // Dashboard-Daten aktualisieren
            updateDashboardData({ revenue, costs, profit, margin, filename: file.name });
            
            // Reset
            fileInput.value = '';
            
            console.log('üéâ Upload komplett abgeschlossen');
            showNotification('üéâ BWA erfolgreich verarbeitet! Dashboard & Empfehlungen aktualisiert.', 'success');
            
            // Auto-Reset nach 15 Sekunden
            setTimeout(() => {
                resetUpload();
            }, 15000);
        }
        
        function resetUpload() {
            console.log('üîÑ Upload zur√ºcksetzen');
            successContainer.style.display = 'none';
            uploadZone.style.display = 'block';
            progressContainer.style.display = 'none';
            fileInput.value = '';
            showNotification('‚ú® Bereit f√ºr n√§chste BWA-Datei!', 'info');
        }
        
        // LocalStorage-Funktionen mit eindeutigem Prefix
        function saveHistoryToStorage(historyData) {
            try {
                localStorage.setItem('bwa-final-upload-history', JSON.stringify(historyData));
            } catch (e) {
                console.error('Fehler beim Speichern:', e);
            }
        }
        
        function loadHistoryFromStorage() {
            try {
                const saved = localStorage.getItem('bwa-final-upload-history');
                return saved ? JSON.parse(saved) : [];
            } catch (e) {
                console.error('Fehler beim Laden:', e);
                return [];
            }
        }
        
        function restoreHistory() {
            const historyData = loadHistoryFromStorage();
            historyTableBody.innerHTML = '';
            
            if (historyData.length === 0) {
                showEmptyState();
            } else {
                historyData.forEach(entry => {
                    createHistoryRow(entry);
                });
            }
            
            console.log('üìÇ Historie wiederhergestellt:', historyData.length, 'Eintr√§ge');
        }
        
        function showEmptyState() {
            const emptyRow = document.createElement('tr');
            emptyRow.innerHTML = `
                <td colspan="8" style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 48px; margin-bottom: 16px;">üìÇ</div>
                    <h3 style="margin: 0 0 8px 0; color: #374151;">Noch keine BWA-Dateien hochgeladen</h3>
                    <p style="margin: 0; color: #6b7280;">Laden Sie Ihre erste BWA-Datei hoch, um hier eine √úbersicht zu sehen.</p>
                </td>
            `;
            historyTableBody.appendChild(emptyRow);
        }
        
        function addToHistory(file, data) {
            const now = new Date();
            const entry = {
                filename: file.name,
                size: (file.size / (1024 * 1024)).toFixed(1),
                status: 'processed',
                date: now.toLocaleDateString('de-DE'),
                time: now.toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'}),
                revenue: data.revenue,
                costs: data.costs,
                profit: data.profit,
                margin: data.margin,
                timestamp: Date.now()
            };
            
            const historyData = loadHistoryFromStorage();
            historyData.unshift(entry);
            saveHistoryToStorage(historyData);
            
            createHistoryRow(entry, true);
        }
        
        function createHistoryRow(entry, animate = false) {
            if (entry.status !== 'processed') return;
            
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>
                    <strong>${entry.filename}</strong><br>
                    <small style="color: #666;">${entry.size} MB</small>
                </td>
                <td>
                    <span class="status-badge status-processed">‚úÖ Verarbeitet</span>
                </td>
                <td>
                    ${entry.date}<br>
                    <small style="color: #666;">${entry.time}</small>
                </td>
                <td><strong>${entry.revenue.toLocaleString()} ‚Ç¨</strong></td>
                <td>${entry.costs.toLocaleString()} ‚Ç¨</td>
                <td style="color: ${entry.profit > 0 ? '#22c55e' : '#dc2626'};"><strong>${entry.profit.toLocaleString()} ‚Ç¨</strong></td>
                <td>
                    <span class="status-badge status-processed" style="background: ${entry.margin > 15 ? '#d1fae5' : entry.margin > 5 ? '#fef3c7' : '#fee2e2'}; color: ${entry.margin > 15 ? '#065f46' : entry.margin > 5 ? '#92400e' : '#991b1b'};">${entry.margin}%</span>
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-secondary btn-small" onclick="showDetails('${entry.timestamp}')">üëÅÔ∏è Details</button>
                        <button class="btn btn-secondary btn-small" onclick="deleteHistoryEntry('${entry.timestamp}')">üóëÔ∏è L√∂schen</button>
                    </div>
                </td>
            `;
            
            if (historyTableBody.firstChild && historyTableBody.firstChild.colSpan) {
                historyTableBody.innerHTML = '';
            }
            
            historyTableBody.insertBefore(newRow, historyTableBody.firstChild);
            
            if (animate) {
                newRow.style.opacity = '0';
                newRow.style.transform = 'translateY(-10px)';
                setTimeout(() => {
                    newRow.style.transition = 'all 0.3s ease';
                    newRow.style.opacity = '1';
                    newRow.style.transform = 'translateY(0)';
                }, 100);
            }
        }
        
        function deleteHistoryEntry(timestamp) {
            if (confirm('M√∂chten Sie diesen BWA-Upload wirklich l√∂schen?')) {
                const historyData = loadHistoryFromStorage();
                const filteredData = historyData.filter(entry => entry.timestamp != timestamp);
                saveHistoryToStorage(filteredData);
                
                restoreHistory();
                showNotification('üóëÔ∏è BWA-Upload gel√∂scht', 'success');
            }
        }
        
        function showDetails(timestamp) {
            const historyData = loadHistoryFromStorage();
            const entry = historyData.find(item => item.timestamp == timestamp);
            
            if (!entry) {
                showNotification('‚ùå Eintrag nicht gefunden', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 10000; display: flex;
                align-items: center; justify-content: center; animation: fadeIn 0.3s ease;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 32px; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 style="margin: 0; color: #1976d2;">üìä BWA-Details</h2>
                        <button onclick="this.closest('div').parentElement.remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">√ó</button>
                    </div>
                    
                    <div style="background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 24px;">
                        <h3 style="margin: 0 0 16px 0; color: #1976d2;">üìÑ Datei-Information</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div><strong>Dateiname:</strong><br>${entry.filename}</div>
                            <div><strong>Dateigr√∂√üe:</strong><br>${entry.size} MB</div>
                            <div><strong>Upload-Datum:</strong><br>${entry.date} um ${entry.time}</div>
                            <div><strong>Status:</strong><br><span style="color: #22c55e;">‚úÖ Verarbeitet</span></div>
                        </div>
                    </div>
                    
                    <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; margin-bottom: 24px;">
                        <h3 style="margin: 0 0 16px 0; color: #166534;">üí∞ Finanz-Kennzahlen</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div style="text-align: center; padding: 16px; background: white; border-radius: 8px;">
                                <div style="font-size: 24px; font-weight: 600; color: #1976d2;">${entry.revenue.toLocaleString()} ‚Ç¨</div>
                                <div style="color: #666;">Umsatz</div>
                            </div>
                            <div style="text-align: center; padding: 16px; background: white; border-radius: 8px;">
                                <div style="font-size: 24px; font-weight: 600; color: #dc2626;">${entry.costs.toLocaleString()} ‚Ç¨</div>
                                <div style="color: #666;">Kosten</div>
                            </div>
                            <div style="text-align: center; padding: 16px; background: white; border-radius: 8px;">
                                <div style="font-size: 24px; font-weight: 600; color: ${entry.profit > 0 ? '#22c55e' : '#dc2626'};">${entry.profit.toLocaleString()} ‚Ç¨</div>
                                <div style="color: #666;">Gewinn</div>
                            </div>
                            <div style="text-align: center; padding: 16px; background: white; border-radius: 8px;">
                                <div style="font-size: 24px; font-weight: 600; color: ${entry.margin > 15 ? '#22c55e' : entry.margin > 5 ? '#f59e0b' : '#dc2626'};">${entry.margin}%</div>
                                <div style="color: #666;">Gewinnmarge</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center;">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: #1976d2; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer;">Schlie√üen</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) modal.remove();
            });
        }
        
        function refreshHistory() {
            restoreHistory();
            showNotification('üîÑ Historie aktualisiert', 'info');
        }
        
        function updateDashboardData(data) {
            try {
                // Hauptdashboard-Daten
                const dashboardData = {
                    revenue: data.revenue,
                    costs: data.costs,
                    profit: data.profit,
                    margin: parseFloat(data.margin),
                    filename: data.filename,
                    lastUpdate: new Date().toISOString(),
                    timestamp: Date.now()
                };
                
                // Dashboard-KPIs √ºberschreiben
                localStorage.setItem('bwa-dashboard-current', JSON.stringify(dashboardData));
                localStorage.setItem('bwa-dashboard-kpis', JSON.stringify({
                    totalRevenue: data.revenue,
                    totalCosts: data.costs,
                    netProfit: data.profit,
                    profitMargin: parseFloat(data.margin),
                    revenueGrowth: (Math.random() * 20 - 10).toFixed(1), // Simuliert
                    costReduction: (Math.random() * 15).toFixed(1),
                    lastUpdate: dashboardData.lastUpdate
                }));
                
                // Chart-Daten f√ºr Dashboard
                const chartData = generateChartData(data);
                localStorage.setItem('bwa-dashboard-charts', JSON.stringify(chartData));
                
                // Scoring aktualisieren
                updateScoringData(data);
                
                // Empfehlungen generieren
                generateRecommendations(data);
                
                console.log('üìä Vollst√§ndige Dashboard-Integration abgeschlossen');
                
            } catch (e) {
                console.error('Fehler beim Dashboard-Update:', e);
            }
        }
        
        function generateChartData(data) {
            // 6-Monats-Verlauf simulieren
            const months = ['Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober'];
            const revenueData = [];
            const profitData = [];
            
            for (let i = 0; i < 6; i++) {
                const factor = 0.7 + Math.random() * 0.6; // 70%-130% Variation
                const monthRevenue = Math.round(data.revenue * factor);
                const monthProfit = Math.round(data.profit * factor);
                
                revenueData.push(monthRevenue);
                profitData.push(monthProfit);
            }
            
            // Aktueller Monat = echte Daten
            revenueData[5] = data.revenue;
            profitData[5] = data.profit;
            
            return {
                months: months,
                revenue: revenueData,
                profit: profitData,
                costs: revenueData.map((rev, i) => rev - profitData[i])
            };
        }
        
        function generateRecommendations(data) {
            const recommendations = [];
            
            // Basierend auf BWA-Performance
            if (data.margin < 5) {
                recommendations.push({
                    title: "Kostensenkung kritisch",
                    description: `Bei nur ${data.margin}% Marge sind sofortige Kostensenkungen erforderlich. Pr√ºfen Sie Ihre gr√∂√üten Ausgabenposten.`,
                    priority: "hoch",
                    category: "Kostenoptimierung",
                    impact: `Potential: ${Math.round(data.costs * 0.15).toLocaleString()}‚Ç¨ Ersparnis`
                });
            }
            
            if (data.margin > 20) {
                recommendations.push({
                    title: "Wachstumsinvestition m√∂glich",
                    description: `Ihre gesunde ${data.margin}% Marge erm√∂glicht Investitionen in Marketing oder Expansion.`,
                    priority: "mittel", 
                    category: "Wachstum",
                    impact: "Langfristige Umsatzsteigerung"
                });
            }
            
            recommendations.push({
                title: "Preisoptimierung pr√ºfen",
                description: "Analysieren Sie Ihre Preisstruktur. Auch 5% Erh√∂hung kann Gewinn deutlich steigern.",
                priority: data.margin < 10 ? "hoch" : "niedrig",
                category: "Umsatzsteigerung",
                impact: `Potential: ${Math.round(data.revenue * 0.05).toLocaleString()}‚Ç¨ Mehrumsatz`
            });
            
            localStorage.setItem('bwa-recommendations-current', JSON.stringify({
                recommendations: recommendations,
                basedOnFile: data.filename,
                generatedAt: new Date().toISOString()
            }));
        }
        
        console.log('‚úÖ BWA Upload Final Script vollst√§ndig geladen');
    </script>
</body>
</html>