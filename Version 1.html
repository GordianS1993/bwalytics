<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BWA Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Professionelles Design System */
        :root {
            /* Haupt-Farbpalette */
            --color-primary: #1e40af;        /* Professionelles Dunkelblau */
            --color-primary-light: #3b82f6;   /* Helleres Blau */
            --color-primary-dark: #1e3a8a;    /* Dunkleres Blau */
            
            /* Sekundärfarben */
            --color-secondary: #64748b;       /* Gedämpftes Grau-Blau */
            --color-accent: #0ea5e9;          /* Akzent-Cyan */
            
            /* Neutrale Farben */
            --color-gray-50: #f8fafc;
            --color-gray-100: #f1f5f9;
            --color-gray-200: #e2e8f0;
            --color-gray-300: #cbd5e1;
            --color-gray-400: #94a3b8;
            --color-gray-500: #64748b;
            --color-gray-600: #475569;
            --color-gray-700: #334155;
            --color-gray-800: #1e293b;
            --color-gray-900: #0f172a;
            
            /* Status-Farben */
            --color-success: #059669;
            --color-warning: #d97706;
            --color-error: #dc2626;
            --color-info: #0284c7;
            
            /* Typografie */
            --font-family-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            --font-family-display: 'Inter', sans-serif;
            
            /* Schatten */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            
            /* Border Radius */
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family-sans);
            background: var(--color-gray-50);
            display: flex;
            min-height: 100vh;
            color: var(--color-gray-900);
            font-size: 15px;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Sidebar - Professionell */
        .sidebar {
            width: 280px;
            background: var(--color-gray-900);
            color: white;
            position: fixed;
            height: 100vh;
            left: 0;
            top: 0;
            overflow-y: auto;
            z-index: 1000;
            border-right: 1px solid var(--color-gray-800);
        }

        .sidebar-header {
            padding: 32px 24px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: white;
            letter-spacing: -0.5px;
        }

        .sidebar-header p {
            font-size: 13px;
            color: var(--color-gray-400);
            margin-top: 4px;
        }

        .user-profile {
            display: flex;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.03);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: var(--color-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            margin-right: 12px;
            color: white;
        }

        .user-info h4 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 2px;
            color: white;
        }

        .user-info p {
            font-size: 12px;
            color: var(--color-gray-400);
        }

        .nav-menu {
            list-style: none;
            padding: 16px 12px;
        }

        .nav-item {
            margin-bottom: 4px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: var(--color-gray-300);
            text-decoration: none;
            transition: all 0.2s ease;
            cursor: pointer;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 500;
        }

        .nav-link:hover {
            background: rgba(255,255,255,0.08);
            color: white;
        }

        .nav-link.active {
            background: var(--color-primary);
            color: white;
        }

        .nav-link i {
            margin-right: 12px;
            width: 20px;
            text-align: center;
            font-size: 16px;
        }

        /* Main Content */
        .main-content {
            margin-left: 280px;
            flex: 1;
            padding: 32px;
            background: var(--color-gray-50);
            min-height: 100vh;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-bottom: 1px solid var(--color-gray-200);
            padding: 32px 40px;
            margin-bottom: 32px;
            border-radius: var(--radius-xl);
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 8px;
            font-weight: 700;
            color: var(--color-gray-900);
            letter-spacing: -1px;
        }

        .header p {
            color: var(--color-gray-600);
            font-size: 15px;
        }

        .content {
            padding: 0;
        }

        .upload-section {
            margin-bottom: 32px;
        }

        .upload-zone {
            border: 2px dashed var(--color-gray-300);
            border-radius: var(--radius-xl);
            padding: 60px 40px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .upload-zone:hover {
            background: var(--color-gray-50);
            border-color: var(--color-primary);
        }

        .upload-zone.dragover {
            background: #eff6ff;
            border-color: var(--color-primary);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 20px;
            color: var(--color-gray-400);
        }

        .upload-text h2 {
            color: var(--color-gray-900);
            margin-bottom: 12px;
            font-size: 24px;
            font-weight: 600;
        }

        .upload-text p {
            color: var(--color-gray-600);
            font-size: 15px;
            margin-bottom: 24px;
        }

        .upload-info {
            display: flex;
            justify-content: center;
            gap: 32px;
            margin-top: 24px;
        }

        .upload-info div {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--color-gray-500);
            font-size: 14px;
        }

        .progress-container {
            display: none;
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: var(--radius-xl);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--color-gray-200);
            border-radius: 999px;
            overflow: hidden;
            margin: 24px 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--color-primary);
            width: 0%;
            transition: width 0.3s ease;
        }

        .success-container {
            display: none;
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: var(--radius-xl);
        }

        .dashboard {
            display: none;
            margin-top: 32px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .metric-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 24px;
            text-align: center;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--color-gray-200);
            transition: all 0.2s ease;
        }

        .metric-card:hover {
            box-shadow: var(--shadow-md);
        }

        .metric-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .metric-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .metric-label {
            color: var(--color-gray-600);
            font-size: 14px;
            font-weight: 500;
        }

        .chart-container {
            background: white;
            border-radius: var(--radius-xl);
            padding: 32px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 24px;
            border: 1px solid var(--color-gray-200);
        }

        .chart-container h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin-bottom: 20px;
        }

        .history-section {
            margin-top: 32px;
        }

        .history-section h2 {
            font-size: 20px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin-bottom: 16px;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--color-gray-200);
        }

        .history-table th,
        .history-table td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid var(--color-gray-200);
            font-size: 14px;
        }

        .history-table th {
            background: var(--color-gray-50);
            font-weight: 600;
            color: var(--color-gray-700);
        }

        .history-table tbody tr:last-child td {
            border-bottom: none;
        }

        .history-table tbody tr:hover {
            background: var(--color-gray-50);
        }

        .btn {
            padding: 10px 20px;
            border-radius: var(--radius-md);
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin: 0 4px;
            transition: all 0.2s ease;
            font-family: var(--font-family-sans);
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-primary-dark);
        }

        .btn-danger {
            background: var(--color-error);
            color: white;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .notification {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 16px 24px;
            border-radius: var(--radius-lg);
            color: white;
            font-weight: 500;
            font-size: 14px;
            box-shadow: var(--shadow-xl);
            z-index: 9999;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.success {
            background: var(--color-success);
        }

        .notification.error {
            background: var(--color-error);
        }

        .notification.warning {
            background: var(--color-warning);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .modal-dialog {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <svg width="40" height="40" viewBox="0 0 40 40" fill="none" style="margin-bottom: 12px;">
                <rect width="40" height="40" rx="8" fill="var(--color-primary)"/>
                <path d="M12 20L18 26L28 14" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <h2>BWA Dashboard</h2>
            <p>Business Intelligence</p>
        </div>
        
        <div class="user-profile">
            <div class="user-avatar">GS</div>
            <div class="user-info">
                <h4>Gordian Schmitz</h4>
                <p>Unternehmer</p>
            </div>
        </div>
        
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="showSection('dashboard', event); return false;">
                    <i>◆</i>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link active" onclick="showSection('upload', event); return false;">
                    <i>↑</i>
                    <span>BWA Upload</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="showSection('scoring', event); return false;">
                    <i>◇</i>
                    <span>Scoring</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="showSection('recommendations', event); return false;">
                    <i>★</i>
                    <span>Empfehlungen</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="showSection('analytics', event); return false;">
                    <i>▲</i>
                    <span>Analytics</span>
                </a>
            </li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Upload Section -->
        <div id="upload-section" class="section active">
            <div class="container">
                <div class="header">
                    <h1>BWA Upload</h1>
                    <p>Betriebswirtschaftliche Auswertung - Upload & Analyse</p>
                </div>

                <div class="content">
                    <!-- Upload Section -->
                    <div class="upload-section" id="uploadSection">
                        <div class="upload-zone" id="uploadZone">
                            <div class="upload-icon">
                                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="17 8 12 3 7 8"/>
                                    <line x1="12" y1="3" x2="12" y2="15"/>
                                </svg>
                            </div>
                            <div class="upload-text">
                                <h2>BWA-Datei hochladen</h2>
                                <p>Klicken Sie hier oder ziehen Sie eine PDF-Datei hierher</p>
                                <div class="upload-info">
                                    <div><span>•</span> Max. 50MB</div>
                                    <div><span>•</span> PDF Format</div>
                                    <div><span>•</span> Sicher verschlüsselt</div>
                                </div>
                            </div>
                            <input type="file" id="fileInput" accept=".pdf" style="display: none;">
                        </div>
                    </div>

                    <!-- Progress Section -->
                    <div class="progress-container" id="progressContainer">
                        <h2>📤 Upload läuft...</h2>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <p id="progressText">0% - Datei wird verarbeitet...</p>
                    </div>

                    <!-- Success Section -->
                    <div class="success-container" id="successContainer">
                        <div style="font-size: 4rem; margin-bottom: 20px;">✅</div>
                        <h2>BWA-Analyse abgeschlossen!</h2>
                        <div id="successDetails"></div>
                        <button onclick="resetToUpload()" style="margin-top: 20px; padding: 12px 24px; background: #2196F3; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            Weitere BWA hochladen
                        </button>
                    </div>

                    <!-- Dashboard -->
                    <div class="dashboard" id="dashboard">
                        <h2>BWA-Auswertung</h2>
                        <div class="dashboard-grid" id="metricsGrid">
                            <!-- Wird dynamisch gefüllt -->
                        </div>
                        <div class="chart-container">
                            <canvas id="bwaChart" width="400" height="200"></canvas>
                        </div>
                    </div>

                    <!-- History Section -->
                    <div class="history-section">
                        <h2>Upload-Historie</h2>
                        <table class="history-table">
                            <thead>
                                <tr>
                                    <th>Datei</th>
                                    <th>Datum</th>
                                    <th>Umsatz</th>
                                    <th>Kosten</th>
                                    <th>Gewinn</th>
                                    <th>Analyse</th>
                                    <th>Aktionen</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <!-- Wird dynamisch gefüllt -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Dashboard Section -->
        <div id="dashboard-section" class="section">
            <div class="container">
                <div class="header">
                    <h1>Dashboard</h1>
                    <p>Übersicht Ihrer Geschäftskennzahlen</p>
                </div>
                <div class="content">
                    <p style="text-align: center; color: #666; font-size: 1.1rem; margin-top: 40px;">
                        Dashboard wird nach BWA-Upload angezeigt<br>
                        <small>Laden Sie eine BWA hoch, um detaillierte Kennzahlen zu sehen</small>
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Scoring Section -->
        <div id="scoring-section" class="section">
            <div class="container">
                <div class="header">
                    <h1>Scoring</h1>
                    <p>Unternehmens-Bewertung</p>
                </div>
                <div class="content">
                    <p style="text-align: center; color: #666; font-size: 1.1rem; margin-top: 40px;">
                        Scoring-Funktionen werden nach BWA-Upload verfügbar<br>
                        <small>Automatische Bewertung Ihrer Unternehmenskennzahlen</small>
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Recommendations Section -->
        <div id="recommendations-section" class="section">
            <div class="container">
                <div class="header">
                    <h1>Empfehlungen</h1>
                    <p>KI-basierte Geschäftsempfehlungen</p>
                </div>
                <div class="content">
                    <p style="text-align: center; color: #666; font-size: 1.1rem; margin-top: 40px;">
                        Empfehlungen werden nach BWA-Analyse generiert<br>
                        <small>Intelligente Tipps zur Optimierung Ihres Unternehmens</small>
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Analytics Section -->
        <div id="analytics-section" class="section">
            <div class="container">
                <div class="header">
                    <h1>Analytics</h1>
                    <p>Detaillierte Unternehmensanalyse</p>
                </div>
                <div class="content">
                    <p style="text-align: center; color: #666; font-size: 1.1rem; margin-top: 40px;">
                        Analytics werden nach BWA-Upload verfügbar<br>
                        <small>Tiefgehende Analyse Ihrer Geschäftsdaten</small>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // PDF.js Worker Setup
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Globale Variablen
        let uploadZone, fileInput, progressContainer, progressFill, progressText;
        let successContainer, successDetails, dashboard, metricsGrid, historyTableBody;
        let uploadHistory = [];
        let isUploading = false;
        let lastUploadedFile = null;

        // Navigation Functions
        function showSection(sectionName, event) {
            console.log('🔄 showSection aufgerufen:', sectionName);
            
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Show selected section
            const targetSection = document.getElementById(sectionName + '-section');
            if (targetSection) {
                targetSection.classList.add('active');
                console.log('✅ Section aktiviert:', sectionName);
            } else {
                console.error('❌ Section nicht gefunden:', sectionName + '-section');
            }
            
            // Add active class to clicked nav link
            if (event && event.target) {
                const navLink = event.target.closest('.nav-link');
                if (navLink) {
                    navLink.classList.add('active');
                }
            }
        }

        // DOM Ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('✅ BWA Dashboard geladen');

            // Elemente finden
            uploadZone = document.getElementById('uploadZone');
            fileInput = document.getElementById('fileInput');
            progressContainer = document.getElementById('progressContainer');
            progressFill = document.getElementById('progressFill');
            progressText = document.getElementById('progressText');
            successContainer = document.getElementById('successContainer');
            successDetails = document.getElementById('successDetails');
            dashboard = document.getElementById('dashboard');
            metricsGrid = document.getElementById('metricsGrid');
            historyTableBody = document.getElementById('historyTableBody');

            if (!uploadZone || !fileInput) {
                console.error('❌ Kritische Elemente fehlen!');
                return;
            }

            // Event Listeners
            setupEventListeners();
            loadHistory();
            displayHistory();

            console.log('✅ System initialisiert');
        });

        function setupEventListeners() {
            // Upload Zone Click
            uploadZone.addEventListener('click', function() {
                console.log('🖱️ Upload Zone geklickt');
                fileInput.click();
            });

            // File Input Change
            fileInput.addEventListener('change', function(event) {
                console.log('📁 File Input Change Event');
                const file = event.target.files[0];
                if (file) {
                    console.log('✅ Datei ausgewählt:', file.name);
                    handleFileUpload(file);
                } else {
                    console.log('❌ Keine Datei ausgewählt');
                }
            });

            // Drag & Drop
            uploadZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });

            uploadZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
            });

            uploadZone.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    console.log('📁 Datei per Drag & Drop erhalten');
                    handleFileUpload(files[0]);
                }
            });
        }

        // Branchen-Benchmark-Daten
        const industryBenchmarks = {
            retail: {
                name: 'Einzelhandel',
                margin: 5.5,
                personalCost: 35,
                fixedCost: 45,
                description: 'Geringe Margen durch hohen Wettbewerb'
            },
            gastro: {
                name: 'Gastronomie',
                margin: 8.0,
                personalCost: 40,
                fixedCost: 50,
                description: 'Personalintensiv mit hohen Fixkosten'
            },
            it: {
                name: 'IT & Software',
                margin: 25.0,
                personalCost: 60,
                fixedCost: 30,
                description: 'Hohe Margen, personalintensiv'
            },
            consulting: {
                name: 'Beratung',
                margin: 22.0,
                personalCost: 65,
                fixedCost: 25,
                description: 'Sehr personalintensiv, niedrige Fixkosten'
            },
            craft: {
                name: 'Handwerk',
                margin: 12.0,
                personalCost: 45,
                fixedCost: 40,
                description: 'Materialkosten bedeutend'
            },
            ecommerce: {
                name: 'E-Commerce',
                margin: 15.0,
                personalCost: 25,
                fixedCost: 35,
                description: 'Skalierbar mit moderaten Margen'
            },
            healthcare: {
                name: 'Gesundheitswesen',
                margin: 18.0,
                personalCost: 55,
                fixedCost: 35,
                description: 'Reguliert mit stabilen Margen'
            }
        };

        let currentBenchmarkData = null;

        function updateBenchmark() {
            if (!window.currentBWAData) return;
            
            const industry = document.getElementById('industrySelect').value;
            const benchmark = industryBenchmarks[industry];
            currentBenchmarkData = benchmark;
            
            // Benchmark-Werte anzeigen
            document.getElementById('benchmarkMargin').textContent = benchmark.margin + '%';
            document.getElementById('benchmarkPersonal').textContent = benchmark.personalCost + '%';
            document.getElementById('benchmarkFixed').textContent = benchmark.fixedCost + '%';
            
            // Vergleich und Status
            const userMargin = window.currentBWAData.margin;
            const userPersonal = window.currentBWAData.personalCostRatio || 0;
            const userFixed = ((window.currentBWAData.fixedCosts || 0) / window.currentBWAData.revenue) * 100;
            
            // Gewinnmarge Status
            const marginElement = document.getElementById('marginStatus');
            if (userMargin > benchmark.margin * 1.2) {
                marginElement.textContent = '🟢 Überdurchschnittlich';
                marginElement.style.background = '#dcfce7';
                marginElement.style.color = '#166534';
            } else if (userMargin > benchmark.margin * 0.8) {
                marginElement.textContent = '🟡 Im Durchschnitt';
                marginElement.style.background = '#fef3c7';
                marginElement.style.color = '#92400e';
            } else {
                marginElement.textContent = '🔴 Unter Durchschnitt';
                marginElement.style.background = '#fee2e2';
                marginElement.style.color = '#991b1b';
            }
            
            // Personalkosten Status
            const personalElement = document.getElementById('personalStatus');
            if (userPersonal < benchmark.personalCost * 0.9) {
                personalElement.textContent = '🟢 Effizient';
                personalElement.style.background = '#dcfce7';
                personalElement.style.color = '#166534';
            } else if (userPersonal < benchmark.personalCost * 1.1) {
                personalElement.textContent = '🟡 Normal';
                personalElement.style.background = '#fef3c7';
                personalElement.style.color = '#92400e';
            } else {
                personalElement.textContent = '🔴 Optimierung nötig';
                personalElement.style.background = '#fee2e2';
                personalElement.style.color = '#991b1b';
            }
            
            // Fixkosten Status
            const fixedElement = document.getElementById('fixedStatus');
            if (userFixed < benchmark.fixedCost * 0.9) {
                fixedElement.textContent = '🟢 Niedrig';
                fixedElement.style.background = '#dcfce7';
                fixedElement.style.color = '#166534';
            } else if (userFixed < benchmark.fixedCost * 1.1) {
                fixedElement.textContent = '🟡 Normal';
                fixedElement.style.background = '#fef3c7';
                fixedElement.style.color = '#92400e';
            } else {
                fixedElement.textContent = '🔴 Zu hoch';
                fixedElement.style.background = '#fee2e2';
                fixedElement.style.color = '#991b1b';
            }
        }

        // Szenario-Funktionen
        let scenarioBaseData = null;

        function initializeScenario(bwaData) {
            scenarioBaseData = {
                revenue: bwaData.revenue,
                costs: bwaData.costs,
                profit: bwaData.profit
            };
        }

        function updateScenario() {
            if (!scenarioBaseData) return;
            
            const revenueChange = parseInt(document.getElementById('revenueSlider').value);
            const costChange = parseInt(document.getElementById('costSlider').value);
            
            // Neue Werte berechnen
            const newRevenue = Math.round(scenarioBaseData.revenue * (1 + revenueChange / 100));
            const newCosts = Math.round(scenarioBaseData.costs * (1 + costChange / 100));
            const newProfit = newRevenue - newCosts;
            const profitChange = ((newProfit - scenarioBaseData.profit) / scenarioBaseData.profit * 100).toFixed(1);
            
            // Anzeige aktualisieren
            document.getElementById('revenueChangeDisplay').textContent = (revenueChange > 0 ? '+' : '') + revenueChange + '%';
            document.getElementById('costChangeDisplay').textContent = (costChange > 0 ? '+' : '') + costChange + '%';
            
            document.getElementById('scenarioRevenue').textContent = newRevenue.toLocaleString() + '€';
            document.getElementById('scenarioCosts').textContent = newCosts.toLocaleString() + '€';
            document.getElementById('scenarioProfit').textContent = newProfit.toLocaleString() + '€';
            
            const changeElement = document.getElementById('scenarioProfitChange');
            const changeText = (profitChange > 0 ? '+' : '') + profitChange + '% zum Original';
            changeElement.textContent = changeText;
            changeElement.style.color = profitChange > 0 ? '#4ade80' : profitChange < 0 ? '#f87171' : 'white';
        }

        function resetScenario() {
            document.getElementById('revenueSlider').value = 0;
            document.getElementById('costSlider').value = 0;
            updateScenario();
        }

        // Demo-Daten laden für Tests
        function loadDemoData() {
            console.log('🎯 Demo-Daten werden geladen...');
            
            const demoFile = {
                name: 'Demo_BWA_Oktober_2025.pdf',
                size: 245000,
                type: 'application/pdf'
            };
            
            // Demo BWA-Daten generieren
            const demoBWAData = generateBWAData(demoFile.name);
            
            console.log('📊 Demo BWA-Daten generiert:', demoBWAData);
            
            // Upload-Prozess simulieren
            document.getElementById('uploadSection').style.display = 'none';
            progressContainer.style.display = 'block';
            
            let progress = 0;
            const interval = setInterval(() => {
                progress += 15;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                    progressFill.style.width = '100%';
                    progressText.textContent = '100% - Analyse abgeschlossen';
                    setTimeout(() => finishUpload(demoFile, demoBWAData), 500);
                } else {
                    progressFill.style.width = progress + '%';
                    progressText.textContent = progress + '% - Demo-Daten werden analysiert...';
                }
            }, 150);
        }

        function handleFileUpload(file) {
            console.log('🚀 handleFileUpload:', file.name);

            if (isUploading) {
                showNotification('⚠️ Upload bereits in Bearbeitung...', 'warning');
                return;
            }

            // Validierung
            if (file.type !== 'application/pdf') {
                showNotification('❌ Nur PDF-Dateien sind erlaubt!', 'error');
                return;
            }

            if (file.size > 50 * 1024 * 1024) {
                showNotification('❌ Datei zu groß! Max 50MB.', 'error');
                return;
            }

            startUpload(file);
        }

        function startUpload(file) {
            console.log('🚀 startUpload:', file.name);
            isUploading = true;
            lastUploadedFile = file;

            // UI umschalten
            document.getElementById('uploadSection').style.display = 'none';
            progressContainer.style.display = 'block';
            successContainer.style.display = 'none';

            simulateUpload(file);
        }

        function simulateUpload(file) {
            console.log('🎬 simulateUpload');

            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 10 + 5;

                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                    setTimeout(() => completeUpload(file), 1000);
                }

                progressFill.style.width = progress + '%';
                progressText.textContent = Math.round(progress) + '% - Verarbeitung läuft...';
            }, 200);
        }

        function completeUpload(file) {
            console.log('✅ completeUpload - Starte echte PDF-Analyse');
            progressText.textContent = '100% - Analysiere BWA...';

            // Echte PDF-Analyse starten
            analyzeBWA(file);
        }

        async function analyzeBWA(file) {
            console.log('📊 analyzeBWA - Echte PDF-Analyse gestartet');

            try {
                // PDF.js verwenden für echte Analyse
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                
                console.log('📄 PDF geladen, Seiten:', pdf.numPages);
                
                let fullText = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + ' ';
                }
                
                console.log('📝 PDF-Text extrahiert (erste 500 Zeichen):', fullText.substring(0, 500));
                console.log('📝 Kompletter PDF-Text:', fullText);
                
                // Echte BWA-Daten extrahieren
                const bwaData = extractBWADataFromText(fullText, file.name);
                console.log('💾 Finale BWA-Daten:', bwaData);
                finishUpload(file, bwaData);
                
            } catch (error) {
                console.error('❌ PDF-Analyse Fehler:', error);
                showNotification('⚠️ PDF konnte nicht analysiert werden. Verwende Demo-Daten.', 'warning');
                
                // Fallback auf fiktive Daten
                const bwaData = generateBWAData(file.name);
                finishUpload(file, bwaData);
            }
        }

        function extractBWADataFromText(text, filename) {
            console.log('🔍 Extrahiere BWA-Daten aus Text...');
            console.log('📄 Text-Länge:', text.length, 'Zeichen');
            
            // Text normalisieren
            const normalizedText = text.replace(/\s+/g, ' ').toLowerCase();
            console.log('📝 Normalisierter Text (erste 300 Zeichen):', normalizedText.substring(0, 300));
            
            // BWA-spezifische Schlüsselwörter suchen
            const isValidBWA = /umsatz|erträge|aufwand|kosten|gewinn|verlust|betriebsergebnis|jahresüberschuss/.test(normalizedText);
            console.log('✅ BWA-Struktur erkannt:', isValidBWA);
            
            if (!isValidBWA) {
                console.log('⚠️ Keine BWA-Struktur erkannt, verwende Fallback');
                return generateBWAData(filename);
            }
            
            // Zahlen extrahieren (deutsche und internationale Formate)
            const numbers = extractNumbersFromText(text);
            console.log('🔢 Gefundene Zahlen:', numbers.slice(0, 20)); // Erste 20 Zahlen
            console.log('🔢 Anzahl gefundener Zahlen:', numbers.length);
            
            if (numbers.length < 3) {
                console.log('⚠️ Zu wenige Zahlen gefunden, verwende Fallback');
                return generateBWAData(filename);
            }
            
            // Intelligente Zuordnung der Zahlen zu BWA-Kategorien
            let revenue = 0;
            let costs = 0;
            
            // Umsatz-Muster suchen
            const revenuePatterns = [
                /umsatz[^0-9]*?([0-9.,\s]+)/i,
                /erträge[^0-9]*?([0-9.,\s]+)/i,
                /erlöse[^0-9]*?([0-9.,\s]+)/i,
                /gesamtleistung[^0-9]*?([0-9.,\s]+)/i,
                /gesamtumsatz[^0-9]*?([0-9.,\s]+)/i
            ];
            
            // Kosten-Muster suchen
            const costPatterns = [
                /gesamtkosten[^0-9]*?([0-9.,\s]+)/i,
                /aufwand[^0-9]*?([0-9.,\s]+)/i,
                /kosten[^0-9]*?([0-9.,\s]+)/i,
                /ausgaben[^0-9]*?([0-9.,\s]+)/i,
                /gesamtaufwand[^0-9]*?([0-9.,\s]+)/i
            ];
            
            // Umsatz extrahieren
            for (const pattern of revenuePatterns) {
                const match = text.match(pattern);
                if (match) {
                    console.log('💰 Umsatz-Match gefunden:', match[0], '-> Zahl:', match[1]);
                    const value = parseGermanNumber(match[1]);
                    console.log('💰 Geparster Umsatz:', value);
                    if (value > 1000) {
                        revenue = value;
                        console.log('✅ Umsatz gesetzt:', revenue);
                        break;
                    }
                }
            }
            
            // Kosten extrahieren
            for (const pattern of costPatterns) {
                const match = text.match(pattern);
                if (match) {
                    console.log('📊 Kosten-Match gefunden:', match[0], '-> Zahl:', match[1]);
                    const value = parseGermanNumber(match[1]);
                    console.log('📊 Geparste Kosten:', value);
                    if (value > 500) {
                        costs = value;
                        console.log('✅ Kosten gesetzt:', costs);
                        break;
                    }
                }
            }
            
            // Fallback: Größte Zahlen als Umsatz und zweitgrößte als Kosten
            if (revenue === 0 || costs === 0) {
                console.log('⚠️ Verwende Fallback: Größte Zahlen');
                const sortedNumbers = numbers.sort((a, b) => b - a);
                console.log('📊 Top 10 Zahlen:', sortedNumbers.slice(0, 10));
                if (revenue === 0 && sortedNumbers[0] > 5000) {
                    revenue = sortedNumbers[0];
                    console.log('💰 Umsatz (Fallback):', revenue);
                }
                if (costs === 0 && sortedNumbers[1] > 1000) {
                    costs = sortedNumbers[1];
                    console.log('📊 Kosten (Fallback):', costs);
                }
            }
            
            // Finale Validierung
            console.log('🔍 Validierung: Umsatz=', revenue, 'Kosten=', costs);
            if (revenue === 0 || costs === 0) {
                console.log('❌ Umsatz oder Kosten = 0, verwende Fallback');
                return generateBWAData(filename);
            }
            
            if (revenue < costs * 0.5) {
                console.log('❌ Unplausibel: Umsatz < Kosten * 0.5, verwende Fallback');
                return generateBWAData(filename);
            }
            
            const profit = revenue - costs;
            const margin = ((profit / revenue) * 100).toFixed(1);
            
            console.log('✅ BWA-Daten erfolgreich extrahiert:', { revenue, costs, profit, margin, source: 'extracted' });
            
            // Detaillierte Kostenaufschlüsselung (Schätzung basierend auf Gesamtkosten)
            const personalCosts = Math.round(costs * 0.45);
            const materialCosts = Math.round(costs * 0.25);
            const rentCosts = Math.round(costs * 0.10);
            const marketingCosts = Math.round(costs * 0.08);
            const otherCosts = costs - (personalCosts + materialCosts + rentCosts + marketingCosts);

            // Fixkosten vs. Variable Kosten
            const fixedCosts = personalCosts + rentCosts + Math.round(otherCosts * 0.6);
            const variableCosts = materialCosts + marketingCosts + Math.round(otherCosts * 0.4);
            
            return {
                revenue: Math.round(revenue),
                costs: Math.round(costs),
                profit: Math.round(profit),
                margin: parseFloat(margin),
                source: 'extracted',
                
                // Kostenaufschlüsselung
                costBreakdown: {
                    personal: personalCosts,
                    material: materialCosts,
                    rent: rentCosts,
                    marketing: marketingCosts,
                    other: otherCosts
                },
                
                // Fixkosten vs. Variable
                fixedCosts: fixedCosts,
                variableCosts: variableCosts,
                
                // KPIs
                breakEvenPoint: Math.round(fixedCosts / (parseFloat(margin) / 100)),
                liquidityMonths: Math.round((profit * 3) / costs * 10) / 10,
                personalCostRatio: Math.round((personalCosts / revenue) * 100),
                materialCostRatio: Math.round((materialCosts / revenue) * 100)
            };
        }

        function extractNumbersFromText(text) {
            // Verschiedene Zahlenformate erkennen
            const patterns = [
                /\b(\d{1,3}(?:\.\d{3})*,\d{2})\b/g,  // Deutsche Format: 123.456,78
                /\b(\d{1,3}(?:,\d{3})*\.\d{2})\b/g,  // US Format: 123,456.78
                /\b(\d+,\d{2})\b/g,                    // Einfach: 1234,56
                /\b(\d+\.\d{2})\b/g,                   // Einfach: 1234.56
                /\b(\d{4,})\b/g                        // Ganze Zahlen > 1000
            ];
            
            const numbers = [];
            
            for (const pattern of patterns) {
                let match;
                while ((match = pattern.exec(text)) !== null) {
                    const number = parseGermanNumber(match[1]);
                    if (number > 100) { // Nur relevante Beträge
                        numbers.push(number);
                    }
                }
            }
            
            // Duplikate entfernen und sortieren
            return [...new Set(numbers)].sort((a, b) => b - a);
        }

        function parseGermanNumber(str) {
            console.log('🔢 Parse Zahl:', str);
            
            // Whitespace entfernen
            str = str.trim().replace(/\s+/g, '');
            
            // Deutsche und internationale Zahlenformate parsen
            const result = parseFloat(
                str.replace(/\./g, '')  // Tausender-Punkte entfernen
                   .replace(',', '.')   // Komma durch Punkt ersetzen
            );
            
            console.log('🔢 Ergebnis:', result);
            return result;
        }

        function generateBWAData(filename) {
            const hash = simpleHash(filename);
            const baseRevenue = 50000 + (hash % 200000);
            const costRatio = 0.6 + (hash % 100) / 1000;
            const costs = Math.round(baseRevenue * costRatio);
            const profit = baseRevenue - costs;
            const margin = ((profit / baseRevenue) * 100).toFixed(1);

            // Detaillierte Kostenaufschlüsselung
            const personalCosts = Math.round(costs * 0.45); // 45% Personalkosten
            const materialCosts = Math.round(costs * 0.25); // 25% Materialkosten
            const rentCosts = Math.round(costs * 0.10);     // 10% Miete
            const marketingCosts = Math.round(costs * 0.08); // 8% Marketing
            const otherCosts = costs - (personalCosts + materialCosts + rentCosts + marketingCosts);

            // Fixkosten vs. Variable Kosten
            const fixedCosts = personalCosts + rentCosts + Math.round(otherCosts * 0.6);
            const variableCosts = materialCosts + marketingCosts + Math.round(otherCosts * 0.4);

            return {
                revenue: baseRevenue,
                costs: costs,
                profit: profit,
                margin: parseFloat(margin),
                source: 'generated',
                
                // Kostenaufschlüsselung
                costBreakdown: {
                    personal: personalCosts,
                    material: materialCosts,
                    rent: rentCosts,
                    marketing: marketingCosts,
                    other: otherCosts
                },
                
                // Fixkosten vs. Variable
                fixedCosts: fixedCosts,
                variableCosts: variableCosts,
                
                // KPIs
                breakEvenPoint: Math.round(fixedCosts / (margin / 100)),
                liquidityMonths: Math.round((profit * 3) / costs * 10) / 10, // Annahme: 3x Gewinn als Reserve
                personalCostRatio: Math.round((personalCosts / baseRevenue) * 100),
                materialCostRatio: Math.round((materialCosts / baseRevenue) * 100)
            };
        }

        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash);
        }

        function finishUpload(file, bwaData) {
            console.log('✅ finishUpload mit Daten:', bwaData);
            console.log('📊 Detaillierte Datenprüfung:');
            console.log('   - Umsatz:', bwaData.revenue);
            console.log('   - Kosten:', bwaData.costs);
            console.log('   - Gewinn:', bwaData.profit);
            console.log('   - Marge:', bwaData.margin);
            console.log('   - Fixkosten:', bwaData.fixedCosts);
            console.log('   - Variable Kosten:', bwaData.variableCosts);
            console.log('   - Break-Even:', bwaData.breakEvenPoint);
            console.log('   - Liquidität (Monate):', bwaData.liquidityMonths);
            console.log('   - Kostenaufschlüsselung:', bwaData.costBreakdown);
            console.log('   - Personalkosten-Quote:', bwaData.personalCostRatio);
            console.log('   - Materialkosten-Quote:', bwaData.materialCostRatio);

            // Zu Historie hinzufügen
            const entry = {
                filename: file.name,
                timestamp: Date.now(),
                date: new Date().toLocaleDateString('de-DE'),
                ...bwaData
            };

            uploadHistory.unshift(entry);
            saveHistory();

            // Globale Variable für Dashboard-Daten setzen
            window.currentBWAData = bwaData;
            window.currentFileName = file.name;

            console.log('🌍 Globale Variable gesetzt:', window.currentBWAData);

            // UI umschalten
            progressContainer.style.display = 'none';
            successContainer.style.display = 'block';
            dashboard.style.display = 'block';

            // Success Details - Erweitert mit neuen KPIs
            successDetails.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p><strong>Datei:</strong> ${file.name}</p>
                    <p><strong>Umsatz:</strong> ${bwaData.revenue.toLocaleString()}€</p>
                    <p><strong>Kosten:</strong> ${bwaData.costs.toLocaleString()}€</p>
                    <p><strong>Gewinn:</strong> ${bwaData.profit.toLocaleString()}€</p>
                    <p><strong>Marge:</strong> ${bwaData.margin}%</p>
                    <hr style="margin: 15px 0; border: none; border-top: 1px solid #e0e0e0;">
                    <p><strong>Fixkosten:</strong> ${(bwaData.fixedCosts || 0).toLocaleString()}€</p>
                    <p><strong>Variable Kosten:</strong> ${(bwaData.variableCosts || 0).toLocaleString()}€</p>
                    <p><strong>Break-Even:</strong> ${(bwaData.breakEvenPoint || 0).toLocaleString()}€</p>
                    <p><strong>Liquidität:</strong> ${(bwaData.liquidityMonths || 0).toFixed(1)} Monate</p>
                </div>
            `;

            // Dashboard aktualisieren
            updateDashboard(bwaData);
            updateAllSections(bwaData, file.name);
            displayHistory();

            isUploading = false;
            showNotification('✅ BWA erfolgreich analysiert!', 'success');
        }

        function updateDashboard(data) {
            metricsGrid.innerHTML = `
                <div class="metric-card">
                    <div class="metric-value" style="color: var(--color-gray-900);">${data.revenue.toLocaleString()}€</div>
                    <div class="metric-label">Umsatz</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" style="color: var(--color-gray-900);">${data.costs.toLocaleString()}€</div>
                    <div class="metric-label">Kosten</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" style="color: var(--color-gray-900);">${data.profit.toLocaleString()}€</div>
                    <div class="metric-label">Gewinn</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" style="color: var(--color-gray-900);">${data.margin}%</div>
                    <div class="metric-label">Marge</div>
                </div>
            `;
        }

        function generateHistoricalData(currentData) {
            // Generiere 6 Monate historische Daten basierend auf aktuellen Werten
            const months = ['Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober'];
            const data = [];
            
            for (let i = 0; i < 6; i++) {
                const growthFactor = 0.85 + (i * 0.03); // Simuliertes Wachstum
                const variance = 0.95 + Math.random() * 0.1; // Zufällige Schwankung
                
                data.push({
                    month: months[i],
                    revenue: Math.round(currentData.revenue * growthFactor * variance),
                    costs: Math.round(currentData.costs * growthFactor * variance),
                    profit: 0 // Wird berechnet
                });
            }
            
            // Profit berechnen
            data.forEach(entry => {
                entry.profit = entry.revenue - entry.costs;
            });
            
            return data;
        }

        function createTrendChart(historicalData) {
            const canvas = document.getElementById('trendChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Alten Chart zerstören falls vorhanden
            if (window.trendChartInstance) {
                window.trendChartInstance.destroy();
            }
            
            window.trendChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: historicalData.map(d => d.month),
                    datasets: [
                        {
                            label: 'Umsatz',
                            data: historicalData.map(d => d.revenue),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Kosten',
                            data: historicalData.map(d => d.costs),
                            borderColor: '#60a5fa',
                            backgroundColor: 'rgba(96, 165, 250, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Gewinn',
                            data: historicalData.map(d => d.profit),
                            borderColor: '#1e40af',
                            backgroundColor: 'rgba(30, 64, 175, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: { size: 14, weight: 'bold' },
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + '€';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + '€';
                                }
                            }
                        }
                    }
                }
            });
            
            // Wachstumsraten berechnen und anzeigen
            const lastMonth = historicalData[historicalData.length - 1];
            const prevMonth = historicalData[historicalData.length - 2];
            
            const revenueGrowth = ((lastMonth.revenue - prevMonth.revenue) / prevMonth.revenue * 100).toFixed(1);
            const costGrowth = ((lastMonth.costs - prevMonth.costs) / prevMonth.costs * 100).toFixed(1);
            const profitGrowth = ((lastMonth.profit - prevMonth.profit) / prevMonth.profit * 100).toFixed(1);
            
            document.getElementById('revenueGrowth').textContent = (revenueGrowth > 0 ? '+' : '') + revenueGrowth + '%';
            document.getElementById('costGrowth').textContent = (costGrowth > 0 ? '+' : '') + costGrowth + '%';
            document.getElementById('profitGrowth').textContent = (profitGrowth > 0 ? '+' : '') + profitGrowth + '%';
        }

        function updateAllSections(bwaData, filename) {
            console.log('🔄 updateAllSections aufgerufen mit:', bwaData);
            console.log('📁 Dateiname:', filename);
            
            // Datenvalidierung
            if (!bwaData || !bwaData.revenue) {
                console.error('❌ Ungültige BWA-Daten:', bwaData);
                return;
            }
            
            // Historische Daten generieren für Trend-Chart
            const historicalData = generateHistoricalData(bwaData);
            console.log('📊 Historische Daten generiert:', historicalData);
            
            // Dashboard Section aktualisieren
            const dashboardSection = document.getElementById('dashboard-section');
            if (dashboardSection) {
                console.log('✅ Dashboard-Section gefunden, wird aktualisiert...');
                dashboardSection.innerHTML = `
                    <div class="container">
                        <div class="header">
                            <h1>Dashboard</h1>
                            <p>Übersicht Ihrer Geschäftskennzahlen - ${filename}</p>
                        </div>
                        <div class="content">
                            <!-- KPI Scorecard -->
                            <div style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); padding: 30px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 4px 6px -1px rgba(30, 64, 175, 0.1);">
                                <h3 style="color: white; margin-bottom: 20px; font-size: 18px; font-weight: 600;">KPI-Scorecard</h3>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                                    ${[
                                        { 
                                            label: 'Gewinnmarge', 
                                            value: bwaData.margin + '%',
                                            status: bwaData.margin >= 20 ? 'good' : bwaData.margin >= 10 ? 'warning' : 'critical',
                                            target: 'Ziel: >20%'
                                        },
                                        { 
                                            label: 'Liquidität', 
                                            value: (bwaData.liquidityMonths || 0).toFixed(1) + ' Mo.',
                                            status: (bwaData.liquidityMonths || 0) >= 3 ? 'good' : (bwaData.liquidityMonths || 0) >= 1.5 ? 'warning' : 'critical',
                                            target: 'Ziel: >3 Monate'
                                        },
                                        { 
                                            label: 'Personalkosten', 
                                            value: (bwaData.personalCostRatio || 0) + '%',
                                            status: (bwaData.personalCostRatio || 0) <= 45 ? 'good' : (bwaData.personalCostRatio || 0) <= 55 ? 'warning' : 'critical',
                                            target: 'Ziel: <45%'
                                        },
                                        { 
                                            label: 'Fixkostenquote', 
                                            value: (((bwaData.fixedCosts || 0) / bwaData.revenue) * 100).toFixed(0) + '%',
                                            status: (((bwaData.fixedCosts || 0) / bwaData.revenue) * 100) <= 40 ? 'good' : (((bwaData.fixedCosts || 0) / bwaData.revenue) * 100) <= 50 ? 'warning' : 'critical',
                                            target: 'Ziel: <40%'
                                        }
                                    ].map(kpi => `
                                        <div style="background: rgba(255, 255, 255, 0.95); padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                            <div style="font-size: 1.8rem; font-weight: 600; margin-bottom: 5px; color: #1e293b;">${kpi.value}</div>
                                            <div style="font-size: 0.9rem; color: #64748b; margin-bottom: 12px;">${kpi.label}</div>
                                            <div style="display: flex; align-items: center; justify-content: center; gap: 8px; padding-top: 8px; border-top: 1px solid #e2e8f0;">
                                                <span style="width: 8px; height: 8px; border-radius: 50%; background: ${kpi.status === 'good' ? '#10b981' : kpi.status === 'warning' ? '#fbbf24' : '#ef4444'};"></span>
                                                <span style="font-size: 0.75rem; color: #64748b;">${kpi.target}</span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        
                            <div class="dashboard-grid">
                                <div class="metric-card">
                                    <div class="metric-value" style="color: var(--color-gray-900);">${bwaData.revenue.toLocaleString()}€</div>
                                    <div class="metric-label">Umsatz</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value" style="color: var(--color-gray-900);">${bwaData.costs.toLocaleString()}€</div>
                                    <div class="metric-label">Kosten</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value" style="color: var(--color-gray-900);">${bwaData.profit.toLocaleString()}€</div>
                                    <div class="metric-label">Gewinn</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value" style="color: var(--color-gray-900);">${bwaData.margin}%</div>
                                    <div class="metric-label">Marge</div>
                                </div>
                            </div>
                            
                            <!-- Liquiditäts-Cockpit -->
                            <div style="margin-top: 30px; background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%); padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(14, 165, 233, 0.1);">
                                <h3 style="margin-bottom: 20px; color: white; font-size: 18px; font-weight: 600;">Liquiditäts-Cockpit</h3>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                                    <div style="text-align: center; padding: 20px; background: rgba(255, 255, 255, 0.95); border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                        <div style="font-size: 0.9rem; color: #64748b; margin-bottom: 8px;">Liquiditätsreserve</div>
                                        <div style="font-size: 2rem; font-weight: 600; margin: 10px 0; color: #0f172a;">${(bwaData.liquidityMonths || 0).toFixed(1)} Monate</div>
                                        <div style="font-size: 0.85rem; color: #64748b;">
                                            ${(bwaData.liquidityMonths || 0) >= 3 ? 'Sicher' : (bwaData.liquidityMonths || 0) >= 1.5 ? 'Kritisch' : 'Akut'}
                                        </div>
                                    </div>
                                    <div style="text-align: center; padding: 20px; background: rgba(255, 255, 255, 0.95); border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                        <div style="font-size: 0.9rem; color: #64748b; margin-bottom: 8px;">Break-Even-Point</div>
                                        <div style="font-size: 2rem; font-weight: 600; margin: 10px 0; color: #0f172a;">${(bwaData.breakEvenPoint || 0).toLocaleString()}€</div>
                                        <div style="font-size: 0.85rem; color: #64748b;">Gewinnschwelle</div>
                                    </div>
                                    <div style="text-align: center; padding: 20px; background: rgba(255, 255, 255, 0.95); border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                        <div style="font-size: 0.9rem; color: #64748b; margin-bottom: 8px;">Sicherheitsmarge</div>
                                        <div style="font-size: 2rem; font-weight: 600; margin: 10px 0; color: #0f172a;">${(((bwaData.revenue - (bwaData.breakEvenPoint || 0)) / bwaData.revenue) * 100).toFixed(0)}%</div>
                                        <div style="font-size: 0.85rem; color: #64748b;">Puffer über Break-Even</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Kostenaufschlüsselung -->
                            <div class="chart-container" style="margin-top: 30px;">
                                <h3 style="margin-bottom: 20px; color: var(--color-gray-900); font-size: 18px;">Kostenstruktur-Analyse</h3>
                                
                                <!-- Fixkosten vs. Variable Kosten -->
                                <div style="background: #f0f9ff; padding: 25px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #bae6fd;">
                                    <h4 style="margin-bottom: 15px; color: #0c4a6e; font-size: 16px;">Fixkosten vs. Variable Kosten</h4>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                        <div>
                                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                                <span style="font-weight: 500; color: #0369a1;">Fixkosten</span>
                                                <span style="font-weight: 600; color: #0c4a6e;">${(bwaData.fixedCosts || 0).toLocaleString()}€</span>
                                            </div>
                                            <div style="background: #e0f2fe; height: 8px; border-radius: 4px; overflow: hidden;">
                                                <div style="background: #0ea5e9; height: 100%; width: ${((bwaData.fixedCosts || 0) / bwaData.costs * 100).toFixed(0)}%;"></div>
                                            </div>
                                            <div style="font-size: 0.85rem; color: #0369a1; margin-top: 4px;">
                                                ${((bwaData.fixedCosts || 0) / bwaData.costs * 100).toFixed(0)}% der Gesamtkosten
                                            </div>
                                        </div>
                                        <div>
                                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                                <span style="font-weight: 500; color: #1e40af;">Variable Kosten</span>
                                                <span style="font-weight: 600; color: #0c4a6e;">${(bwaData.variableCosts || 0).toLocaleString()}€</span>
                                            </div>
                                            <div style="background: #dbeafe; height: 8px; border-radius: 4px; overflow: hidden;">
                                                <div style="background: #3b82f6; height: 100%; width: ${((bwaData.variableCosts || 0) / bwaData.costs * 100).toFixed(0)}%;"></div>
                                            </div>
                                            <div style="font-size: 0.85rem; color: #1e40af; margin-top: 4px;">
                                                ${((bwaData.variableCosts || 0) / bwaData.costs * 100).toFixed(0)}% der Gesamtkosten
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Top 5 Kostenkategorien -->
                                <div style="background: white; padding: 25px; border: 1px solid var(--color-gray-200); border-radius: 12px;">
                                    <h4 style="margin-bottom: 15px; color: var(--color-gray-900); font-size: 16px;">Top 5 Kostenkategorien</h4>
                                    ${bwaData.costBreakdown ? `
                                        <div style="space-y: 15px;">
                                            ${[
                                                { label: 'Personalkosten', value: bwaData.costBreakdown.personal },
                                                { label: 'Materialkosten', value: bwaData.costBreakdown.material },
                                                { label: 'Miete & Nebenkosten', value: bwaData.costBreakdown.rent },
                                                { label: 'Marketing & Vertrieb', value: bwaData.costBreakdown.marketing },
                                                { label: 'Sonstige Kosten', value: bwaData.costBreakdown.other }
                                            ].map(item => `
                                                <div style="margin-bottom: 15px;">
                                                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                                        <span style="font-weight: 500; color: #475569;">${item.label}</span>
                                                        <div>
                                                            <span style="font-weight: 600; color: #1e293b;">${item.value.toLocaleString()}€</span>
                                                            <span style="color: #64748b; font-size: 0.9rem; margin-left: 8px;">
                                                                (${((item.value / bwaData.costs) * 100).toFixed(1)}%)
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <div style="background: #dbeafe; height: 10px; border-radius: 5px; overflow: hidden;">
                                                        <div style="background: #3b82f6; height: 100%; width: ${((item.value / bwaData.costs) * 100).toFixed(1)}%; transition: width 0.3s ease;"></div>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : '<p style="color: var(--color-gray-500);">Keine detaillierte Kostenaufschlüsselung verfügbar</p>'}
                                </div>
                            </div>

                            <!-- 6-Monats-Trend -->
                            <div class="chart-container" style="margin-top: 30px;">
                                <div style="background: linear-gradient(to right, #eff6ff, #dbeafe); padding: 30px; border-radius: 12px; border: 1px solid #bfdbfe;">
                                    <h3 style="margin-bottom: 20px; color: #1e40af; font-size: 18px; font-weight: 600;">6-Monats-Trend</h3>
                                    <div style="background: white; padding: 25px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                                        <canvas id="trendChart" style="max-height: 400px;"></canvas>
                                    </div>
                                    
                                    <!-- Wachstumsraten -->
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px;">
                                        <div style="background: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                                            <div style="font-size: 0.9rem; color: #64748b;">Umsatzwachstum (MoM)</div>
                                            <div style="font-size: 1.8rem; font-weight: 600; margin: 8px 0; color: #1e40af;" id="revenueGrowth">+0%</div>
                                            <div style="font-size: 0.8rem; color: #64748b;">Monat-zu-Monat</div>
                                        </div>
                                        <div style="background: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                                            <div style="font-size: 0.9rem; color: #64748b;">Kostenwachstum (MoM)</div>
                                            <div style="font-size: 1.8rem; font-weight: 600; margin: 8px 0; color: #1e40af;" id="costGrowth">+0%</div>
                                            <div style="font-size: 0.8rem; color: #64748b;">Monat-zu-Monat</div>
                                        </div>
                                        <div style="background: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                                            <div style="font-size: 0.9rem; color: #64748b;">Gewinnwachstum (MoM)</div>
                                            <div style="font-size: 1.8rem; font-weight: 600; margin: 8px 0; color: #1e40af;" id="profitGrowth">+0%</div>
                                            <div style="font-size: 0.8rem; color: #64748b;">Monat-zu-Monat</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Was-wäre-wenn Szenarien -->
                            <div class="chart-container" style="margin-top: 30px;">
                                <div style="background: linear-gradient(135deg, #1e40af 0%, #3730a3 100%); padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(30, 64, 175, 0.1);">
                                    <h3 style="margin-bottom: 15px; color: white; font-size: 18px; font-weight: 600;">Was-wäre-wenn Szenarien</h3>
                                    <p style="margin-bottom: 25px; color: rgba(255,255,255,0.9); font-size: 1rem;">Simulieren Sie verschiedene Geschäftsszenarien und sehen Sie die Auswirkungen in Echtzeit</p>
                                    
                                    <!-- Umsatz-Szenario -->
                                    <div style="background: rgba(255, 255, 255, 0.15); padding: 20px; border-radius: 12px; margin-bottom: 20px; backdrop-filter: blur(10px);">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                            <span style="font-weight: 500; color: white;">Umsatzänderung</span>
                                            <span id="revenueChangeDisplay" style="font-size: 1.3rem; font-weight: 600; color: white;">0%</span>
                                        </div>
                                        <input type="range" id="revenueSlider" min="-30" max="50" value="0" step="5" 
                                               style="width: 100%; height: 8px; border-radius: 5px; background: rgba(255,255,255,0.3); outline: none; cursor: pointer;"
                                               oninput="updateScenario()">
                                        <div style="display: flex; justify-content: space-between; font-size: 0.85rem; margin-top: 5px; color: rgba(255,255,255,0.8);">
                                            <span>-30%</span>
                                            <span>+50%</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Kosten-Szenario -->
                                    <div style="background: rgba(255, 255, 255, 0.15); padding: 20px; border-radius: 12px; margin-bottom: 25px; backdrop-filter: blur(10px);">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                            <span style="font-weight: 500; color: white;">Kostenänderung</span>
                                            <span id="costChangeDisplay" style="font-size: 1.3rem; font-weight: 600; color: white;">0%</span>
                                        </div>
                                        <input type="range" id="costSlider" min="-30" max="30" value="0" step="5" 
                                               style="width: 100%; height: 8px; border-radius: 5px; background: rgba(255,255,255,0.3); outline: none; cursor: pointer;"
                                               oninput="updateScenario()">
                                        <div style="display: flex; justify-content: space-between; font-size: 0.85rem; margin-top: 5px; color: rgba(255,255,255,0.8);">
                                            <span>-30%</span>
                                            <span>+30%</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Ergebnis-Anzeige -->
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                                        <div style="text-align: center; padding: 15px; background: rgba(255, 255, 255, 0.2); border-radius: 10px; backdrop-filter: blur(10px);">
                                            <div style="font-size: 0.85rem; margin-bottom: 8px; color: rgba(255,255,255,0.9);">Neuer Umsatz</div>
                                            <div id="scenarioRevenue" style="font-size: 1.5rem; font-weight: 600; color: white;">${bwaData.revenue.toLocaleString()}€</div>
                                        </div>
                                        <div style="text-align: center; padding: 15px; background: rgba(255, 255, 255, 0.2); border-radius: 10px; backdrop-filter: blur(10px);">
                                            <div style="font-size: 0.85rem; margin-bottom: 8px; color: rgba(255,255,255,0.9);">Neue Kosten</div>
                                            <div id="scenarioCosts" style="font-size: 1.5rem; font-weight: 600; color: white;">${bwaData.costs.toLocaleString()}€</div>
                                        </div>
                                        <div style="text-align: center; padding: 15px; background: rgba(255, 255, 255, 0.2); border-radius: 10px; backdrop-filter: blur(10px);">
                                            <div style="font-size: 0.85rem; margin-bottom: 8px; color: rgba(255,255,255,0.9);">Neuer Gewinn</div>
                                            <div id="scenarioProfit" style="font-size: 1.5rem; font-weight: 600; color: white;">${bwaData.profit.toLocaleString()}€</div>
                                            <div id="scenarioProfitChange" style="font-size: 0.8rem; margin-top: 5px; color: rgba(255,255,255,0.8);">—</div>
                                        </div>
                                    </div>
                                    
                                    <div style="text-align: center; margin-top: 20px;">
                                        <button onclick="resetScenario()" style="padding: 10px 25px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; cursor: pointer; font-weight: 500; backdrop-filter: blur(10px); transition: all 0.2s;">
                                            Zurücksetzen
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Branchen-Benchmark -->
                            <div class="chart-container" style="margin-top: 30px;">
                                <h3 style="margin-bottom: 20px; color: var(--color-gray-900); font-size: 18px;">Branchen-Benchmark</h3>
                                <div style="background: white; padding: 30px; border: 1px solid var(--color-gray-200); border-radius: 12px;">
                                    <div style="margin-bottom: 25px;">
                                        <label style="display: block; font-weight: 500; margin-bottom: 10px; color: var(--color-gray-700);">Branche auswählen:</label>
                                        <select id="industrySelect" onchange="updateBenchmark()" style="width: 100%; padding: 12px; border: 1px solid var(--color-gray-300); border-radius: 8px; font-size: 1rem; cursor: pointer; background: white; color: var(--color-gray-900);">
                                            <option value="retail">Einzelhandel</option>
                                            <option value="gastro">Gastronomie</option>
                                            <option value="it">IT & Software</option>
                                            <option value="consulting">Beratung</option>
                                            <option value="craft">Handwerk</option>
                                            <option value="ecommerce">E-Commerce</option>
                                            <option value="healthcare">Gesundheitswesen</option>
                                        </select>
                                    </div>
                                    
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                                        <!-- Gewinnmarge Vergleich -->
                                        <div style="padding: 20px; background: #f8fafc; border-radius: 12px;">
                                            <div style="font-weight: 500; color: #64748b; margin-bottom: 15px;">Gewinnmarge</div>
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                                <span style="color: #3b82f6; font-weight: 500;">Ihr Wert:</span>
                                                <span style="font-size: 1.5rem; font-weight: bold; color: #3b82f6;">${bwaData.margin}%</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                                <span style="color: #64748b;">Branche Ø:</span>
                                                <span id="benchmarkMargin" style="font-size: 1.2rem; font-weight: bold; color: #64748b;">—</span>
                                            </div>
                                    
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                                        <!-- Gewinnmarge Vergleich -->
                                        <div style="padding: 20px; background: var(--color-gray-50); border-radius: 12px;">
                                            <div style="font-weight: 500; color: var(--color-gray-600); margin-bottom: 15px;">Gewinnmarge</div>
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                                <span style="color: var(--color-gray-700); font-weight: 500;">Ihr Wert:</span>
                                                <span style="font-size: 1.5rem; font-weight: 600; color: var(--color-gray-900);">${bwaData.margin}%</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                                <span style="color: var(--color-gray-600);">Branche Ø:</span>
                                                <span id="benchmarkMargin" style="font-size: 1.2rem; font-weight: 600; color: var(--color-gray-700);">—</span>
                                            </div>
                                            <div id="marginStatus" style="text-align: center; padding: 8px; border-radius: 6px; font-size: 0.9rem; font-weight: 500; margin-top: 10px; background: var(--color-gray-100); color: var(--color-gray-700);">—</div>
                                        </div>
                                        
                                        <!-- Personalkosten Vergleich -->
                                        <div style="padding: 20px; background: var(--color-gray-50); border-radius: 12px;">
                                            <div style="font-weight: 500; color: var(--color-gray-600); margin-bottom: 15px;">Personalkosten</div>
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                                <span style="color: var(--color-gray-700); font-weight: 500;">Ihr Wert:</span>
                                                <span style="font-size: 1.5rem; font-weight: 600; color: var(--color-gray-900);">${bwaData.personalCostRatio || 0}%</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                                <span style="color: var(--color-gray-600);">Branche Ø:</span>
                                                <span id="benchmarkPersonal" style="font-size: 1.2rem; font-weight: 600; color: var(--color-gray-700);">—</span>
                                            </div>
                                            <div id="personalStatus" style="text-align: center; padding: 8px; border-radius: 6px; font-size: 0.9rem; font-weight: 500; margin-top: 10px; background: var(--color-gray-100); color: var(--color-gray-700);">—</div>
                                        </div>
                                        
                                        <!-- Fixkostenquote Vergleich -->
                                        <div style="padding: 20px; background: var(--color-gray-50); border-radius: 12px;">
                                            <div style="font-weight: 500; color: var(--color-gray-600); margin-bottom: 15px;">Fixkostenquote</div>
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                                <span style="color: var(--color-gray-700); font-weight: 500;">Ihr Wert:</span>
                                                <span style="font-size: 1.5rem; font-weight: 600; color: var(--color-gray-900);">${(((bwaData.fixedCosts || 0) / bwaData.revenue) * 100).toFixed(0)}%</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                                <span style="color: var(--color-gray-600);">Branche Ø:</span>
                                                <span id="benchmarkFixed" style="font-size: 1.2rem; font-weight: 600; color: var(--color-gray-700);">—</span>
                                            </div>
                                            <div id="fixedStatus" style="text-align: center; padding: 8px; border-radius: 6px; font-size: 0.9rem; font-weight: 500; margin-top: 10px; background: var(--color-gray-100); color: var(--color-gray-700);">—</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Geschäftsentwicklung -->
                            <div class="chart-container" style="margin-top: 30px;">
                                <div style="background: linear-gradient(to right, #f0f9ff, #e0f2fe); padding: 30px; border-radius: 12px; border: 1px solid #bae6fd;">
                                    <h3 style="margin-bottom: 20px; color: #0c4a6e; font-size: 18px; font-weight: 600;">Aktuelle Kennzahlen</h3>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                        <div style="text-align: center; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                            <h4 style="color: #1e40af; font-weight: 600;">Umsatzrentabilität</h4>
                                            <div style="font-size: 2rem; font-weight: 600; color: #0f172a; margin: 10px 0;">${bwaData.margin}%</div>
                                            <p style="color: #64748b; font-size: 0.9rem;">${bwaData.margin > 20 ? 'Sehr gut' : bwaData.margin > 10 ? 'Gut' : 'Verbesserungsbedarf'}</p>
                                        </div>
                                        <div style="text-align: center; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                            <h4 style="color: #1e40af; font-weight: 600;">Kostenquote</h4>
                                            <div style="font-size: 2rem; font-weight: 600; color: #0f172a; margin: 10px 0;">${((bwaData.costs / bwaData.revenue) * 100).toFixed(1)}%</div>
                                            <p style="color: #64748b; font-size: 0.9rem;">Anteil der Kosten am Umsatz</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Trend-Chart erstellen nach DOM-Update
                setTimeout(() => {
                    createTrendChart(historicalData);
                    initializeScenario(bwaData);
                    updateBenchmark();
                }, 100);
            }

            // Scoring Section aktualisieren
            const scoringSection = document.getElementById('scoring-section');
            if (scoringSection) {
                const score = calculateBusinessScore(bwaData);
                scoringSection.innerHTML = `
                    <div class="container">
                        <div class="header">
                            <h1>Scoring</h1>
                            <p>Unternehmens-Bewertung basierend auf ${filename}</p>
                        </div>
                        <div class="content">
                            <div style="text-align: center; margin: 40px 0;">
                                <div style="width: 150px; height: 150px; border-radius: 50%; background: conic-gradient(#3b82f6 0deg ${score * 3.6}deg, #e5e7eb ${score * 3.6}deg 360deg); margin: 0 auto; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.2);">
                                    <div style="width: 120px; height: 120px; border-radius: 50%; background: white; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                                        <div style="font-size: 2.5rem; font-weight: 600; color: #1e40af;">${score}</div>
                                        <div style="font-size: 0.9rem; color: #64748b;">von 100</div>
                                    </div>
                                </div>
                                <h3 style="margin: 20px 0; color: #0f172a; font-weight: 600;">Gesamtbewertung: ${getScoreRating(score)}</h3>
                            </div>
                            
                            <div class="dashboard-grid">
                                <div class="metric-card" style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border: 1px solid #bfdbfe;">
                                    <h4 style="color: #1e40af; margin-bottom: 15px; font-weight: 600;">Rentabilität</h4>
                                    <div style="font-size: 1.5rem; font-weight: 600; color: #0c4a6e;">${bwaData.margin > 15 ? '85' : bwaData.margin > 8 ? '70' : '45'}/100</div>
                                    <p style="color: #475569; margin-top: 10px;">${bwaData.margin}% Gewinnmarge</p>
                                </div>
                                <div class="metric-card" style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border: 1px solid #bfdbfe;">
                                    <h4 style="color: #1e40af; margin-bottom: 15px; font-weight: 600;">Effizienz</h4>
                                    <div style="font-size: 1.5rem; font-weight: 600; color: #0c4a6e;">${bwaData.costs / bwaData.revenue < 0.7 ? '90' : bwaData.costs / bwaData.revenue < 0.8 ? '75' : '60'}/100</div>
                                    <p style="color: #475569; margin-top: 10px;">Kostenmanagement</p>
                                </div>
                                <div class="metric-card" style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border: 1px solid #bfdbfe;">
                                    <h4 style="color: #1e40af; margin-bottom: 15px; font-weight: 600;">Wachstum</h4>
                                    <div style="font-size: 1.5rem; font-weight: 600; color: #0c4a6e;">75/100</div>
                                    <p style="color: #475569; margin-top: 10px;">Potenzial erkannt</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Recommendations Section aktualisieren
            const recommendationsSection = document.getElementById('recommendations-section');
            if (recommendationsSection) {
                const recommendations = generateRecommendations(bwaData);
                
                const priorityColors = {
                    'critical': { bg: '#fee2e2', border: '#dc2626', badge: '#991b1b' },
                    'high': { bg: '#fed7aa', border: '#ea580c', badge: '#c2410c' },
                    'medium': { bg: '#fef3c7', border: '#f59e0b', badge: '#d97706' },
                    'low': { bg: '#d1fae5', border: '#10b981', badge: '#059669' }
                };
                
                const typeColors = {
                    'error': { bg: '#fee2e2', border: '#dc2626' },
                    'warning': { bg: '#fed7aa', border: '#ea580c' },
                    'info': { bg: '#e0f2fe', border: '#0284c7' },
                    'success': { bg: '#d1fae5', border: '#10b981' }
                };
                
                recommendationsSection.innerHTML = `
                    <div class="container">
                        <div class="header">
                            <h1>💡 Handlungsempfehlungen</h1>
                            <p>Detaillierte KI-Analyse und Aktionsplan für ${filename}</p>
                        </div>
                        <div class="content">
                            <div style="background: #f0f9ff; border: 2px solid #0284c7; padding: 20px; border-radius: 12px; margin-bottom: 30px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <div>
                                        <h3 style="color: #0c4a6e; margin-bottom: 10px;">🤖 KI-gestützte Unternehmensanalyse</h3>
                                        <p style="color: #374151;">Basierend auf Ihren BWA-Daten haben wir ${recommendations.length} individuelle Handlungsempfehlungen mit insgesamt ${recommendations.reduce((sum, rec) => sum + (rec.checklist ? rec.checklist.length : 0), 0)} konkreten Maßnahmen erstellt.</p>
                                    </div>
                                    <div style="min-width: 200px; text-align: right;">
                                        <label style="color: #0c4a6e; font-weight: bold; display: block; margin-bottom: 8px;">Filter nach Priorität:</label>
                                        <select id="priorityFilter" onchange="filterRecommendations()" style="padding: 10px 15px; border: 2px solid #0284c7; border-radius: 8px; background: white; color: #0c4a6e; font-weight: 600; cursor: pointer; width: 100%;">
                                            <option value="all">🔍 Alle anzeigen</option>
                                            <option value="critical">🚨 Critical</option>
                                            <option value="high">⚠️ High</option>
                                            <option value="medium">📋 Medium</option>
                                            <option value="low">✅ Low</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="recommendationsContainer">
                            
                            ${recommendations.map((rec, index) => {
                                const colors = typeColors[rec.type] || typeColors.info;
                                const priorityColor = rec.priority ? priorityColors[rec.priority] : null;
                                
                                return `
                                    <div data-priority="${rec.priority || 'medium'}" style="background: white; border: 2px solid ${colors.border}; border-radius: 16px; padding: 30px; margin-bottom: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                                            <h3 style="color: #1a1a2e; font-size: 1.5rem;">${rec.icon} ${rec.title}</h3>
                                            ${priorityColor ? `
                                                <span style="background: ${priorityColor.badge}; color: white; padding: 6px 16px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase;">
                                                    ${rec.priority}
                                                </span>
                                            ` : ''}
                                        </div>
                                        
                                        <div style="background: ${colors.bg}; padding: 20px; border-radius: 12px; border-left: 4px solid ${colors.border}; margin-bottom: 20px;">
                                            <p style="color: #374151; font-size: 1.05rem; line-height: 1.6; margin-bottom: 0;">${rec.description}</p>
                                        </div>
                                        
                                        ${rec.details && rec.details.length > 0 ? `
                                            <div style="margin-bottom: 20px;">
                                                <h4 style="color: #374151; margin-bottom: 12px; font-size: 1.1rem;">📋 Detailanalyse</h4>
                                                <ul style="list-style: none; padding: 0;">
                                                    ${rec.details.map(detail => `
                                                        <li style="padding: 10px 0; padding-left: 25px; border-bottom: 1px solid #e5e7eb; position: relative;">
                                                            <span style="position: absolute; left: 0; color: ${colors.border};">•</span>
                                                            <span style="color: #4b5563;">${detail}</span>
                                                        </li>
                                                    `).join('')}
                                                </ul>
                                            </div>
                                        ` : ''}
                                        
                                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                                            <h4 style="color: white; margin-bottom: 10px; font-size: 1.1rem;">🎯 Empfohlene Maßnahme</h4>
                                            <p style="color: white; margin: 0; font-size: 1rem; line-height: 1.6;">${rec.action}</p>
                                        </div>
                                        
                                        ${rec.checklist && rec.checklist.length > 0 ? `
                                            <div style="background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0;">
                                                <h4 style="color: #1e293b; margin-bottom: 15px; font-size: 1.1rem;">✅ Aktions-Checkliste</h4>
                                                <div style="space-y: 10px;">
                                                    ${rec.checklist.map((item, idx) => `
                                                        <label style="display: flex; align-items: start; padding: 12px; background: white; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; border: 2px solid transparent;" 
                                                               onmouseover="this.style.borderColor='${colors.border}'"
                                                               onmouseout="this.style.borderColor='transparent'">
                                                            <input type="checkbox" 
                                                                   id="check_${index}_${idx}" 
                                                                   onchange="saveChecklistState()"
                                                                   style="margin-right: 12px; margin-top: 4px; width: 18px; height: 18px; cursor: pointer;">
                                                            <span style="color: #374151; flex: 1; line-height: 1.5;">${item.task}</span>
                                                        </label>
                                                    `).join('')}
                                                </div>
                                                <div style="margin-top: 15px; padding: 12px; background: #e0f2fe; border-radius: 8px; text-align: center;">
                                                    <span style="color: #0c4a6e; font-size: 0.9rem;">
                                                        <strong id="progress_${index}">0</strong> von <strong>${rec.checklist.length}</strong> Aufgaben erledigt
                                                    </span>
                                                </div>
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                            </div>
                            
                            <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 30px; border-radius: 16px; text-align: center; color: white; margin-top: 40px;">
                                <h3 style="margin-bottom: 15px;">🚀 Nächste Schritte</h3>
                                <p style="margin-bottom: 20px; opacity: 0.95;">Arbeiten Sie die Checklisten der Priorität nach ab. Bei Fragen stehen wir Ihnen zur Verfügung.</p>
                                <button onclick="printRecommendations()" style="background: white; color: #059669; padding: 12px 24px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-right: 10px;">
                                    📄 Als PDF exportieren
                                </button>
                                <button onclick="alert('E-Mail-Funktion kommt bald!')" style="background: rgba(255,255,255,0.2); color: white; padding: 12px 24px; border: 1px solid white; border-radius: 8px; font-weight: bold; cursor: pointer;">
                                    📧 Per E-Mail senden
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Checklist-Progress aktualisieren
                setTimeout(() => {
                    recommendations.forEach((rec, index) => {
                        if (rec.checklist) {
                            updateChecklistProgress(index, rec.checklist.length);
                        }
                    });
                }, 100);
            }

            // Analytics Section aktualisieren
            const analyticsSection = document.getElementById('analytics-section');
            if (analyticsSection) {
                analyticsSection.innerHTML = `
                    <div class="container">
                        <div class="header">
                            <h1>Analytics</h1>
                            <p>Detaillierte Unternehmensanalyse für ${filename}</p>
                        </div>
                        <div class="content">
                            <!-- Analytics KPI Cards -->
                            <div style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); padding: 30px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 4px 6px -1px rgba(30, 64, 175, 0.1);">
                                <h3 style="color: white; margin-bottom: 20px; font-size: 18px; font-weight: 600;">Schlüsselkennzahlen</h3>
                                <div class="dashboard-grid">
                                    <div class="metric-card" style="background: rgba(255, 255, 255, 0.95); border: none;">
                                        <h4 style="color: #1e40af; margin-bottom: 15px; font-weight: 600;">Umsatzanalyse</h4>
                                        <div style="font-size: 1.8rem; font-weight: 600; color: #0f172a; margin-bottom: 10px;">${bwaData.revenue.toLocaleString()}€</div>
                                        <div style="font-size: 0.9rem; color: #475569;">
                                            <p style="margin: 4px 0;">• Monatsumsatz</p>
                                            <p style="margin: 4px 0;">• ${bwaData.revenue > 100000 ? 'Überdurchschnittlich' : 'Durchschnittlich'}</p>
                                            <p style="margin: 4px 0;">• Trend: ${Math.random() > 0.5 ? 'Steigend ↗' : 'Stabil →'}</p>
                                        </div>
                                    </div>
                                    <div class="metric-card" style="background: rgba(255, 255, 255, 0.95); border: none;">
                                        <h4 style="color: #0ea5e9; margin-bottom: 15px; font-weight: 600;">Kostenstruktur</h4>
                                        <div style="font-size: 1.8rem; font-weight: 600; color: #0f172a; margin-bottom: 10px;">${((bwaData.costs / bwaData.revenue) * 100).toFixed(1)}%</div>
                                        <div style="font-size: 0.9rem; color: #475569;">
                                            <p style="margin: 4px 0;">• Kostenquote</p>
                                            <p style="margin: 4px 0;">• ${bwaData.costs / bwaData.revenue < 0.7 ? 'Effizient' : 'Optimierbar'}</p>
                                            <p style="margin: 4px 0;">• Branchenvgl: ${bwaData.costs / bwaData.revenue < 0.75 ? 'Besser ✓' : 'Durchschnitt'}</p>
                                        </div>
                                    </div>
                                    <div class="metric-card" style="background: rgba(255, 255, 255, 0.95); border: none;">
                                        <h4 style="color: #3b82f6; margin-bottom: 15px; font-weight: 600;">Profitabilität</h4>
                                        <div style="font-size: 1.8rem; font-weight: 600; color: #0f172a; margin-bottom: 10px;">${bwaData.margin}%</div>
                                        <div style="font-size: 0.9rem; color: #475569;">
                                            <p style="margin: 4px 0;">• Gewinnmarge</p>
                                            <p style="margin: 4px 0;">• ${bwaData.margin > 20 ? 'Exzellent' : bwaData.margin > 10 ? 'Gut' : 'Verbesserbar'}</p>
                                            <p style="margin: 4px 0;">• ROI: ${(bwaData.margin * 2).toFixed(1)}%</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Detailanalyse -->
                            <div style="background: linear-gradient(to right, #f0f9ff, #dbeafe); border-radius: 12px; padding: 30px; border: 1px solid #bfdbfe;">
                                <h3 style="margin-bottom: 20px; color: #0c4a6e; font-weight: 600; font-size: 18px;">Detailanalyse</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                                        <h4 style="color: #1e40af; margin-bottom: 15px; font-weight: 600;">Kennzahlen</h4>
                                        <div style="space-y: 10px;">
                                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                                <span style="color: #475569;">Umsatzrendite:</span>
                                                <strong style="color: #0f172a;">${bwaData.margin}%</strong>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                                <span style="color: #475569;">Kostenquote:</span>
                                                <strong style="color: #0f172a;">${((bwaData.costs / bwaData.revenue) * 100).toFixed(1)}%</strong>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                                <span style="color: #475569;">Break-Even:</span>
                                                <strong style="color: #0f172a;">${bwaData.costs.toLocaleString()}€</strong>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                                                <span style="color: #475569;">Liquiditätsreserve:</span>
                                                <strong style="color: #0f172a;">${(bwaData.liquidityMonths || 0).toFixed(1)} Monate</strong>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                                        <h4 style="color: #0ea5e9; margin-bottom: 15px; font-weight: 600;">Benchmarks</h4>
                                        <div style="space-y: 10px;">
                                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                                <span style="color: #475569;">Branchenschnitt:</span>
                                                <strong style="color: #0f172a;">15-25%</strong>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                                <span style="color: #475569;">Ihr Wert:</span>
                                                <strong style="color: ${bwaData.margin > 15 ? '#10b981' : '#f59e0b'};">${bwaData.margin}%</strong>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                                <span style="color: #475569;">Bewertung:</span>
                                                <strong style="color: ${bwaData.margin > 20 ? '#10b981' : bwaData.margin > 10 ? '#f59e0b' : '#ef4444'};">${bwaData.margin > 20 ? 'Sehr gut' : bwaData.margin > 10 ? 'Gut' : 'Verbesserbar'}</strong>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                                                <span style="color: #475569;">Status:</span>
                                                <span style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: ${bwaData.margin > 20 ? '#10b981' : bwaData.margin > 10 ? '#f59e0b' : '#ef4444'};"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function calculateBusinessScore(bwaData) {
            let score = 0;
            
            // Rentabilität (40% des Scores)
            if (bwaData.margin > 20) score += 40;
            else if (bwaData.margin > 15) score += 35;
            else if (bwaData.margin > 10) score += 25;
            else if (bwaData.margin > 5) score += 15;
            else score += 5;
            
            // Effizienz (30% des Scores)
            const costRatio = bwaData.costs / bwaData.revenue;
            if (costRatio < 0.6) score += 30;
            else if (costRatio < 0.7) score += 25;
            else if (costRatio < 0.8) score += 20;
            else if (costRatio < 0.9) score += 10;
            else score += 5;
            
            // Stabilität (30% des Scores) - basierend auf Gewinn
            if (bwaData.profit > 50000) score += 30;
            else if (bwaData.profit > 20000) score += 25;
            else if (bwaData.profit > 10000) score += 20;
            else if (bwaData.profit > 0) score += 15;
            else score += 0;
            
            return Math.min(100, score);
        }

        function getScoreRating(score) {
            if (score >= 90) return 'Exzellent';
            if (score >= 80) return 'Sehr gut';
            if (score >= 70) return 'Gut';
            if (score >= 60) return 'Befriedigend';
            if (score >= 50) return 'Ausreichend';
            return 'Verbesserungsbedarf';
        }

        function generateRecommendations(bwaData) {
            const recommendations = [];
            const costRatio = (bwaData.costs / bwaData.revenue) * 100;
            
            // 1. Rentabilitätsanalyse
            if (bwaData.margin > 25) {
                recommendations.push({
                    type: 'success',
                    icon: '🎉',
                    title: 'Exzellente Rentabilität',
                    description: `Mit ${bwaData.margin}% Gewinnmarge liegen Sie deutlich über dem Branchendurchschnitt von 15-20%. Ihre Kostenstruktur ist hocheffizient und gibt Ihnen einen starken Wettbewerbsvorteil.`,
                    details: [
                        'Ihre Gewinnmarge übertrifft 95% der Unternehmen in Ihrer Größenklasse',
                        'Aktueller Cashflow ermöglicht strategische Investitionen',
                        'Starke Position für Preisverhandlungen mit Lieferanten'
                    ],
                    action: 'Strategische Expansion: Nutzen Sie Ihre starke Liquidität für Wachstumsinvestitionen in neue Märkte oder Produktlinien. Prüfen Sie M&A-Möglichkeiten oder Kapazitätserweiterungen.',
                    priority: 'low',
                    checklist: [
                        { task: 'Investitionsplan für die nächsten 12 Monate erstellen', done: false },
                        { task: 'Wachstumsmärkte und -chancen identifizieren', done: false },
                        { task: 'ROI-Analyse für potenzielle Projekte durchführen', done: false },
                        { task: 'Reserven für Marktschwankungen bilden', done: false }
                    ]
                });
            } else if (bwaData.margin >= 15 && bwaData.margin <= 25) {
                recommendations.push({
                    type: 'info',
                    icon: '✅',
                    title: 'Gesunde Gewinnmarge',
                    description: `Mit ${bwaData.margin}% Gewinnmarge bewegen Sie sich im empfohlenen Bereich. Es besteht dennoch Optimierungspotenzial zu den Top-Performern.`,
                    details: [
                        'Solide Grundlage für nachhaltiges Wachstum',
                        'Puffer für wirtschaftliche Schwankungen vorhanden',
                        'Weitere 5-10% Margenverbesserung realistisch'
                    ],
                    action: 'Margin-Optimierung: Analysieren Sie Ihre größten Kostentreiber. Potenzial besteht oft in Automatisierung, Prozessoptimierung und strategischen Einkaufsverhandlungen.',
                    priority: 'medium',
                    checklist: [
                        { task: 'Top 10 Kostenblöcke identifizieren und priorisieren', done: false },
                        { task: 'Benchmark mit Wettbewerbern durchführen', done: false },
                        { task: 'Quick-Win-Maßnahmen zur Kostensenkung umsetzen', done: false },
                        { task: 'Preiserhöhungspotenziale bei Bestandskunden prüfen', done: false }
                    ]
                });
            } else if (bwaData.margin >= 10 && bwaData.margin < 15) {
                recommendations.push({
                    type: 'warning',
                    icon: '⚠️',
                    title: 'Gewinnmarge unter Zielbereich',
                    description: `Bei ${bwaData.margin}% Gewinnmarge liegen Sie unter dem empfohlenen Minimum von 15%. Dies schränkt Ihre Handlungsfähigkeit bei Marktveränderungen ein.`,
                    details: [
                        'Geringe Pufferreserven bei Umsatzrückgängen',
                        'Eingeschränkter Spielraum für Investitionen',
                        'Gefahr der Unterfinanzierung bei Wachstum',
                        'Erhöhtes Risiko bei Kostensteigerungen'
                    ],
                    action: 'Sofortmaßnahmen erforderlich: Führen Sie eine umfassende Kosten-Nutzen-Analyse durch. Prüfen Sie Preisanpassungen, Produktportfolio-Optimierung und Effizienzsteigerungen in allen Bereichen.',
                    priority: 'high',
                    checklist: [
                        { task: 'Notfallplan für Kostenreduktion erstellen', done: false },
                        { task: 'Alle Produkte/Services auf Profitabilität prüfen', done: false },
                        { task: 'Preisstruktur marktgerecht anpassen', done: false },
                        { task: 'Automatisierungspotenziale identifizieren', done: false },
                        { task: 'Nicht-rentable Geschäftsbereiche evaluieren', done: false }
                    ]
                });
            } else {
                recommendations.push({
                    type: 'error',
                    icon: '🚨',
                    title: 'Kritische Rentabilitätssituation',
                    description: `Mit ${bwaData.margin}% Gewinnmarge befindet sich Ihr Unternehmen in einer kritischen Situation. Sofortmaßnahmen sind dringend erforderlich.`,
                    details: [
                        'Unternehmensfortbestand gefährdet',
                        'Keine Reserven für Krisensituationen',
                        'Investitionen praktisch unmöglich',
                        'Hohe Insolvenzgefahr bei Umsatzeinbruch'
                    ],
                    action: 'Krisenmanagement: Leiten Sie SOFORT ein strukturiertes Sanierungsprogramm ein. Fokus auf Cash-Erhaltung, drastische Kostensenkungen und Neuausrichtung des Geschäftsmodells. Externe Beratung dringend empfohlen.',
                    priority: 'critical',
                    checklist: [
                        { task: 'Liquiditätsplanung für die nächsten 3 Monate', done: false },
                        { task: 'Alle nicht-essentiellen Kosten SOFORT stoppen', done: false },
                        { task: 'Verhandlungen mit Gläubigern/Banken einleiten', done: false },
                        { task: 'Sanierungsberater hinzuziehen', done: false },
                        { task: 'Geschäftsmodell fundamental überprüfen', done: false },
                        { task: 'Personal- und Kapazitätsplanung anpassen', done: false }
                    ]
                });
            }

            // 2. Kostenstruktur-Analyse
            if (costRatio > 85) {
                recommendations.push({
                    type: 'error',
                    icon: '💰',
                    title: 'Alarmierende Kostenbelastung',
                    description: `Kosten machen ${costRatio.toFixed(1)}% des Umsatzes aus. Dies ist nicht nachhaltig und erfordert sofortiges Handeln.`,
                    details: [
                        'Extrem hohe Kostenquote gefährdet Unternehmen',
                        'Praktisch kein Spielraum für Investitionen',
                        'Jede Umsatzschwankung wird existenzbedrohend',
                        'Wettbewerbsfähigkeit stark eingeschränkt'
                    ],
                    action: 'Radikales Kostenmanagement: Implementieren Sie ein Zero-Based-Budget. Jede Ausgabe muss neu gerechtfertigt werden. Prüfen Sie Outsourcing, Automatisierung und Prozessverschlankung.',
                    priority: 'critical',
                    checklist: [
                        { task: 'Alle Verträge und Abonnements auf Kündigungspotenzial prüfen', done: false },
                        { task: 'Personalkosten analysieren und optimieren', done: false },
                        { task: 'Lieferantenverhandlungen mit min. 15% Ziel starten', done: false },
                        { task: 'Raumkosten reduzieren (Untervermietung, Umzug)', done: false },
                        { task: 'IT und Software-Lizenzen konsolidieren', done: false }
                    ]
                });
            } else if (costRatio > 75) {
                recommendations.push({
                    type: 'warning',
                    icon: '📊',
                    title: 'Hohe Kostenquote',
                    description: `Mit ${costRatio.toFixed(1)}% Kostenanteil am Umsatz liegt Ihre Kostenquote über dem Branchendurchschnitt von 70-75%.`,
                    details: [
                        'Eingeschränkte Flexibilität bei Marktschwankungen',
                        'Wettbewerbsnachteil gegenüber effizienteren Konkurrenten',
                        'Limitierter Spielraum für Preisnachlässe'
                    ],
                    action: 'Strukturierte Kostenoptimierung: Erstellen Sie einen 6-Monats-Plan zur Kostenreduktion. Ziel sollte sein, die Kostenquote auf unter 75% zu senken.',
                    priority: 'high',
                    checklist: [
                        { task: 'Kostenanalyse nach Kategorien durchführen', done: false },
                        { task: 'Top 3 Einsparpotenziale identifizieren', done: false },
                        { task: 'Einkaufskonditionen neu verhandeln', done: false },
                        { task: 'Prozesseffizienz in allen Abteilungen prüfen', done: false }
                    ]
                });
            }

            // 3. Umsatz- und Wachstumsanalyse
            if (bwaData.revenue > 200000) {
                recommendations.push({
                    type: 'success',
                    icon: '📈',
                    title: 'Starke Umsatzbasis für Skalierung',
                    description: `Mit €${bwaData.revenue.toLocaleString()} Monatsumsatz haben Sie eine solide Grundlage für profitables Wachstum erreicht.`,
                    details: [
                        'Kritische Masse für Skaleneffekte erreicht',
                        'Marktposition erlaubt strategische Investitionen',
                        'Attraktiv für Investoren und Kooperationspartner',
                        'Potenzial für Marktführerschaft in Nischensegmenten'
                    ],
                    action: 'Skalierungsstrategie: Nutzen Sie Ihre Position für beschleunigtes Wachstum. Prüfen Sie geografische Expansion, neue Vertriebskanäle oder ergänzende Produktlinien.',
                    priority: 'medium',
                    checklist: [
                        { task: 'Marktanalyse für Expansionsmöglichkeiten', done: false },
                        { task: 'Skalierungskosten kalkulieren', done: false },
                        { task: 'Finanzierungsoptionen für Wachstum prüfen', done: false },
                        { task: 'Aufbau von Führungskapazitäten planen', done: false }
                    ]
                });
            } else if (bwaData.revenue >= 100000 && bwaData.revenue <= 200000) {
                recommendations.push({
                    type: 'info',
                    icon: '🎯',
                    title: 'Wachstumsschwelle erreicht',
                    description: `Bei €${bwaData.revenue.toLocaleString()} Monatsumsatz stehen Sie an einer wichtigen Schwelle. Der nächste Schritt ist die Professionalisierung für Skalierung.`,
                    details: [
                        'Grundsolides Geschäftsmodell etabliert',
                        'Bereit für systematisches Wachstum',
                        'Kritischer Punkt für Professionalisierung',
                        'Entscheidung: Weiteres Wachstum oder Konsolidierung'
                    ],
                    action: 'Professionalisierung: Investieren Sie in Strukturen, Prozesse und Systeme. Bereiten Sie Ihr Unternehmen auf die nächste Wachstumsphase vor.',
                    priority: 'medium',
                    checklist: [
                        { task: 'Organisationsstruktur für Wachstum aufbauen', done: false },
                        { task: 'Prozesse dokumentieren und standardisieren', done: false },
                        { task: 'Management-Dashboard implementieren', done: false },
                        { task: '3-Jahres-Wachstumsplan erstellen', done: false }
                    ]
                });
            } else {
                recommendations.push({
                    type: 'info',
                    icon: '🌱',
                    title: 'Aufbauphase: Fundament legen',
                    description: `Mit €${bwaData.revenue.toLocaleString()} Monatsumsatz befinden Sie sich in der Aufbauphase. Fokus sollte auf stabilem Wachstum und solider Basis liegen.`,
                    details: [
                        'Typische Phase für Startup oder Neuausrichtung',
                        'Fokus auf Produktmarkt-Fit wichtig',
                        'Cashflow-Management entscheidend',
                        'Kundenstamm und Reputation aufbauen'
                    ],
                    action: 'Fundament stärken: Konzentrieren Sie sich auf Kundenzufriedenheit, Produktqualität und organisches Wachstum. Vermeiden Sie übermäßige Fixkosten.',
                    priority: 'medium',
                    checklist: [
                        { task: 'Kernkundensegment klar definieren', done: false },
                        { task: 'Vertriebsstrategie optimieren', done: false },
                        { task: 'Kundenfeedback systematisch einholen', done: false },
                        { task: 'Marketing-ROI kontinuierlich messen', done: false }
                    ]
                });
            }

            // 4. Cash-Management & Liquidität
            recommendations.push({
                type: 'info',
                icon: '💵',
                title: 'Liquiditätsmanagement optimieren',
                description: `Bei €${bwaData.profit.toLocaleString()} monatlichem Gewinn sollten Sie ${Math.round(bwaData.profit * 3).toLocaleString()}€ als Liquiditätsreserve aufbauen.`,
                details: [
                    '3 Monatsgehälter als Notreserve empfohlen',
                    'Forderungsmanagement professionalisieren',
                    'Zahlungsziele mit Lieferanten optimieren',
                    'Working Capital kontinuierlich überwachen'
                ],
                action: 'Finanzpuffer aufbauen: Etablieren Sie eine Liquiditätsreserve und optimieren Sie Ihren Cash-Conversion-Cycle.',
                priority: 'medium',
                checklist: [
                    { task: 'Liquiditätsplan für 12 Monate erstellen', done: false },
                    { task: 'Zahlungsbedingungen mit Kunden optimieren', done: false },
                    { task: 'Mahnwesen professionalisieren', done: false },
                    { task: 'Tägliches Cash-Monitoring einrichten', done: false }
                ]
            });

            // 5. Langfristiges Monitoring
            recommendations.push({
                type: 'info',
                icon: '📊',
                title: 'Kontinuierliches Performance-Monitoring',
                description: 'Monatliche BWA-Analysen sind essentiell für rechtzeitiges Gegensteuern und strategische Entscheidungen.',
                details: [
                    'Frühwarnsystem für finanzielle Schieflage',
                    'Basis für datengetriebene Entscheidungen',
                    'Benchmarking mit Vormonaten und Vorjahren',
                    'Transparenz für alle Stakeholder'
                ],
                action: 'Reporting-Routine etablieren: Richten Sie einen monatlichen Management-Review-Prozess mit BWA-Analyse ein.',
                priority: 'low',
                checklist: [
                    { task: 'Monatlichen BWA-Review-Termin festlegen', done: false },
                    { task: 'Dashboard mit Schlüsselkennzahlen erstellen', done: false },
                    { task: 'Ampelsystem für kritische KPIs einführen', done: false },
                    { task: 'Quartalsweise Strategie-Review durchführen', done: false }
                ]
            });
            
            return recommendations;
        }

        function displayHistory() {
            if (uploadHistory.length === 0) {
                historyTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">Noch keine BWAs hochgeladen</td></tr>';
                return;
            }

            historyTableBody.innerHTML = uploadHistory.map(entry => `
                <tr>
                    <td>${entry.filename}</td>
                    <td>${entry.date}</td>
                    <td style="color: #2196F3; font-weight: bold;">${entry.revenue.toLocaleString()}€</td>
                    <td style="color: #ff9800; font-weight: bold;">${entry.costs.toLocaleString()}€</td>
                    <td style="color: ${entry.profit > 0 ? '#4caf50' : '#f44336'}; font-weight: bold;">${entry.profit.toLocaleString()}€</td>
                    <td><span style="color: #64748b;">📊 Generiert</span></td>
                    <td>
                        <button class="btn btn-primary" onclick="showDetails(${entry.timestamp})">Details</button>
                        <button class="btn btn-danger" onclick="deleteEntry(${entry.timestamp})">Löschen</button>
                    </td>
                </tr>
            `).join('');
        }

        function showDetails(timestamp) {
            const entry = uploadHistory.find(e => e.timestamp === timestamp);
            if (!entry) return;
            alert(`BWA Details:\n\nDatei: ${entry.filename}\nUmsatz: ${entry.revenue.toLocaleString()}€\nKosten: ${entry.costs.toLocaleString()}€\nGewinn: ${entry.profit.toLocaleString()}€\nMarge: ${entry.margin}%`);
        }

        function deleteEntry(timestamp) {
            if (confirm('BWA-Upload wirklich löschen?')) {
                uploadHistory = uploadHistory.filter(e => e.timestamp !== timestamp);
                saveHistory();
                displayHistory();
                showNotification('🗑️ Upload gelöscht', 'success');
            }
        }

        function resetToUpload() {
            document.getElementById('uploadSection').style.display = 'block';
            progressContainer.style.display = 'none';
            successContainer.style.display = 'none';
            dashboard.style.display = 'none';
            fileInput.value = '';
        }

        function loadHistory() {
            try {
                const stored = localStorage.getItem('bwa-upload-history');
                if (stored) {
                    uploadHistory = JSON.parse(stored);
                }
            } catch (e) {
                console.error('Fehler beim Laden der Historie:', e);
            }
        }

        function saveHistory() {
            try {
                localStorage.setItem('bwa-upload-history', JSON.stringify(uploadHistory));
            } catch (e) {
                console.error('Fehler beim Speichern der Historie:', e);
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        function saveChecklistState() {
            // Checklist-Status in LocalStorage speichern
            const checkboxes = document.querySelectorAll('input[type="checkbox"][id^="check_"]');
            const states = {};
            
            checkboxes.forEach(checkbox => {
                states[checkbox.id] = checkbox.checked;
                
                // Progress-Counter aktualisieren
                const match = checkbox.id.match(/check_(\d+)_\d+/);
                if (match) {
                    const recIndex = match[1];
                    updateChecklistProgress(recIndex);
                }
            });
            
            localStorage.setItem('bwa-checklist-states', JSON.stringify(states));
        }

        function loadChecklistStates() {
            try {
                const states = JSON.parse(localStorage.getItem('bwa-checklist-states') || '{}');
                Object.entries(states).forEach(([id, checked]) => {
                    const checkbox = document.getElementById(id);
                    if (checkbox) {
                        checkbox.checked = checked;
                    }
                });
            } catch (e) {
                console.error('Fehler beim Laden der Checklist-States:', e);
            }
        }

        function updateChecklistProgress(recIndex, total) {
            const checkboxes = document.querySelectorAll(`input[type="checkbox"][id^="check_${recIndex}_"]`);
            const checked = Array.from(checkboxes).filter(cb => cb.checked).length;
            const progressEl = document.getElementById(`progress_${recIndex}`);
            
            if (progressEl) {
                progressEl.textContent = checked;
                
                // Wenn alle Aufgaben erledigt sind, Konfetti!
                if (total && checked === total && checked > 0) {
                    showNotification('🎉 Alle Aufgaben dieser Empfehlung abgeschlossen!', 'success');
                }
            }
        }

        function printRecommendations() {
            window.print();
        }

        function filterRecommendations() {
            const filter = document.getElementById('priorityFilter');
            if (!filter) return;
            
            const selectedPriority = filter.value;
            const container = document.getElementById('recommendationsContainer');
            if (!container) return;
            
            const allRecommendations = container.querySelectorAll('[data-priority]');
            let visibleCount = 0;
            
            allRecommendations.forEach(rec => {
                const recPriority = rec.getAttribute('data-priority');
                
                if (selectedPriority === 'all' || selectedPriority === recPriority) {
                    rec.style.display = 'block';
                    visibleCount++;
                } else {
                    rec.style.display = 'none';
                }
            });
            
            // Zeige Hinweis wenn keine Empfehlungen gefunden
            let noResultsMsg = document.getElementById('noResultsMessage');
            if (visibleCount === 0) {
                if (!noResultsMsg) {
                    noResultsMsg = document.createElement('div');
                    noResultsMsg.id = 'noResultsMessage';
                    noResultsMsg.style.cssText = 'text-align: center; padding: 40px; color: #666; font-size: 1.1rem; background: #f8fafc; border-radius: 12px; margin: 20px 0;';
                    noResultsMsg.innerHTML = `
                        <div style="font-size: 3rem; margin-bottom: 15px;">🔍</div>
                        <h3>Keine Empfehlungen in dieser Kategorie</h3>
                        <p style="margin-top: 10px; font-size: 0.9rem;">Ändern Sie den Filter, um alle Empfehlungen zu sehen.</p>
                    `;
                    container.appendChild(noResultsMsg);
                }
                noResultsMsg.style.display = 'block';
            } else {
                if (noResultsMsg) {
                    noResultsMsg.style.display = 'none';
                }
            }
            
            // Zeige Statistik
            const priorityLabels = {
                'critical': 'Critical',
                'high': 'High',
                'medium': 'Medium',
                'low': 'Low',
                'all': 'Alle'
            };
            
            showNotification(
                `${visibleCount} Empfehlung${visibleCount !== 1 ? 'en' : ''} gefunden (${priorityLabels[selectedPriority]})`, 
                'info'
            );
        }

        console.log('✅ BWA Upload System mit Sidebar geladen');
    </script>
</body>
</html>